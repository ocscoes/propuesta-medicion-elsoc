# Marco conceptual 

 La conceptualización de la cohesión social se inspira de la acepción de Chan et al. (2006), la cual establece dos dimensiones para la cohesión social: **Vertical** y **Horizontal**. La primera se enfoca en las relaciones entre los ciudadanos (o sociedad civil) y el Estado y sus instituciones, mientras que la segunda aborda las interacciones sociales entre los individuos.  

“La cohesión social es un estado de cosas que concierte tanto a las interacciones verticales como horizontales entre los miembros de la sociedad, caracterizado por un conjunto de actitudes y normas que incluyen la confianza, el sentido de pertenencia y la voluntad de participar y ayudar, así como sus manifestaciones conductuales” (Chan et al., 2006, p. 290).

## Propuesta LAPOP

![](images/hor-lapop.png)

## Propuesta ELSOC

![](images/hor-elsoc.png)
 
# Análisis comparativo

## Diferencias

**1)** Propuesta con ELSOC es mucho más compleja en tanto tiene mayores niveles de granularidad y, consecuentemente, mayor cantidad de factores en comparación con la propuesta de LA, cuya perspectiva es más minimalista. 

Esto se expresa en, por ejemplo, la subdimensión de confianza en instituciones y democracia. En la primera propuesta esta se entiende como una subdimensión compuesta de dos factores: confianza en instituciones y satisfacción con la democracia. No así, en la propuesta construida con LAPOP estos factores se entienden como dos subdimensiones independientes. 

**2)** En la propuesta con ELSOC se consideran varias subdimensiones que no están presentes en el índice de LA debido a decisiones basadas en inconsistencia teórica y/o estadística, tal como el factor de comportamiento prosocial, el cual intentó integrarse en con datos de WVS y, si bien la consistencia interna del factor era aceptable, no correlacionaba con los demás factores de su dimensión. 

**3)** Las propuestas no comparten ningún factor de sus subdimensiones. Si bien ambas integran confianza interpersonal en su medición, ELSOC la considera como un factor de segundo orden, mientras que en la propuesta de LAPOP es un factor de primer orden. 

# Nueva propuesta

Esta sección se presenta la construcción de la nueva propuesta de medición de cohesión social en Chile con datos de ELSOC. 

![](images/propuesta-nueva.png)

En comparación con la anterior propuesta hecha con ELSOC, se elimina la subdimensión de Sentido de pertenencia, puesto que para la construcción de la propuesta con LAPOP se definió que era problemático comprender indicadores como orgullo nacional dentro de la cohesión social. En su lugar, se integra un factor de pertenencia al barrio dentro de la subdimensión de vínculo territoriales. Asimismo, incluye una nueva subdimensión de seguridad (siguiendo la propuesta con LAPOP), considerándose como uno de los elementos centrales durante el último tiempo en las discusiones relacionadas al vínculo social. Por último, se mantiene la subdimensión de redes sociales pero sin el factor de confianza interpersonal puesto que no se pudo encontrar una fiabilidad de su medición con los datos disponibles. 

En la siguiente tabla se presenta la disponibilidad de las variables utilizadas para la construcción del índice de cohesión social. **PASAR AL ANEXO**

```{r}
#| echo: false 

library(readr)
library(DT)

datos <- read_delim("../../input/tables/variables-nueva-propuesta.csv", 
                    delim = ";", 
                    show_col_types = FALSE)
datatable(datos)
```

A continuación, se presentan los descriptivos de los constructos presentados en la propuesta:

```{r}
#| label: packages
#| echo: false

pacman::p_load(
  dplyr, haven, sjlabelled,  psych,  purrr,  tidyr,  sjPlot,  ggplot2, 
  parameters,  table1,  car,  beeswarm, scales, ggrepel, corrplot,
  ggtext, patchwork, psych, kableExtra, labelled, patchwork)
```

```{r}
#| label: database ola 1
#| echo: false 

elsoc_1 <- readRDS("../../input/data/proc_data/elsoc_2016_coh_mig.RData")
```

```{r}
#| label: database ola 2
#| echo: false 

elsoc_2 <- readRDS("../../input/data/proc_data/elsoc_2017_coh_mig.RData")
```

```{r}
#| label: database ola 3 
#| echo: false 

elsoc_3 <- readRDS("../../input/data/proc_data/elsoc_2018_coh_mig.RData")
```

```{r}
#| label: database ola 4
#| echo: false 

elsoc_4 <- readRDS("../../input/data/proc_data/elsoc_2019_coh_mig.RData")
```

```{r}
#| label: database ola 6
#| echo: false 

elsoc_6 <- readRDS("../../input/data/proc_data/elsoc_2022_mig.RData")
```

```{r}
#| label: database ola 5 
#| echo: false 

elsoc_5 <- readRDS("../../input/data/proc_data/elsoc_2021_mig.RData")
```

```{r}
#| label: data-full
#| echo: false

# Agregar la variable ola a cada base
elsoc_1 <- elsoc_1 %>% mutate(ola = 1)
elsoc_2 <- elsoc_2 %>% mutate(ola = 2)
elsoc_3 <- elsoc_3 %>% mutate(ola = 3)
elsoc_4 <- elsoc_4 %>% mutate(ola = 4)
elsoc_4 <- elsoc_4 %>% mutate(ola = 4)
elsoc_5 <- elsoc_5 %>% mutate(ola = 5)
elsoc_6 <- elsoc_6 %>% mutate(ola = 6)

# Unir todas las olas en una sola base
elsoc_long <- bind_rows(elsoc_1, elsoc_2, elsoc_3, elsoc_4, elsoc_5, elsoc_6)
```

```{r}
#| label: comportamiento prosocial dummy
elsoc_5_graph <- elsoc_5 %>%
  mutate(
    # Índice promediado
    comportamiento_prosocial = rowMeans(
      select(., reunion_pub, voluntariado),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    comportamiento_prosocial = case_when(
      comportamiento_prosocial <= 1.5 ~ 0,
      comportamiento_prosocial >= 2   ~ 1
    ),
    
    # Convertir a factor con labels
    comportamiento_prosocial = factor(
      comportamiento_prosocial,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )

```

```{r}
#| label: ayuda economica dummy
elsoc_5_graph <- elsoc_5_graph %>%
  mutate(
    # Índice promediado
    ayuda_economica = rowMeans(
      select(., prestar_dinero, ayuda_trabajo),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    ayuda_economica = case_when(
      ayuda_economica <= 1.5 ~ 0,
      ayuda_economica >= 2   ~ 1
    ),
    
    # Convertir a factor con labels
    ayuda_economica = factor(
      ayuda_economica,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: confianza interpersonal dummy
elsoc_5_graph <- elsoc_5_graph %>%
  mutate(
    # Índice promediado
    confianza_inter = rowMeans(
      select(., confianza_gen, altruismo_gen),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    confianza_inter = case_when(
      confianza_inter <= 1.5 ~ 0,
      confianza_inter >= 2   ~ 1
    ),
    
    # Convertir a factor con labels
    confianza_inter = factor(
      confianza_inter,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
elsoc_5_graph <- elsoc_5_graph %>%
  mutate(
    comportamiento_prosocial = set_label(comportamiento_prosocial, "Comportamiento prosocial"),
    ayuda_economica          = set_label(ayuda_economica, "Ayuda económica"),
    confianza_inter          = set_label(confianza_inter, "Confianza interpersonal")
  )
```

```{r}
#| label: seguridad subjetiva dummy

elsoc_6_graph <- elsoc_6 %>%
  mutate(
    # Índice promediado
    seguridad_sub = rowMeans(
      select(., seguridad_sat, seguridad_perc),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    seguridad_sub = case_when(
      seguridad_sub <= 2.5 ~ 0,
      seguridad_sub >= 3   ~ 1
    ),
    
    # Convertir a factor con labels
    seguridad_sub = factor(
      seguridad_sub,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: seguridad objetiva dummy

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(
    # Índice promediado
    seguridad_obj = rowMeans(
      select(., peleas_calle, asaltos, trafico_drogas),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    seguridad_obj = case_when(
      seguridad_obj <= 2.5 ~ 0,
      seguridad_obj >= 3   ~ 1
    ),
    
    # Convertir a factor con labels
    seguridad_obj = factor(
      seguridad_obj,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: sentido de pertenencia dummy

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(
    # Índice promediado
    sentido_pertenencia = rowMeans(
      select(., barrio_ideal, barrio_integracion, barrio_identidad, barrio_pertenencia),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    sentido_pertenencia = case_when(
      sentido_pertenencia <= 2.5 ~ 0,
      sentido_pertenencia >= 3   ~ 1
    ),
    
    # Convertir a factor con labels
    sentido_pertenencia = factor(
      sentido_pertenencia,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: satisfacción con el barrio dummy

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(
    # Índice promediado
    satisfaccion_barrio = rowMeans(
      select(., barrio_amigos, barrio_sociable, barrio_cordial, barrio_colaborador),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    satisfaccion_barrio = case_when(
      satisfaccion_barrio <= 2.5 ~ 0,
      satisfaccion_barrio >= 3   ~ 1
    ),
    
    # Convertir a factor con labels
    satisfaccion_barrio = factor(
      satisfaccion_barrio,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```


```{r}
#| label: fig-redes
#| fig-cap: Likerplot de índices de redes sociales
#| echo: false 

cohesion_1 <- plot_stackfrq(
  dplyr::select(elsoc_5_graph, comportamiento_prosocial, ayuda_economica, confianza_inter),
  title = "Likerplots de índices de redes sociales"
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 18),
        title = element_text(size = 20),  # ajusta a tu gusto
        legend.text = element_text(size = 16)
        ) +
        scale_fill_manual(
        values = c("Bajo" = "#f9913d", "Alto" = "#2b2f3c")
        )

cohesion_1
```


```{r}
#| label: fig-seguridad
#| fig-cap: Likerplot de índices de seguridad
#| echo: false 

cohesion_2 <- plot_stackfrq(
  dplyr::select(elsoc_6_graph, seguridad_sub, seguridad_obj),
  title = "Likerplots de índices de seguridad"
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 18),
        title = element_text(size = 20),  # ajusta a tu gusto
        legend.text = element_text(size = 16)
        ) +
        scale_fill_manual(
        values = c("Bajo" = "#f9913d", "Alto" = "#2b2f3c")
        )

cohesion_2
```


```{r}
#| label: fig-vinculos
#| fig-cap: Likerplot de índices de vínculos territoriales
#| echo: false 

cohesion_3 <- plot_stackfrq(
  dplyr::select(elsoc_6_graph, sentido_pertenencia, satisfaccion_barrio),
  title = "Likerplots de índices de vínculos territoriales"
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 18),
        title = element_text(size = 20),  # ajusta a tu gusto
        legend.text = element_text(size = 16)
        ) +
        scale_fill_manual(
        values = c("Bajo" = "#f9913d", "Alto" = "#2b2f3c")
        )

cohesion_3
```

```{r}
#| label: comportamiento prosocial dummy 2

elsoc_long_graph <- elsoc_long %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    comportamiento_prosocial = rowMeans(
      cbind(reunion_pub, voluntariado),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    comportamiento_prosocial = case_when(
      comportamiento_prosocial <= 1.5 ~ 0,
      comportamiento_prosocial >= 2   ~ 1,
      TRUE ~ NA_real_  # Para valores entre 1.5 y 2
    ),
    
    # Convertir a factor con labels
    comportamiento_prosocial = factor(
      comportamiento_prosocial,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: ayuda economica dummy 2
elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    ayuda_economica = rowMeans(
      cbind(prestar_dinero, ayuda_trabajo),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    ayuda_economica = case_when(
      ayuda_economica <= 1.5 ~ 0,
      ayuda_economica >= 2   ~ 1,
      TRUE ~ NA_real_  # Para valores entre 1.5 y 2
    ),
    
    # Convertir a factor con labels
    ayuda_economica = factor(
      ayuda_economica,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: confianza interpersonal dummy 2
elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    confianza_inter = rowMeans(
      cbind(confianza_gen, altruismo_gen),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    confianza_inter = case_when(
      confianza_inter <= 1.5 ~ 0,
      confianza_inter >= 2   ~ 1,
      TRUE ~ NA_real_  # Para valores entre 1.5 y 2
    ),
    
    # Convertir a factor con labels
    confianza_inter = factor(
      confianza_inter,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: redes dummy 2

elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    comportamiento_prosocial = set_label(comportamiento_prosocial, "Comportamiento prosocial"),
    ayuda_economica          = set_label(ayuda_economica, "Ayuda económica"),
    confianza_inter          = set_label(confianza_inter, "Confianza interpersonal")
  )
```

```{r}
#| label: seguridad subjetiva dummy 2

elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    seguridad_sub = rowMeans(
      cbind(seguridad_sat, seguridad_perc),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    seguridad_sub = case_when(
      seguridad_sub <= 2.5 ~ 0,
      seguridad_sub >= 3   ~ 1,
      TRUE ~ NA_real_  # Para valores entre 2.5 y 3
    ),
    
    # Convertir a factor con labels
    seguridad_sub = factor(
      seguridad_sub,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r} 
#| label: seguridad objetiva dummy 2

elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    seguridad_obj = rowMeans(
      cbind(peleas_calle, asaltos, trafico_drogas),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    seguridad_obj = case_when(
      seguridad_obj <= 2.5 ~ 0,
      seguridad_obj >= 3   ~ 1,
      TRUE ~ NA_real_  # Para valores entre 2.5 y 3
    ),
    
    # Convertir a factor con labels
    seguridad_obj = factor(
      seguridad_obj,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: sentido de pertenencia dummy 2

elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    sentido_pertenencia = rowMeans(
      cbind(barrio_ideal, barrio_integracion, barrio_identidad, barrio_pertenencia),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    sentido_pertenencia = case_when(
      sentido_pertenencia <= 2.5 ~ 0,
      sentido_pertenencia >= 3   ~ 1,
      TRUE ~ NA_real_  # Para valores entre 2.5 y 3
    ),
    
    # Convertir a factor con labels
    sentido_pertenencia = factor(
      sentido_pertenencia,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: satisfacción con el barrio dummy 2

elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    satisfaccion_barrio = rowMeans(
      cbind(barrio_amigos, barrio_sociable, barrio_cordial, barrio_colaborador),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    satisfaccion_barrio = case_when(
      satisfaccion_barrio <= 2.5 ~ 0,
      satisfaccion_barrio >= 3   ~ 1,
      TRUE ~ NA_real_  # Para valores entre 2.5 y 3
    ),
    
    # Convertir a factor con labels
    satisfaccion_barrio = factor(
      satisfaccion_barrio,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: fig-long-1
#| fig-cap: "Tendencia de variables sobre Comportamiento Prosocial ELSOC"
#| warning: false
#| message: false
#| echo: false

# 1. COMPORTAMIENTO PROSOCIAL
# Variables a graficar
vars_prosocial <- c("reunion_pub", "voluntariado")
# Calcular promedios por ola
long_prosocial <- elsoc_long %>%
  select(ola, all_of(vars_prosocial)) %>%
  pivot_longer(cols = all_of(vars_prosocial), 
               names_to = "variable", 
               values_to = "valor") %>%
  group_by(ola, variable) %>%
  summarise(promedio = mean(valor, na.rm = TRUE), .groups = "drop")

# Nombres legibles
nombres_prosocial <- c(
  "reunion_pub" = "Participación en reuniones públicas",
  "voluntariado" = "Trabajo voluntario"
)

# Completar olas
olas_completas <- tibble(ola = 1:6)
long_prosocial <- long_prosocial %>%
  right_join(olas_completas, by = "ola") %>%
  arrange(variable, ola)

# Gráfico
ggplot(long_prosocial, aes(x = ola, y = promedio, color = variable, group = variable, shape = variable)) +
  geom_line(linewidth = 1.2, na.rm = FALSE) +
  geom_point(size = 3, na.rm = FALSE) +
  scale_color_manual(values = c(
    "reunion_pub" = "#1b9e77",
    "voluntariado" = "#d95f02"
  ), labels = nombres_prosocial) +
  scale_shape_manual(values = c(
    "reunion_pub" = 16, 
    "voluntariado" = 17
  ), labels = nombres_prosocial) +
  scale_x_continuous(breaks = 1:6) + 
  scale_y_continuous(limits = c(1, 5), breaks = 1:5) +
  labs(title = "Tendencia de Comportamiento Prosocial (ELSOC 2016-2021)",
       x = "Ola", y = "Promedio", color = "Variable", shape = "Variable") +
  theme_minimal()
```

```{r}
#| label: fig-long-2
#| fig-cap: "Tendencia de variables sobre Ayuda Económica ELSOC"

# 2. AYUDA ECONÓMICA
vars_ayuda <- c("prestar_dinero", "ayuda_trabajo")
long_ayuda <- elsoc_long %>%
  select(ola, all_of(vars_ayuda)) %>%
  pivot_longer(cols = all_of(vars_ayuda), 
               names_to = "variable", 
               values_to = "valor") %>%
  group_by(ola, variable) %>%
  summarise(promedio = mean(valor, na.rm = TRUE), .groups = "drop")

nombres_ayuda <- c(
  "prestar_dinero" = "Prestar dinero a conocidos",
  "ayuda_trabajo" = "Ayudar a conseguir trabajo"
)

long_ayuda <- long_ayuda %>%
  right_join(olas_completas, by = "ola") %>%
  arrange(variable, ola)

ggplot(long_ayuda, aes(x = ola, y = promedio, color = variable, group = variable, shape = variable)) +
  geom_line(linewidth = 1.2, na.rm = FALSE) +
  geom_point(size = 3, na.rm = FALSE) +
  scale_color_manual(values = c(
    "prestar_dinero" = "#1b9e77",
    "ayuda_trabajo" = "#d95f02"
  ), labels = nombres_ayuda) +
  scale_shape_manual(values = c(
    "prestar_dinero" = 16, 
    "ayuda_trabajo" = 17
  ), labels = nombres_ayuda) +
  scale_x_continuous(breaks = 1:6) + 
  scale_y_continuous(limits = c(1, 5), breaks = 1:5) +
  labs(title = "Tendencia de Ayuda Económica (ELSOC 2016-2021)",
       x = "Ola", y = "Promedio", color = "Variable", shape = "Variable") +
  theme_minimal()
```

```{r}
#| label: fig-long-4
#| fig-cap: "Tendencia de variables sobre Confianza Interpersonal"
#| echo: false
#| warning: false
#| message: false


# 3. CONFIANZA INTERPERSONAL
vars_confianza <- c("confianza_gen", "altruismo_gen")
long_confianza <- elsoc_long %>%
  select(ola, all_of(vars_confianza)) %>%
  pivot_longer(cols = all_of(vars_confianza), 
               names_to = "variable", 
               values_to = "valor") %>%
  group_by(ola, variable) %>%
  summarise(promedio = mean(valor, na.rm = TRUE), .groups = "drop")

nombres_confianza <- c(
  "confianza_gen" = "Confianza generalizada",
  "altruismo_gen" = "Altruismo generalizado"
)

long_confianza <- long_confianza %>%
  right_join(olas_completas, by = "ola") %>%
  arrange(variable, ola)

ggplot(long_confianza, aes(x = ola, y = promedio, color = variable, group = variable, shape = variable)) +
  geom_line(linewidth = 1.2, na.rm = FALSE) +
  geom_point(size = 3, na.rm = FALSE) +
  scale_color_manual(values = c(
    "confianza_gen" = "#1b9e77",
    "altruismo_gen" = "#d95f02"
  ), labels = nombres_confianza) +
  scale_shape_manual(values = c(
    "confianza_gen" = 16, 
    "altruismo_gen" = 17
  ), labels = nombres_confianza) +
  scale_x_continuous(breaks = 1:6) + 
  scale_y_continuous(limits = c(1, 5), breaks = 1:5) +
  labs(title = "Tendencia de Confianza Interpersonal (ELSOC 2016-2021)",
       x = "Ola", y = "Promedio", color = "Variable", shape = "Variable") +
  theme_minimal()
```

```{r}
#| label: fig-long-5
#| fig-cap: "Tendencia de variables sobre Seguridad Sujetiva"
#| echo: false 
#| warning: false

# 4. SEGURIDAD SUBJETIVA
vars_seg_sub <- c("seguridad_sat", "seguridad_perc")

long_seg_sub <- elsoc_long %>%
  select(ola, all_of(vars_seg_sub)) %>%
  pivot_longer(cols = all_of(vars_seg_sub), 
               names_to = "variable", 
               values_to = "valor") %>%
  group_by(ola, variable) %>%
  summarise(promedio = mean(valor, na.rm = TRUE), .groups = "drop") %>%
  # Filtrar solo los casos donde hay datos disponibles (no NA)
  filter(!is.na(promedio))

nombres_seg_sub <- c(
  "seguridad_sat" = "Satisfacción con seguridad",
  "seguridad_perc" = "Percepción de seguridad"
)

# Crear el gráfico sin usar right_join con olas_completas
ggplot(long_seg_sub, aes(x = ola, y = promedio, color = variable, group = variable, shape = variable)) +
  geom_line(linewidth = 1.2, na.rm = TRUE) +  # na.rm = TRUE para conectar puntos disponibles
  geom_point(size = 3, na.rm = TRUE) +        # na.rm = TRUE para mostrar solo puntos disponibles
  scale_color_manual(values = c(
    "seguridad_sat" = "#1b9e77",
    "seguridad_perc" = "#d95f02"
  ), labels = nombres_seg_sub) +
  scale_shape_manual(values = c(
    "seguridad_sat" = 16, 
    "seguridad_perc" = 17
  ), labels = nombres_seg_sub) +
  scale_x_continuous(breaks = 1:6) + 
  scale_y_continuous(limits = c(1, 5), breaks = 1:5) +
  labs(title = "Tendencia de Seguridad Subjetiva (ELSOC 2016-2021)",
       x = "Ola", y = "Promedio", color = "Variable", shape = "Variable") +
  theme_minimal()


```

```{r}
#| label: fig-long-6
#| fig-cap: "Tendencia de variables sobre Seguridad Objetiva"
#| warning: false
#| echo: false

# 5. SEGURIDAD OBJETIVA
vars_seg_obj <- c("peleas_calle", "asaltos", "trafico_drogas")

long_seg_obj <- elsoc_long %>%
  select(ola, all_of(vars_seg_obj)) %>%
  pivot_longer(cols = all_of(vars_seg_obj), 
               names_to = "variable", 
               values_to = "valor") %>%
  group_by(ola, variable) %>%
  summarise(promedio = mean(valor, na.rm = TRUE), .groups = "drop") %>%
  # Filtrar solo los casos donde hay datos disponibles (no NA)
  filter(!is.na(promedio))

nombres_seg_obj <- c(
  "peleas_calle" = "Peleas callejeras",
  "asaltos" = "Asaltos y robos",
  "trafico_drogas" = "Tráfico de drogas"
)

# Crear el gráfico sin usar right_join con olas_completas
ggplot(long_seg_obj, aes(x = ola, y = promedio, color = variable, group = variable, shape = variable)) +
  geom_line(linewidth = 1.2, na.rm = TRUE) +  # na.rm = TRUE para conectar puntos disponibles
  geom_point(size = 3, na.rm = TRUE) +        # na.rm = TRUE para mostrar solo puntos disponibles
  scale_color_manual(values = c(
    "peleas_calle" = "#1b9e77",
    "asaltos" = "#d95f02",
    "trafico_drogas" = "#7570b3"
  ), labels = nombres_seg_obj) +
  scale_shape_manual(values = c(
    "peleas_calle" = 16, 
    "asaltos" = 17,
    "trafico_drogas" = 15
  ), labels = nombres_seg_obj) +
  scale_x_continuous(breaks = 1:6) + 
  scale_y_continuous(limits = c(1, 5), breaks = 1:5) +
  labs(title = "Tendencia de Seguridad Objetiva (ELSOC 2016-2021)",
       x = "Ola", y = "Promedio", color = "Variable", shape = "Variable") +
  theme_minimal()

```

```{r}
#| label: fig-long-7
#| fig-cap: "Tendencia de variables sobre Satifacción con el Barrio"

# 6. SENTIDO DE PERTENENCIA
vars_pertenencia <- c("barrio_ideal", "barrio_integracion", "barrio_identidad", "barrio_pertenencia")

long_pertenencia <- elsoc_long %>%
  select(ola, all_of(vars_pertenencia)) %>%
  pivot_longer(cols = all_of(vars_pertenencia), 
               names_to = "variable", 
               values_to = "valor") %>%
  group_by(ola, variable) %>%
  summarise(promedio = mean(valor, na.rm = TRUE), .groups = "drop") %>%
  # Filtrar solo los casos donde hay datos disponibles (no NA)
  filter(!is.na(promedio))

nombres_pertenencia <- c(
  "barrio_ideal" = "Barrio ideal para vivir",
  "barrio_integracion" = "Integración en el barrio",
  "barrio_identidad" = "Identidad con el barrio",
  "barrio_pertenencia" = "Sentido de pertenencia"
)

# Crear el gráfico sin usar right_join con olas_completas
ggplot(long_pertenencia, aes(x = ola, y = promedio, color = variable, group = variable, shape = variable)) +
  geom_line(linewidth = 1.2, na.rm = TRUE) +  # na.rm = TRUE para conectar puntos disponibles
  geom_point(size = 3, na.rm = TRUE) +        # na.rm = TRUE para mostrar solo puntos disponibles
  scale_color_manual(values = c(
    "barrio_ideal" = "#1b9e77",
    "barrio_integracion" = "#d95f02",
    "barrio_identidad" = "#7570b3",
    "barrio_pertenencia" = "#e7298a"
  ), labels = nombres_pertenencia) +
  scale_shape_manual(values = c(
    "barrio_ideal" = 16, 
    "barrio_integracion" = 17,
    "barrio_identidad" = 15,
    "barrio_pertenencia" = 18
  ), labels = nombres_pertenencia) +
  scale_x_continuous(breaks = 1:6) + 
  scale_y_continuous(limits = c(1, 5), breaks = 1:5) +
  labs(title = "Tendencia de Sentido de Pertenencia (ELSOC 2016-2021)",
       x = "Ola", y = "Promedio", color = "Variable", shape = "Variable") +
  theme_minimal()

```

```{r}
#| label: fig-long-8
#| fig-cap: "Tendencia en índices de seguridad"

# Variables de seguridad (índices categóricos)
vars_seguridad <- c("seguridad_sub", "seguridad_obj")

# OPCIÓN 1: Líneas separadas para Alto y Bajo
long_seguridad_completo <- elsoc_long_graph %>%
  select(ola, all_of(vars_seguridad)) %>%
  pivot_longer(cols = all_of(vars_seguridad), 
               names_to = "variable", 
               values_to = "valor") %>%
  filter(!is.na(valor)) %>%
  group_by(ola, variable, valor) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(ola, variable) %>%
  mutate(
    total = sum(n),
    proporcion = n / total
  ) %>%
  ungroup() %>%
  # Crear variable combinada para el gráfico
  mutate(
    variable_nivel = paste(variable, valor, sep = "_"),
    variable_clean = case_when(
      variable == "seguridad_sub" ~ "Seguridad Subjetiva",
      variable == "seguridad_obj" ~ "Seguridad Objetiva"
    )
  )

nombres_completos <- c(
  "seguridad_sub_Alto" = "Seg. Subjetiva - Alto",
  "seguridad_sub_Bajo" = "Seg. Subjetiva - Bajo", 
  "seguridad_obj_Alto" = "Seg. Objetiva - Alto",
  "seguridad_obj_Bajo" = "Seg. Objetiva - Bajo"
)

# Gráfico con líneas separadas para Alto y Bajo
ggplot(long_seguridad_completo, aes(x = ola, y = proporcion, 
                                   color = variable_nivel, 
                                   linetype = valor,
                                   shape = valor,
                                   group = variable_nivel)) +
  geom_line(linewidth = 1.2, na.rm = TRUE) +
  geom_point(size = 3, na.rm = TRUE) +
  scale_color_manual(values = c(
    "seguridad_sub_Alto" = "#1b9e77",
    "seguridad_sub_Bajo" = "#1b9e77", 
    "seguridad_obj_Alto" = "#d95f02",
    "seguridad_obj_Bajo" = "#d95f02"
  ), labels = nombres_completos) +
  scale_linetype_manual(values = c(
    "Alto" = "solid",
    "Bajo" = "dashed"
  )) +
  scale_shape_manual(values = c(
    "Alto" = 16,
    "Bajo" = 1  # Círculo vacío
  )) +
  scale_x_continuous(breaks = 1:6) + 
  scale_y_continuous(
    limits = c(0, 1), 
    breaks = seq(0, 1, 0.2),
    labels = scales::percent_format(accuracy = 1)
  ) +
  labs(title = "Tendencia en índice de seguridad: Niveles Alto y Bajo (ELSOC 2016-2021)",
       subtitle = "Líneas sólidas = Alto, Líneas punteadas = Bajo",
       x = "Ola", 
       y = "Proporción", 
       color = "Variable y Nivel",
       linetype = "Nivel",
       shape = "Nivel") +
  theme_minimal() +
  guides(
    color = guide_legend(override.aes = list(linetype = c("solid", "dashed", "solid", "dashed"))),
    linetype = guide_legend(title = "Nivel"),
    shape = guide_legend(title = "Nivel")
  )

```


```{r}
#| label: fig-long-9
#| fig-cap: "Tendencia índices de Seguridad"

# Variables de seguridad (índices categóricos)
vars_seguridad <- c("seguridad_sub", "seguridad_obj")

# Preparar datos para gráfico apilado
long_seguridad_stack <- elsoc_long_graph %>%
  select(ola, all_of(vars_seguridad)) %>%
  pivot_longer(cols = all_of(vars_seguridad), 
               names_to = "variable", 
               values_to = "valor") %>%
  filter(!is.na(valor)) %>%
  group_by(ola, variable, valor) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(ola, variable) %>%
  mutate(
    total = sum(n),
    proporcion = n / total
  ) %>%
  ungroup() %>%
  mutate(
    variable_clean = case_when(
      variable == "seguridad_sub" ~ "Seguridad Subjetiva",
      variable == "seguridad_obj" ~ "Seguridad Objetiva"
    )
  )

# Gráfico de área apilada
ggplot(long_seguridad_stack, aes(x = ola, y = proporcion, fill = valor)) +
  geom_area(alpha = 0.7, position = "stack") +
  geom_line(aes(group = interaction(variable, valor)), 
            position = "stack", 
            linewidth = 0.5, 
            color = "white") +
  facet_wrap(~variable_clean, ncol = 2) +
  scale_fill_manual(values = c(
    "Alto" = "#2d7016",  # Verde oscuro
    "Bajo" = "#ff6b35"   # Naranja/rojo
  )) +
  scale_x_continuous(breaks = 1:6) + 
  scale_y_continuous(
    limits = c(0, 1), 
    breaks = seq(0, 1, 0.2),
    labels = scales::percent_format(accuracy = 1)
  ) +
  labs(title = "Distribución de niveles de seguridad por ola (ELSOC 2016-2023)",
       subtitle = "Proporción de casos Alto vs Bajo en cada dimensión",
       x = "Ola", 
       y = "Proporción", 
       fill = "Nivel") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    legend.position = "bottom"
  )

```

```{r}

#| label: fig-long-10
#| fig-cap: "Tendencia índices de Redes"

# Variables de seguridad (índices categóricos)
vars_redes <- c("comportamiento_prosocial", "ayuda_economica", "confianza_inter")

# Preparar datos para gráfico apilado
long_redes_stack <- elsoc_long_graph %>%
  select(ola, all_of(vars_redes)) %>%
  pivot_longer(cols = all_of(vars_redes), 
               names_to = "variable", 
               values_to = "valor") %>%
  filter(!is.na(valor)) %>%
  group_by(ola, variable, valor) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(ola, variable) %>%
  mutate(
    total = sum(n),
    proporcion = n / total
  ) %>%
  ungroup() %>%
  mutate(
    variable_clean = case_when(
      variable == "comportamiento_prosocial" ~ "Comportamiento Prosocial",
      variable == "ayuda_economica" ~ "Ayuda Económica",
      variable == "confianza_inter" ~ "Confianza Interpersonal"
    )
  )

# Gráfico de área apilada
ggplot(long_redes_stack, aes(x = ola, y = proporcion, fill = valor)) +
  geom_area(alpha = 0.7, position = "stack") +
  geom_line(aes(group = interaction(variable, valor)), 
            position = "stack", 
            linewidth = 0.5, 
            color = "white") +
  facet_wrap(~variable_clean, ncol = 2) +
  scale_fill_manual(values = c(
    "Alto" = "#2d7016",  # Verde oscuro
    "Bajo" = "#ff6b35"   # Naranja/rojo
  )) +
  scale_x_continuous(breaks = 1:6) + 
  scale_y_continuous(
    limits = c(0, 1), 
    breaks = seq(0, 1, 0.2),
    labels = scales::percent_format(accuracy = 1)
  ) +
  labs(title = "Distribución de índices de redes por ola (ELSOC 2016-2023)",
       subtitle = "Proporción de casos Alto vs Bajo en cada dimensión",
       x = "Ola", 
       y = "Proporción", 
       fill = "Nivel") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    legend.position = "bottom"
  )
```

```{r}
#| label: fig-long-10
#| fig-cap: "Tendencia índices de Vínculos Territoriales"
#| echo: false
#| warning: false

# Variables de seguridad (índices categóricos)
vars_territorio <- c("sentido_pertenencia", "satisfaccion_barrio")

# Preparar datos para gráfico apilado
long_territorio_stack <- elsoc_long_graph %>%
  select(ola, all_of(vars_territorio)) %>%
  pivot_longer(cols = all_of(vars_territorio), 
               names_to = "variable", 
               values_to = "valor") %>%
  filter(!is.na(valor)) %>%
  group_by(ola, variable, valor) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(ola, variable) %>%
  mutate(
    total = sum(n),
    proporcion = n / total
  ) %>%
  ungroup() %>%
  mutate(
    variable_clean = case_when(
      variable == "sentido_pertenencia" ~ "Sentido de Pertenencia",
      variable == "satisfaccion_barrio" ~ "Satisfacción con el Barrio"
    )
  )

# Gráfico de área apilada
ggplot(long_territorio_stack, aes(x = ola, y = proporcion, fill = valor)) +
  geom_area(alpha = 0.7, position = "stack") +
  geom_line(aes(group = interaction(variable, valor)), 
            position = "stack", 
            linewidth = 0.5, 
            color = "white") +
  facet_wrap(~variable_clean, ncol = 2) +
  scale_fill_manual(values = c(
    "Alto" = "#2d7016",  # Verde oscuro
    "Bajo" = "#ff6b35"   # Naranja/rojo
  )) +
  scale_x_continuous(breaks = 1:6) + 
  scale_y_continuous(
    limits = c(0, 1), 
    breaks = seq(0, 1, 0.2),
    labels = scales::percent_format(accuracy = 1)
  ) +
  labs(title = "Distribución de índices de Vínculos Territoriales por ola (ELSOC 2016-2023)",
       subtitle = "Proporción de casos Alto vs Bajo en cada dimensión",
       x = "Ola", 
       y = "Proporción", 
       fill = "Nivel") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    legend.position = "bottom"
  )
```

