# Marco conceptual 

 La conceptualización de la cohesión social se inspira de la acepción de Chan et al. (2006), la cual establece dos dimensiones para la cohesión social: **Vertical** y **Horizontal**. La primera se enfoca en las relaciones entre los ciudadanos (o sociedad civil) y el Estado y sus instituciones, mientras que la segunda aborda las interacciones sociales entre los individuos.  

“La cohesión social es un estado de cosas que concierte tanto a las interacciones verticales como horizontales entre los miembros de la sociedad, caracterizado por un conjunto de actitudes y normas que incluyen la confianza, el sentido de pertenencia y la voluntad de participar y ayudar, así como sus manifestaciones conductuales” (Chan et al., 2006, p. 290).

## Propuesta LAPOP

![](images/hor-lapop.png)

## Propuesta ELSOC

![](images/hor-elsoc.png)
 
# Análisis comparativo

## Diferencias

**1)** Propuesta con ELSOC es mucho más compleja en tanto tiene mayores niveles de granularidad y, consecuentemente, mayor cantidad de factores en comparación con la propuesta de LA, cuya perspectiva es más minimalista. 

Esto se expresa en, por ejemplo, la subdimensión de confianza en instituciones y democracia. En la primera propuesta esta se entiende como una subdimensión compuesta de dos factores: confianza en instituciones y satisfacción con la democracia. No así, en la propuesta construida con LAPOP estos factores se entienden como dos subdimensiones independientes. 

**2)** En la propuesta con ELSOC se consideran varias subdimensiones que no están presentes en el índice de LA debido a decisiones basadas en inconsistencia teórica y/o estadística, tal como el factor de comportamiento prosocial, el cual intentó integrarse en con datos de WVS y, si bien la consistencia interna del factor era aceptable, no correlacionaba con los demás factores de su dimensión. 

**3)** Las propuestas no comparten ningún factor de sus subdimensiones. Si bien ambas integran confianza interpersonal en su medición, ELSOC la considera como un factor de segundo orden, mientras que en la propuesta de LAPOP es un factor de primer orden. 

# Nueva propuesta

Esta sección se presenta la construcción de la nueva propuesta de medición de cohesión social en Chile con datos de ELSOC. 

![](images/propuesta-nueva.png)

En comparación con la anterior propuesta hecha con ELSOC, se elimina la subdimensión de Sentido de pertenencia, puesto que para la construcción de la propuesta con LAPOP se definió que era problemático comprender indicadores como orgullo nacional dentro de la cohesión social. En su lugar, se integra un factor de pertenencia al barrio dentro de la subdimensión de vínculo territoriales. Asimismo, incluye una nueva subdimensión de seguridad (siguiendo la propuesta con LAPOP), considerándose como uno de los elementos centrales durante el último tiempo en las discusiones relacionadas al vínculo social. Por último, se mantiene la subdimensión de redes sociales pero sin el factor de confianza interpersonal puesto que no se pudo encontrar una fiabilidad de su medición con los datos disponibles. 

En la siguiente tabla se presenta la disponibilidad de las variables utilizadas para la construcción del índice de cohesión social. **PASAR AL ANEXO**

```{r}
#| echo: false 

library(readr)
library(DT)

datos <- read_delim("../../input/tables/variables-nueva-propuesta.csv", 
                    delim = ";", 
                    show_col_types = FALSE)
datatable(datos)
```

A continuación, se presentan los descriptivos de los constructos presentados en la propuesta:

```{r}
#| label: packages
#| echo: false

if (! require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse,
               sjmisc, 
               here,
               sjlabelled,
               psych,
               rstatix,
               lme4,
               performance,
               sjPlot,
               srvyr,
               ggdist,
               purrr,
               rlang)


options(scipen=999)
rm(list = ls())
```

```{r}
#| label: database ola 1
#| echo: false 

elsoc_1 <- readRDS("../../input/data/proc_data/elsoc_2016_coh_mig.RData")
```

```{r}
#| label: database ola 2
#| echo: false 

elsoc_2 <- readRDS("../../input/data/proc_data/elsoc_2017_coh_mig.RData")
```

```{r}
#| label: database ola 3 
#| echo: false 

elsoc_3 <- readRDS("../../input/data/proc_data/elsoc_2018_coh_mig.RData")
```

```{r}
#| label: database ola 4
#| echo: false 

elsoc_4 <- readRDS("../../input/data/proc_data/elsoc_2019_coh_mig.RData")
```

```{r}
#| label: database ola 6
#| echo: false 

elsoc_6 <- readRDS("../../input/data/proc_data/elsoc_2022_mig.RData")
```

```{r}
#| label: database ola 5 
#| echo: false 

elsoc_5 <- readRDS("../../input/data/proc_data/elsoc_2021_mig.RData")
```

```{r}
#| label: data-full
#| echo: false

# Agregar la variable ola a cada base
elsoc_1 <- elsoc_1 %>% mutate(ola = 1)
elsoc_2 <- elsoc_2 %>% mutate(ola = 2)
elsoc_3 <- elsoc_3 %>% mutate(ola = 3)
elsoc_4 <- elsoc_4 %>% mutate(ola = 4)
elsoc_4 <- elsoc_4 %>% mutate(ola = 4)
elsoc_5 <- elsoc_5 %>% mutate(ola = 5)
elsoc_6 <- elsoc_6 %>% mutate(ola = 6)

# Unir todas las olas en una sola base
elsoc_long <- bind_rows(elsoc_1, elsoc_2, elsoc_3, elsoc_4, elsoc_5, elsoc_6)
```

```{r}
#| label: comportamiento prosocial dummy
elsoc_5_graph <- elsoc_5 %>%
  mutate(
    # Índice promediado
    comportamiento_prosocial = rowMeans(
      select(., reunion_pub, voluntariado),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    comportamiento_prosocial = case_when(
      comportamiento_prosocial <= 1.5 ~ 0,
      comportamiento_prosocial >= 2   ~ 1
    ),
    
    # Convertir a factor con labels
    comportamiento_prosocial = factor(
      comportamiento_prosocial,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )

```

```{r}
#| label: ayuda economica dummy
elsoc_5_graph <- elsoc_5_graph %>%
  mutate(
    # Índice promediado
    ayuda_economica = rowMeans(
      select(., prestar_dinero, ayuda_trabajo),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    ayuda_economica = case_when(
      ayuda_economica <= 1.5 ~ 0,
      ayuda_economica >= 2   ~ 1
    ),
    
    # Convertir a factor con labels
    ayuda_economica = factor(
      ayuda_economica,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: confianza interpersonal dummy
elsoc_5_graph <- elsoc_5_graph %>%
  mutate(
    # Índice promediado
    confianza_inter = rowMeans(
      select(., confianza_gen, altruismo_gen),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    confianza_inter = case_when(
      confianza_inter <= 1.5 ~ 0,
      confianza_inter >= 2   ~ 1
    ),
    
    # Convertir a factor con labels
    confianza_inter = factor(
      confianza_inter,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
elsoc_5_graph <- elsoc_5_graph %>%
  mutate(
    comportamiento_prosocial = set_label(comportamiento_prosocial, "Comportamiento prosocial"),
    ayuda_economica          = set_label(ayuda_economica, "Ayuda económica"),
    confianza_inter          = set_label(confianza_inter, "Confianza interpersonal")
  )
```

```{r}
#| label: seguridad subjetiva dummy

elsoc_6_graph <- elsoc_6 %>%
  mutate(
    # Índice promediado
    seguridad_sub = rowMeans(
      select(., seguridad_sat, seguridad_perc),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    seguridad_sub = case_when(
      seguridad_sub <= 2.5 ~ 0,
      seguridad_sub >= 3   ~ 1
    ),
    
    # Convertir a factor con labels
    seguridad_sub = factor(
      seguridad_sub,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: seguridad objetiva dummy

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(
    # Índice promediado
    seguridad_obj = rowMeans(
      select(., peleas_calle, asaltos, trafico_drogas),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    seguridad_obj = case_when(
      seguridad_obj <= 2.5 ~ 0,
      seguridad_obj >= 3   ~ 1
    ),
    
    # Convertir a factor con labels
    seguridad_obj = factor(
      seguridad_obj,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: sentido de pertenencia dummy

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(
    # Índice promediado
    sentido_pertenencia = rowMeans(
      select(., barrio_ideal, barrio_integracion, barrio_identidad, barrio_pertenencia),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    sentido_pertenencia = case_when(
      sentido_pertenencia <= 2.5 ~ 0,
      sentido_pertenencia >= 3   ~ 1
    ),
    
    # Convertir a factor con labels
    sentido_pertenencia = factor(
      sentido_pertenencia,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: satisfacción con el barrio dummy

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(
    # Índice promediado
    satisfaccion_barrio = rowMeans(
      select(., barrio_amigos, barrio_sociable, barrio_cordial, barrio_colaborador),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    satisfaccion_barrio = case_when(
      satisfaccion_barrio <= 2.5 ~ 0,
      satisfaccion_barrio >= 3   ~ 1
    ),
    
    # Convertir a factor con labels
    satisfaccion_barrio = factor(
      satisfaccion_barrio,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```


```{r}
#| label: fig-redes
#| fig-cap: Likerplot de índices de redes sociales
#| echo: false 

cohesion_1 <- plot_stackfrq(
  dplyr::select(elsoc_5_graph, comportamiento_prosocial, ayuda_economica, confianza_inter),
  title = "Likerplots de índices de redes sociales"
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 18),
        title = element_text(size = 20),  # ajusta a tu gusto
        legend.text = element_text(size = 16)
        ) +
        scale_fill_manual(
        values = c("Bajo" = "#f9913d", "Alto" = "#2b2f3c")
        )

cohesion_1
```


```{r}
#| label: fig-seguridad
#| fig-cap: Likerplot de índices de seguridad
#| echo: false 

cohesion_2 <- plot_stackfrq(
  dplyr::select(elsoc_6_graph, seguridad_sub, seguridad_obj),
  title = "Likerplots de índices de seguridad"
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 18),
        title = element_text(size = 20),  # ajusta a tu gusto
        legend.text = element_text(size = 16)
        ) +
        scale_fill_manual(
        values = c("Bajo" = "#f9913d", "Alto" = "#2b2f3c")
        )

cohesion_2
```


```{r}
#| label: fig-vinculos
#| fig-cap: Likerplot de índices de vínculos territoriales
#| echo: false 

cohesion_3 <- plot_stackfrq(
  dplyr::select(elsoc_6_graph, sentido_pertenencia, satisfaccion_barrio),
  title = "Likerplots de índices de vínculos territoriales"
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 18),
        title = element_text(size = 20),  # ajusta a tu gusto
        legend.text = element_text(size = 16)
        ) +
        scale_fill_manual(
        values = c("Bajo" = "#f9913d", "Alto" = "#2b2f3c")
        )

cohesion_3
```

```{r}
#| label: comportamiento prosocial dummy 2

elsoc_long_graph <- elsoc_long %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    comportamiento_prosocial = rowMeans(
      cbind(reunion_pub, voluntariado),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    comportamiento_prosocial = case_when(
      comportamiento_prosocial <= 1.5 ~ 1,
      comportamiento_prosocial >= 2   ~ 0,
      TRUE ~ NA_real_  # Para valores entre 1.5 y 2
    ),
    
    # Convertir a factor con labels
    comportamiento_prosocial = factor(
      comportamiento_prosocial,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: ayuda economica dummy 2
elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    ayuda_economica = rowMeans(
      cbind(prestar_dinero, ayuda_trabajo),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    ayuda_economica = case_when(
      ayuda_economica <= 1.5 ~ 1,
      ayuda_economica >= 2   ~ 0,
      TRUE ~ NA_real_  # Para valores entre 1.5 y 2
    ),
    
    # Convertir a factor con labels
    ayuda_economica = factor(
      ayuda_economica,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: confianza interpersonal dummy 2
elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    confianza_inter = rowMeans(
      cbind(confianza_gen, altruismo_gen),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    confianza_inter = case_when(
      confianza_inter <= 1.5 ~ 1,
      confianza_inter >= 2   ~ 0,
      TRUE ~ NA_real_  # Para valores entre 1.5 y 2
    ),
    
    # Convertir a factor con labels
    confianza_inter = factor(
      confianza_inter,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: redes dummy 2

elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    comportamiento_prosocial = set_label(comportamiento_prosocial, "Comportamiento prosocial"),
    ayuda_economica          = set_label(ayuda_economica, "Ayuda económica"),
    confianza_inter          = set_label(confianza_inter, "Confianza interpersonal")
  )
```

```{r}
#| label: seguridad subjetiva dummy 2

elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    seguridad_sub = rowMeans(
      cbind(seguridad_sat, seguridad_perc),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    seguridad_sub = case_when(
      seguridad_sub <= 2.5 ~ 0,
      seguridad_sub >= 3   ~ 1,
      TRUE ~ NA_real_  # Para valores entre 2.5 y 3
    ),
    
    # Convertir a factor con labels
    seguridad_sub = factor(
      seguridad_sub,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r} 
#| label: seguridad objetiva dummy 2

elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    seguridad_obj = rowMeans(
      cbind(peleas_calle, asaltos, trafico_drogas),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    seguridad_obj = case_when(
      seguridad_obj <= 2.5 ~ 0,
      seguridad_obj >= 3   ~ 1,
      TRUE ~ NA_real_  # Para valores entre 2.5 y 3
    ),
    
    # Convertir a factor con labels
    seguridad_obj = factor(
      seguridad_obj,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: sentido de pertenencia dummy 2

elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    sentido_pertenencia = rowMeans(
      cbind(barrio_ideal, barrio_integracion, barrio_identidad, barrio_pertenencia),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    sentido_pertenencia = case_when(
      sentido_pertenencia <= 2.5 ~ 1,
      sentido_pertenencia >= 3   ~ 0,
      TRUE ~ NA_real_  # Para valores entre 2.5 y 3
    ),
    
    # Convertir a factor con labels
    sentido_pertenencia = factor(
      sentido_pertenencia,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: satisfacción con el barrio dummy 2

elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    satisfaccion_barrio = rowMeans(
      cbind(barrio_amigos, barrio_sociable, barrio_cordial, barrio_colaborador),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    satisfaccion_barrio = case_when(
      satisfaccion_barrio <= 2.5 ~ 1,
      satisfaccion_barrio >= 3   ~ 0,
      TRUE ~ NA_real_  # Para valores entre 2.5 y 3
    ),
    
    # Convertir a factor con labels
    satisfaccion_barrio = factor(
      satisfaccion_barrio,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```


```{r}
#| label: fig-long-1
#| fig-cap: "Tendencia índices de Seguridad"

# Variables de seguridad (índices categóricos)
vars_seguridad <- c("seguridad_sub", "seguridad_obj")

# Preparar datos para gráfico apilado
long_seguridad_stack <- elsoc_long_graph %>%
  select(ola, all_of(vars_seguridad)) %>%
  pivot_longer(cols = all_of(vars_seguridad), 
               names_to = "variable", 
               values_to = "valor") %>%
  filter(!is.na(valor)) %>%
  group_by(ola, variable, valor) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(ola, variable) %>%
  mutate(
    total = sum(n),
    proporcion = n / total
  ) %>%
  ungroup() %>%
  mutate(
    variable_clean = case_when(
      variable == "seguridad_sub" ~ "Seguridad Subjetiva",
      variable == "seguridad_obj" ~ "Seguridad Objetiva"
    )
  )

# Asegurar orden de categorías
long_seguridad_stack <- long_seguridad_stack %>%
  mutate(
    valor = factor(valor, levels = c("Alto", "Bajo"))
  )

# Vector con años correspondientes a cada ola
anos_olas <- c("2016", "2017", "2018", "2019", "2022", "2023")

ggplot(long_seguridad_stack, aes(x = ola, y = proporcion, fill = valor)) +
  geom_area(alpha = 0.7, position = "stack") +
  geom_line(aes(group = interaction(variable, valor)), 
            position = "stack", 
            linewidth = 0.5, 
            color = "white") +
  facet_wrap(~variable_clean, ncol = 2) +
  scale_fill_manual(values = c(
    "Bajo" = "#F9913D",
    "Alto" = "#2B2F3C"
  )) +
  scale_x_continuous(
    breaks = 1:6,
    labels = anos_olas
  ) +
  scale_y_continuous(
    limits = c(0, 1), 
    breaks = seq(0, 1, 0.2),
    labels = scales::percent_format(accuracy = 1)
  ) +
  labs(title = "Distribución de índices de seguridad por ola (ELSOC 2016-2023)",
       x = "Año", 
       y = "Proporción", 
       fill = "Nivel") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background     = element_rect(fill = "white", color = NA),
    legend.margin         = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin     = margin(t = 6, r = 6, b = 6, l = 6),
    
    legend.position       = "top",
    legend.direction      = "horizontal",
    legend.box            = "horizontal",
    
    legend.title          = element_text(face = "bold"),
    legend.key            = element_rect(fill = "white", color = NA),
    legend.key.height     = unit(12, "pt"),
    legend.key.width      = unit(20, "pt"),
    
    axis.text  = element_text(size = 11),
    panel.spacing = unit(1, "cm")   # mantiene separación entre paneles
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "bottom",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))

```

```{r}

#| label: fig-long-10
#| fig-cap: "Tendencia índices de Redes"

# Variables de redes (índices categóricos)
vars_redes <- c("comportamiento_prosocial", "ayuda_economica", "confianza_inter")

# Preparar datos para gráfico apilado
long_redes_stack <- elsoc_long_graph %>%
  select(ola, all_of(vars_redes)) %>%
  pivot_longer(cols = all_of(vars_redes), 
               names_to = "variable", 
               values_to = "valor") %>%
  filter(!is.na(valor)) %>%
  group_by(ola, variable, valor) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(ola, variable) %>%
  mutate(
    total = sum(n),
    proporcion = n / total
  ) %>%
  ungroup() %>%
  mutate(
    variable_clean = case_when (
      variable == "comportamiento_prosocial" ~ "Comportamiento Prosocial",
      variable == "ayuda_economica" ~ "Ayuda Económica",
      variable == "confianza_inter" ~ "Confianza Interpersonal"
    )
  )

# Asegurar orden de categorías
long_redes_stack <- long_redes_stack %>%
  mutate(
    valor = factor(valor, levels = c("Alto", "Bajo"))
  )

# Gráfico de área apilada
ggplot(long_redes_stack, aes(x = ola, y = proporcion, fill = valor)) +
  geom_area(alpha = 0.7, position = "stack") +
  geom_line(aes(group = interaction(variable, valor)), 
            position = "stack", 
            linewidth = 0.5, 
            color = "white") +
  facet_wrap(~variable_clean, ncol = 2) +
  scale_fill_manual(values = c(
    "Bajo" = "#F9913D",
    "Alto" = "#2B2F3C"
  )) +
  scale_x_continuous(
    breaks = 1:6,
    labels = anos_olas
  ) +
  scale_y_continuous(
    limits = c(0, 1), 
    breaks = seq(0, 1, 0.2),
    labels = scales::percent_format(accuracy = 1)
  ) +
  labs(title = "Distribución de índices de redes por ola (ELSOC 2016-2023)",
       x = "Año", 
       y = "Proporción", 
       fill = "Nivel") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background     = element_rect(fill = "white", color = NA),
    legend.margin         = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin     = margin(t = 6, r = 6, b = 6, l = 6),
    
    legend.position       = "top",
    legend.direction      = "horizontal",
    legend.box            = "horizontal",
    
    legend.title          = element_text(face = "bold"),
    legend.key            = element_rect(fill = "white", color = NA),
    legend.key.height     = unit(12, "pt"),
    legend.key.width      = unit(20, "pt"),
    
    axis.text  = element_text(size = 11),
    panel.spacing = unit(1, "cm")
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "bottom",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

```{r}
#| label: fig-long-10
#| fig-cap: "Tendencia índices de Vínculos Territoriales"
#| echo: false
#| warning: false

# Variables de Vínculos Territorial (índices categóricos)
vars_territorio <- c("sentido_pertenencia", "satisfaccion_barrio")

# Preparar datos para gráfico apilado
long_territorio_stack <- elsoc_long_graph %>%
  select(ola, all_of(vars_territorio)) %>%
  pivot_longer(cols = all_of(vars_territorio), 
               names_to = "variable", 
               values_to = "valor") %>%
  filter(!is.na(valor)) %>%
  group_by(ola, variable, valor) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(ola, variable) %>%
  mutate(
    total = sum(n),
    proporcion = n / total
  ) %>%
  ungroup() %>%
  mutate(
    variable_clean = case_when (
      variable == "sentido_pertenencia" ~ "Sentido de Pertenencia",
      variable == "satisfaccion_barrio" ~ "Satisfacción con el Barrio"
    )
  )

# Asegurar orden de categorías
long_territorio_stack <- long_territorio_stack %>%
  mutate(
    valor = factor(valor, levels = c("Alto", "Bajo"))
  )

# Gráfico de área apilada
ggplot(long_territorio_stack, aes(x = ola, y = proporcion, fill = valor)) +
  geom_area(alpha = 0.7, position = "stack") +
  geom_line(aes(group = interaction(variable, valor)), 
            position = "stack", 
            linewidth = 0.5, 
            color = "white") +
  facet_wrap(~variable_clean, ncol = 2) +
  scale_fill_manual(values = c(
    "Bajo" = "#F9913D",
    "Alto" = "#2B2F3C"
  )) +
  scale_x_continuous(
    breaks = 1:6,
    labels = anos_olas
  ) +
  scale_y_continuous(
    limits = c(0, 1), 
    breaks = seq(0, 1, 0.2),
    labels = scales::percent_format(accuracy = 1)
  ) +
  labs(title = "Distribución de índices de vínculo territorial por ola (ELSOC 2016-2023)",
       x = "Año", 
       y = "Proporción", 
       fill = "Nivel") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background     = element_rect(fill = "white", color = NA),
    legend.margin         = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin     = margin(t = 6, r = 6, b = 6, l = 6),
    
    legend.position       = "top",
    legend.direction      = "horizontal",
    legend.box            = "horizontal",
    
    legend.title          = element_text(face = "bold"),
    legend.key            = element_rect(fill = "white", color = NA),
    legend.key.height     = unit(12, "pt"),
    legend.key.width      = unit(20, "pt"),
    
    axis.text  = element_text(size = 11),
    panel.spacing = unit(1, "cm")   # mantiene separación entre paneles
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "bottom",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

