# Bivariados

```{r}
#| label: packages
#| echo: false

pacman::p_load(
  dplyr, haven, sjlabelled,  psych,  purrr,  tidyr,  sjPlot,  ggplot2, 
  parameters,  table1,  car,  beeswarm, scales, ggrepel, corrplot,
  ggtext, patchwork, psych, kableExtra, labelled, patchwork)
```

```{r}
#| label: database ola 6
#| echo: false 

elsoc_6 <- readRDS("../../input/data/proc_data/elsoc_2022_mig.RData")
```

```{r}
#| label: database ola 5 
#| echo: false 

elsoc_5 <- readRDS("../../input/data/proc_data/elsoc_2021_mig.RData")
```

## Descriptivos de migración

```{r}
#| tbl-cap: "Variables migración ola 5"
#| tbl-cap-location: bottom
#| label: tbl-descr1
#| echo: false 

elsoc_5 %>% select(frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes) %>% 
  haven::zap_labels() %>%
  sjmisc::descr(.,
      show = c("label","range", "mean", "sd", "NA.prc", "n", "min", "max"))%>%
      kable(., digits =2, "markdown") %>%
  kable_styling(font_size = 22)
```

```{r}
#| tbl-cap: "Variables migración ola 6"
#| tbl-cap-location: bottom
#| label: tbl-descr2
#| echo: false 

elsoc_6 %>% select(frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes) %>% 
  haven::zap_labels() %>%
  sjmisc::descr(.,
      show = c("label","range", "mean", "sd", "NA.prc", "n", "min", "max"))%>%
      kable(., digits =2, "markdown") %>%
  kable_styling(font_size = 22)
```


```{r}
#| label: fig-desempleo
#| fig-cap: Likerplot desempleo debido a inmigrantes
#| echo: false 

ggplot(elsoc_6, aes(x = factor(desempleo_migrantes))) +
  geom_bar(fill = "#2C7BB6") +
  labs(
    title = "Distribución de respuestas sobre desempleo de migrantes",
    x = "Desempleo migrantes",
    y = "Frecuencia"
  ) +
  theme_minimal()
```

```{r}
#| label: fig-identidad
#| fig-cap: Likerplot pérdida de identidad del país
#| echo: false 

ggplot(elsoc_6, aes(x = factor(perdida_identidad))) +
  geom_bar(fill = "#2C7BB6") +
  labs(
    title = "Distribución de respuestas sobre pérdida de identidad por inmigrantes",
    x = "Grado de acuerdo sobre pérdida de identidad por migrantes",
    y = "Frecuencia"
  ) +
  theme_minimal()
```


## Creación de índices

Para realizar los cruces de las subdimensiones de la cohesión social con migración, se construyen índices de los promedios de los indicadores que conforman los constructos validados en la sección anterior. 

::: callout-note
Si bien, en la sección de análisis de constructos estos se entendieron como factores, para efectos prácticos de difusión se decidió aplicar una construcción de índices, ya que esto permite que los valores se mantengan en la escala original en que fueron medidas las variables, lo cual facilita su interpretación al momento de presentar resultados. 
:::

```{r}
#| label: comportamiento prosocial
elsoc_5 <- elsoc_5 %>%
  mutate(comportamiento_prosocial = rowMeans(select(., reunion_pub, voluntariado), na.rm = TRUE))
```

```{r}
#| label: ayuda economica
elsoc_5 <- elsoc_5 %>%
  mutate(ayuda_economica = rowMeans(select(., prestar_dinero, ayuda_trabajo), na.rm = TRUE))
```

```{r}
#| label: confianza interpersonal
elsoc_5 <- elsoc_5 %>%
  mutate(confianza_inter = rowMeans(select(., confianza_gen, altruismo_gen), na.rm = TRUE))
```

```{r}
#| label: seguridad subjetiva

elsoc_6 <- elsoc_6 %>%
  mutate(seguridad_sub = rowMeans(select(., seguridad_sat, seguridad_perc), na.rm = TRUE))
```

```{r}
#| label: seguridad objetiva

elsoc_6 <- elsoc_6 %>%
  mutate(seguridad_obj = rowMeans(select(., peleas_calle, asaltos, trafico_drogas), na.rm = TRUE))
```

```{r}
#| label: sentido de pertenencia

elsoc_6 <- elsoc_6 %>%
  mutate(
    # Calcular promedio de las variables
    sentido_pertenencia = rowMeans(select(., barrio_ideal, barrio_integracion, barrio_identidad, barrio_pertenencia), na.rm = TRUE))
```

```{r}
#| label: satisfacción con el barrio
elsoc_6 <- elsoc_6 %>%
  mutate(satisfaccion_barrio = rowMeans(select(., barrio_amigos, barrio_sociable, barrio_cordial, barrio_colaborador), na.rm = TRUE))
```

PROBAR subir el valor al momento de recodificar 

```{r}


graph_in2 <- plot_stackfrq(
  dplyr::select(elsoc_6, seguridad_obj),
  title = "Acuerdo en pérdida de identidad del país por inmigrantes" 
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 10))  # ajusta a tu gusto

graph_in2
```

## Descriptivos

### Índices 
```{r}
#| label: fig-prosoc
#| fig-cap: Likerplot índice comportamiento prosocial
#| echo: false 

graph1 <- plot_stackfrq(
  dplyr::select(elsoc_5, comportamiento_prosocial),
  title = "Comportamiento prosocial"
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 10))  # ajusta a tu gusto

graph1
```

```{r}
hist(elsoc_5$comportamiento_prosocial,main="Histograma de comportamiento prosocial",xlab="Valor",ylab="Frecuencia",col="#2b70c4",border="black")
```

```{r}
#| label: fig-eco
#| fig-cap: Likerplot índice ayuda económica
#| echo: false 

graph2 <- plot_stackfrq(
  dplyr::select(elsoc_5, ayuda_economica),
  title = "Ayuda económica"
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 10))  # ajusta a tu gusto

graph2
```

```{r}
#| label: fig-conf
#| fig-cap: Likerplot índice confianza interpersonal
#| echo: false 

graph3 <- plot_stackfrq(
  dplyr::select(elsoc_5, confianza_inter),
  title = "Confianza interpersonal"
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 10))  # ajusta a tu gusto

graph3
```


```{r}
#| label: fig-segs
#| fig-cap: Likerplot índice seguridad subjetiva
#| echo: false 

graph4 <- plot_stackfrq(
  dplyr::select(elsoc_6, seguridad_sub),
  title = "Seguridad subjetiva"
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 10))  # ajusta a tu gusto
graph4
```

```{r}
#| label: fig-sego
#| fig-cap: Likerplot índice seguridad objetiva
#| echo: false 

graph5 <- plot_stackfrq(
  dplyr::select(elsoc_6, seguridad_obj),
  title = "Seguridad objetiva"
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 10))  # ajusta a tu gusto

graph5
```

```{r}
#| label: fig-sentido
#| fig-cap: Likerplot índice sentido de pertenencia
#| echo: false 

graph6 <- plot_stackfrq(
  dplyr::select(elsoc_6, sentido_pertenencia),
  title = "Sentido de pertenencia"
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 10))  # ajusta a tu gusto

graph6
```

```{r}
#| label: fig-satis
#| fig-cap: Likerplot índice satisfacción con el barrio
#| echo: false 

graph7 <- plot_stackfrq(
  dplyr::select(elsoc_6, satisfaccion_barrio),
  title = "Satisfacción barrio"
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 10))  # ajusta a tu gusto

graph7
```

## Correlaciones

### Correlación seguridad
 
```{r}
#| label: base índices seguridad e indicadores migración
#| echo: false 

seg_mig <- elsoc_6 %>%
  select(seguridad_obj, seguridad_sub, frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes)
```

### Correlación de Spearman
```{r}
corrsegmig <- round(cor(seg_mig, use = "pairwise.complete.obs", method = "spearman"), 2)
```

```{r}
#| label: fig-corr1
#| fig-cap: Correlaciones seguridad y migración (Spearman)
#| echo: false

corrplot(corrsegmig,
         method = "color",       # colorea los recuadros según valor
         col = colorRampPalette(c("#f56c27", "white", "#2761f5"))(20),  # blanco a rojo
         type = "upper",         # mostrar solo la mitad superior
         order = "original",     # mantener el orden de las variables
         addCoef.col = "black",  # añadir los valores numéricos
         tl.col = "black",       # color etiquetas
         tl.srt = 45, 
         bg = "white",# rotar etiquetas
         number.cex = 0.8
)
```

La @fig-corr1 refleja las correlaciones de Spearman entre los índices de seguridad y los indicadores de migración. Se observa la mayoría de los indicadores de migración tienen una correlación bastante baja con ambos índices de seguridad. Las asociaciones más altas las tiene la seguridad subjetiva con confianza en migrantes **(.14)** y con simpatía hacia los migrantes **(.10)**.

### Correlaciones policóricas
```{r}
#| label: matriz de correlaciones policóricas seguridad
poly_cor <- polychoric(seg_mig)
```

```{r}
#| label: fig-corr2
#| fig-cap: Correlaciones seguridad y migración
#| echo: false

corrplot(poly_cor$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

En @fig-corr2 se observa una matriz de correlaciones policóricas. En este caso, la mayoría de las correlaciones son bajas, destacando seguridad subjetiva con desempleo debido a inmigrantes con un **-.25**, entiéndose que mientras más acuerdo hay con que la llegada de inmigrantes al país causa desempleo, menor es la sensación de seguridad. En la misma lógica se correlacionan seguridad subjetiva con pérdida de identidad, en donde, a menor seguridad subjetiva, mayor acuerdo con que los inmigrantes hacen que Chile pierda identidad. 



```{r}
#| label: fig-jit1
#| fig-cap: Jitter de desempleo por inmigrantes y sensación de seguridad
#| echo: false 

ggplot(seg_mig, aes(x = desempleo_migrantes, y = seguridad_sub)) +
  geom_jitter(width = 0.2, height = 0.2, alpha = 0.5, color = "blue") +
  labs(
    x = "Desempleo debido a inmigrantes",
    y = "Seguridad subjetiva",
    title = "Dispersión con jitter"
  ) +
  theme_minimal()
```

En @fig-jit1 se presenta la distribución de los valores entre seguridad subjetiva y desempleo debido a inmigrantes. Las mayores cantidades de puntos se concentran mayoritariamente en la parte superior (específicamente la categoría 4) de los valores 2 y 4 del indicador de desempleo. Esto presenta una opinión dividida en tanto que, cuando las personas perciben seguridad en su barrio, hay un grupo que está de acuerdo con que los inmigrantes causan desempleo, mientras que el otro está en desacuerdo con este enunciado. 

## Correlación vínculos territoriales

### Correlación de Spearman
```{r}
#| label: base índices territorio e indicadores migración

barrio_mig <- elsoc_6 %>%
  select(sentido_pertenencia, satisfaccion_barrio, frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes)
```

```{r}
corrbarriomig <- round(cor(barrio_mig, use = "pairwise.complete.obs", , method = "spearman"), 2)
```


```{r}
#| label: fig-corr3
#| fig-cap: Correlaciones territorio y migración
#| echo: false

corrplot(corrbarriomig,
         method = "color",       # colorea los recuadros según valor
         col = colorRampPalette(c("#2761f5", "white", "#f56c27"))(20),  # blanco a rojo
         type = "upper",         # mostrar solo la mitad superior
         order = "original",     # mantener el orden de las variables
         addCoef.col = "black",  # añadir los valores numéricos
         tl.col = "black",       # color etiquetas
         tl.srt = 45, 
         bg = "white",# rotar etiquetas
         number.cex = 0.8
)
```
En @fig-corr3 se pueden ver los cruces entre los índices de vinculación territorial con los indicadores de migración. Las correlaciones entre las mediciones de territorio y la migración son en general bajas, siendo satisfacción del barrio con confianza en migrantes la más alta (.12). 

### Correlaciones policóricas

```{r}
#| label: matriz de correlaciones policóricas territorio
poly_cor2 <- polychoric(barrio_mig)
```

```{r}
#| label: fig-corr4
#| fig-cap: Correlaciones territorio y migración
#| echo: false

corrplot(poly_cor2$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

En @fig-corr4 se observa la matriz de correlaciones policóricas que contiene los índices de vinculación territorial e indicadores de migración. La mayoría de las correlaciones son bajas. El índice de sentido de pertenencia correlaciona en un **-.22** con frecuencia con inmigrantes, entendiéndose que a mayor sentido de pertenencia del barrio, menor se frecuenta con inmigrantes.

## Correlación redes sociales 

```{r}
redes_mig <- elsoc_5 %>%
  select(comportamiento_prosocial, ayuda_economica, confianza_inter, frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes)
```


### Correlación de Spearman
```{r}
corredesmig <- round(cor(redes_mig, use = "pairwise.complete.obs", method = "spearman"), 2)
```

```{r}
#| label: fig-corr5
#| fig-cap: Correlaciones redes sociales y migración (Spearman)
#| echo: false

corrplot(corredesmig,
         method = "color",       # colorea los recuadros según valor
         col = colorRampPalette(c("#f56c27", "white", "#2761f5"))(20),  # blanco a rojo
         type = "upper",         # mostrar solo la mitad superior
         order = "original",     # mantener el orden de las variables
         addCoef.col = "black",  # añadir los valores numéricos
         tl.col = "black",       # color etiquetas
         tl.srt = 45, 
         bg = "white",# rotar etiquetas
         number.cex = 0.8
)
```

### Correlaciones policóricas

```{r}
#| label: matriz de correlaciones policóricas redes sociales
poly_cor3 <- polychoric(redes_mig)
```

```{r}
#| label: fig-corr6
#| fig-cap: Correlaciones territorio y migración
#| echo: false

corrplot(poly_cor3$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

En @fig-corr6 se presenta las correlaciones policóricas entre los índices de redes sociales (comportamiento prosocial y ayuda económica) y los indicadores de migración. En la matriz se pueden observar algunas correlaciones moderadas, tal como la asociación entre comportamiento prosocial e igualdad con inmigrantes **(-.38)**. Esto quiere decir que, a mayor comportamiento prosocial, hay un mayor desacuerdo con que los inmigrantes tengan un acceso igualitario a la salud. En la misma lógica se presenta la asociación entre el índice de confianza interpersonal con desempleo debido a inmigrantes **(-.30)**, queriendo decir que a menor confianza interpersonal, hay un mayor acuerdo respecto a la idea de los inmigrantes aumentan el desempleo en el país. 

```{r}
#| label: fig-jit2
#| fig-cap: Jitter de igualdad en salud con inmigrantes y comportamiento prosocial 
#| echo: false 

ggplot(redes_mig, aes(x = igualdad_migrantes, y = comportamiento_prosocial)) +
  geom_jitter(width = 0.2, height = 0.2, alpha = 0.5, color = "blue") +
  labs(
    x = "Acceso igualitario a salud con inmigrantes",
    y = "Comportamiento prosocial",
    title = "Dispersión con jitter"
  ) +
  theme_minimal()
```

En @fig-jit2 se observa la distribución de los valores entre el índice de comportamiento prosocial y el indicador de igualdad en salud con inmigrantes. La densidad de las respuestas se concentra mayoritariamente en la parte inferior derecha del gráfico, lo que indica una asociación negativa entre las dos variables. Se puede interpretar que, cuando las personas no han cometido actos a favor del vínculo social, están de acuerdo con que los inmigrantes tengan acceso a la salud de la misma forma que los chilenos. 

# Moderación de correlaciones (género y nivel educacional)

En orden de encontrar asociaciones con mayor efecto y que, en consecuencia, puedan ser insumos relevantes para el segundo foro, se aplican las mismas correlaciones que en el punto anterior, pero esta vez filtrando por género (hombre/mujer) y nivel educacional(universitario/no universitario). 

## Seguridad por género
```{r}
seguridad_genero <- elsoc_6 %>%
  select(sexo, seguridad_obj, seguridad_sub, frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes)
```

```{r}
seguridad_hombres <- seguridad_genero %>%
  filter(sexo==0)

seguridad_mujeres <- seguridad_genero %>%
  filter(sexo==1)
```

```{r}
seguridad_hombres <- seguridad_hombres %>%
  select(-c(sexo))

seguridad_mujeres <- seguridad_mujeres %>%
  select(-c(sexo))
```

```{r}
poly_cor4 <- polychoric(seguridad_hombres)
poly_cor5 <- polychoric(seguridad_mujeres)
```

```{r}
#| label: fig-corr-gen0
#| fig-cap: Correlaciones seguridad y migración (hombres)
#| echo: false

corrplot(poly_cor4$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

Correlaciones relevantes: Seguridad objetiva y frencuencia con inmigrantes **(-.28)**. Seguridad objetiva y contacto con inmigrantes **(-.27)**
Seguridad subjetiva con fomentar la migración legal **(-26)**.


```{r}
#| label: fig-corr-gen1
#| fig-cap: Correlaciones seguridad y migración (mujeres)
#| echo: false

corrplot(poly_cor5$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

Correlaciones relevantes: Seguridad objetiva y frencuencia con inmigrantes **(-.28)**.

## Seguridad por educación

```{r}
seguridad_educ <- elsoc_6 %>%
  select(educacion, seguridad_obj, seguridad_sub, frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes)
```

```{r}
seguridad_titulo <- seguridad_educ %>%
  filter(educacion==1)

seguridad_notitulo <- seguridad_educ %>%
  filter(educacion==0)
```

```{r}
seguridad_titulo <- seguridad_titulo %>%
  select(-c(educacion))

seguridad_notitulo <- seguridad_notitulo %>%
  select(-c(educacion))
```

```{r}
poly_cor6 <- polychoric(seguridad_titulo)
poly_cor7 <- polychoric(seguridad_notitulo)
```

```{r}
#| label: fig-corr-gen_ed1
#| fig-cap: Correlaciones seguridad y migración (titulados)
#| echo: false

corrplot(poly_cor6$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

Correlaciones relevantes: Seguridad subjetiva y desempleo debido a inmigrantes **(-.30**. Seguridad objetiva y frecuencia inmigrantes **(-.29)**. 

```{r}
#| label: fig-corr-gen_ed0
#| fig-cap: Correlaciones seguridad y migración (no titulados)
#| echo: false

corrplot(poly_cor7$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

Correlaciones relevantes: Seguridad objetiva y frecuencia inmigrantes **(-.28)**.

## Vínculos territoriales por género

```{r}
barrio_genero <- elsoc_6 %>%
  select(sexo, sentido_pertenencia, satisfaccion_barrio, frecuencia_migrantes, contacto_migrantes,     simpatia_migrantes, perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes)
```

```{r}
barrio_hombres <- barrio_genero %>%
  filter(sexo==0)

barrio_mujeres <- barrio_genero %>%
  filter(sexo==1)
```

```{r}
barrio_hombres <- barrio_hombres %>%
  select(-c(sexo))

barrio_mujeres <- barrio_mujeres %>%
  select(-c(sexo))
```

```{r}
poly_cor8 <- polychoric(barrio_hombres)
poly_cor9 <- polychoric(barrio_mujeres)
```

```{r}
#| label: fig-corr-gen_barrio0
#| fig-cap: Correlaciones barrio y migración (hombres)
#| echo: false

corrplot(poly_cor8$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

Correlaciones relevantes: Sentido de pertenencia y frecuencia con inmigrantes **(-.25)**.

```{r}
#| label: fig-corr-gen_barrio1
#| fig-cap: Correlaciones barrio y migración (mujeres)
#| echo: false

corrplot(poly_cor9$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

Correlaciones relevantes: Sentido de pertenencia y frecuencia con inmigrantes **(-.21)**.

## Vínculos territoriales por educación

```{r}
barrio_educ <- elsoc_6 %>%
  select(educacion, sentido_pertenencia, satisfaccion_barrio, frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes)
```

```{r}
barrio_titulo <- barrio_educ %>%
  filter(educacion==1)

barrio_notitulo <- barrio_educ %>%
  filter(educacion==0)
```

```{r}
barrio_titulo <- barrio_titulo %>%
  select(-c(educacion))

barrio_notitulo <- barrio_notitulo %>%
  select(-c(educacion))
```

```{r}
poly_cor10 <- polychoric(barrio_titulo)
poly_cor11 <- polychoric(barrio_notitulo)
```

```{r}
#| label: fig-corr-edu-barrio1
#| fig-cap: Correlaciones barrio y migración (titulados)
#| echo: false

corrplot(poly_cor10$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

Correlaciones relevantes: Satisfacción con el barrio y desempleo debido a inmigrantes **(-.29)**. Satisfacción con el barrio y pérdida de identidad del país debido a inmigrantes **(-.26)**. Sentido de pertenencia y desempleo debido a inmigrantes **(-.25)**.

```{r}
#| label: fig-corr-edu_barrio0
#| fig-cap: Correlaciones barrio y migración (no titulados)
#| echo: false

corrplot(poly_cor11$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

Correlaciones relevantes: Sentido de pertenencia y frecuencia con inmigrantes **(-.23)**.
## Redes por género

```{r}
redes_genero <- elsoc_5 %>%
  select(sexo, comportamiento_prosocial, ayuda_economica, confianza_inter, frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes)
```

```{r}
redes_hombres <- redes_genero %>%
  filter(sexo==0)

redes_mujeres <- redes_genero %>%
  filter(sexo==1)
```

```{r}
redes_hombres <- redes_hombres %>%
  select(-c(sexo))

redes_mujeres <- redes_mujeres %>%
  select(-c(sexo))
```

```{r}
poly_cor12 <- polychoric(redes_hombres)
poly_cor13 <- polychoric(redes_mujeres)
```


```{r}
#| label: fig-corr-gen_redes0
#| fig-cap: Correlaciones redes sociales y migración (hombres)
#| echo: false

corrplot(poly_cor12$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

Correlaciones relevantes: Comportamiento prosocial y acceso igualitario a salud con inmigrantes **(-.35)**. Comportamiento prosocial y desempleo debido a inmigrantes **(-.29)**. Confianza interpersonal y desempleo debido a inmigrantes **(-.29)**. Ayuda económica y fomentar la migración legal **(-.28)**. 

```{r}
#| label: fig-corr-gen_redes1
#| fig-cap: Correlaciones redes y migración (mujeres)
#| echo: false

corrplot(poly_cor13$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

Correlaciones relevantes: Comportamiento prosocial y acceso igualitario a salud con inmigrantes **(-.40)**. Comportamiento prosocial y desempleo debido a inmigrantes **(-.38)**. Confianza interpersonal y desempleo debido a inmigrantes **(-.31)**. Ayuda económica y desempleo debido a inmigrantes **(-.31)**. 



## Redes por educación

```{r}
redes_educ <- elsoc_5 %>%
  select(educacion, comportamiento_prosocial, ayuda_economica, confianza_inter, frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes)
```

```{r}
redes_titulo <- redes_educ %>%
  filter(educacion==1)

redes_notitulo <- redes_educ %>%
  filter(educacion==0)
```

```{r}
redes_titulo <- redes_titulo %>%
  select(-c(educacion))

redes_notitulo <- redes_notitulo %>%
  select(-c(educacion))
```

```{r}
poly_cor14 <- polychoric(redes_titulo)
poly_cor15 <- polychoric(redes_notitulo)
```

```{r}
#| label: fig-corr-educ_redes1
#| fig-cap: Correlaciones redes y migración (titulados)
#| echo: false

corrplot(poly_cor14$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

Correlaciones relevantes: Ayuda económica y confianza en inmigrantes **(-.32)**. Comportamiento prosocial e igualdad en acceso a la salud con inmigrantes **(-.31)**. 

```{r}
#| label: fig-corr-educ_redes0
#| fig-cap: Correlaciones redes y migración (no titulados)
#| echo: false

corrplot(poly_cor15$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

Correlaciones relevantes: Comportamiento prosocial e igualdad en acceso a la salud con inmigrantes **(-.40)**. Comportamiento prosocial y desempleo debido a inmigrantes **(-.36)**. Confianza interpersonal y desempleo debido a inmigrantes **(-.31)**. 

# Visualizaciones 

```{r}
#| label: comportamiento prosocial dummy
elsoc_5_graph <- elsoc_5 %>%
  mutate(comportamiento_prosocial = rowMeans(select(., reunion_pub, voluntariado), na.rm = TRUE))

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(comportamiento_prosocial = case_when(
    comportamiento_prosocial <= 1.5 ~ 0,
    comportamiento_prosocial >= 2   ~ 1
  ))
```

```{r}
#| label: ayuda economica dummy
elsoc_5_graph <- elsoc_5_graph %>%
  mutate(ayuda_economica = rowMeans(select(., prestar_dinero, ayuda_trabajo), na.rm = TRUE))

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(ayuda_economica = case_when(
    ayuda_economica <= 1.5 ~ 0,
    ayuda_economica >= 2   ~ 1
  ))
```

```{r}
#| label: confianza interpersonal dummy
elsoc_5_graph <- elsoc_5_graph %>%
  mutate(confianza_inter = rowMeans(select(., confianza_gen, altruismo_gen), na.rm = TRUE))

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(confianza_inter = case_when(
    confianza_inter <= 1.5 ~ 0,
    confianza_inter >= 2   ~ 1
  ))
```

```{r}
#| label: seguridad subjetiva dummy

elsoc_6_graph <- elsoc_6 %>%
  mutate(seguridad_sub = rowMeans(select(., seguridad_sat, seguridad_perc), na.rm = TRUE))

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(seguridad_sub = case_when(
    seguridad_sub <= 2.5 ~ 1,
    seguridad_sub >= 3   ~ 0
  ))

```

```{r}
#| label: seguridad objetiva dummy

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(seguridad_obj = rowMeans(select(., peleas_calle, asaltos, trafico_drogas), na.rm = TRUE))

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(seguridad_obj = case_when(
    seguridad_obj <= 2.5 ~ 0,
    seguridad_obj >= 3   ~ 1
  ))
```

```{r}
#| label: sentido de pertenencia dummy

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(
    # Calcular promedio de las variables
    sentido_pertenencia = rowMeans(select(., barrio_ideal, barrio_integracion, barrio_identidad, barrio_pertenencia), na.rm = TRUE))

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(sentido_pertenencia = case_when(
    sentido_pertenencia <= 2.5 ~ 0,
    sentido_pertenencia >= 3   ~ 1
  ))
```

```{r}
#| label: satisfacción con el barrio dummy
elsoc_6_graph <- elsoc_6_graph %>%
  mutate(satisfaccion_barrio = rowMeans(select(., barrio_amigos, barrio_sociable, barrio_cordial, barrio_colaborador), na.rm = TRUE))

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(satisfaccion_barrio = case_when(
    satisfaccion_barrio <= 2.5 ~ 0,
    satisfaccion_barrio >= 3   ~ 1
  ))
```

```{r}
elsoc_6_graph <- elsoc_6_graph %>%
  mutate(desempleo_migrantes = case_when(
    desempleo_migrantes <= 2 ~ 1,
    desempleo_migrantes == 3  ~ 2,
    desempleo_migrantes >= 4 ~ 3
  ))
```

```{r}
elsoc_6_graph <- elsoc_6_graph %>%
  na.omit()

ggplot(elsoc_6_graph, aes(
  x = desempleo_migrantes, 
  fill = factor(seguridad_sub, labels = c("Alta seguridad", "Poca seguridad"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta seguridad" = "#2b2f3c", "Poca seguridad" = "#f9913d"),
    breaks = c("Alta seguridad", "Poca seguridad")  # ordena los niveles
  ) +
  labs(
    title = "Porcentaje de percepción de desempleo \n debido a inmigrantes según seguridad subjetiva",
    x = "Percepción de desempleo debido a inmigrantes",
    y = NULL,
    fill = "Seguridad subjetiva"
  ) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
                     breaks = scales::pretty_breaks(n = 10),
                     expand = expansion(mult = c(0, 0.05))) +
  theme(
    axis.text = element_text(size = 18),
    axis.title = element_text(size = 22),
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 22), 
    title = element_text(size = 22)
  ) +
  coord_fixed(ratio = 15/5) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy de acuerdo")
  )
# Agrandar textos theme
```


```{r}
ggplot(elsoc_6, aes(
  x = frecuencia_migrantes, 
  fill = factor(sentido_pertenencia, labels = c("Baja pertenencia", "Alta pertenencia"))
)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = c("Baja pertenencia" = "#E39E05", 
                               "Alta pertenencia" = "#1e55a8")) +
  labs(
    title = "Frecuencia de contacto con inmigrantes según sentido de pertenencia",
    x = "Frecuencia de contacto con inmigrantes",
    y = "Frecuencia",
    fill = "Sentido de pertenencia"
  ) +
  theme_minimal()
```

```{r}
ggplot(elsoc_5, aes(
  x = igualdad_migrantes, 
  fill = factor(comportamiento_prosocial, labels = c("Bajo", "Alto"))
)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = c("Bajo" = "#E39E05", 
                               "Alto" = "#1e55a8")) +
  labs(
    title = "Acceso igualitario a salud con inmigrantes según comportamiento prosocial",
    x = "Acceso igualitario a salud con inmigrantes",
    y = "Frecuencia",
    fill = "Comportamiento prosocial"
  ) +
  theme_minimal()
```

```{r}
ggplot(elsoc_6, aes(x = seguridad_sub, fill = factor(desempleo_migrantes))) +
  geom_bar(position = "fill") +
  labs(
    title = "Frecuencia de desempleo_migrantes según seguridad_sub",
    x = "Seguridad subjetiva",
    y = "Frecuencia",
    fill = "Desempleo migrantes"
  ) +
  theme_minimal()
```

```{r}
ggplot(elsoc_6, aes(x = desempleo_migrantes, fill = factor(seguridad_obj))) +
  geom_bar(position = "fill") +
  labs(
    title = "Proporción de desempleo_migrantes según seguridad objetiva",
    x = "Seguridad objetiva",
    y = "Frecuencia",
    fill = "Desempleo migrantes"
  ) +
  theme_minimal()
```

```{r}
elsoc_5 <- elsoc_5 %>%
  drop_na(desempleo_migrantes, )


```

Cruzar variable de cohesión, migración y filtrado (educación/género)