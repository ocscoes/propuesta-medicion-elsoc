# Cohesión Horizontal: Vínculos Territoriales

```{r}
#| label: set
#| echo: false
#| message: false
#| warning: false

library(knitr)
knitr::opts_chunk$set(echo = FALSE, 
                      include = TRUE, 
                      warning = FALSE, 
                      message = FALSE)

table_format <- if(is_html_output()) {
  "html"
} else if(is_latex_output()) {
  "latex"
}
table_format2 <- if(is_html_output()) {
  T
} else if(is_latex_output()) {
  F
}

options(kableExtra.html.bsTable = T)
options(knitr.kable.NA = "")
```

```{r}
#| label: packages
#| echo: false

if (! require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse,
               sjmisc, 
               here,
               sjlabelled,
               psych,
               rstatix,
               lme4,
               performance,
               sjPlot,
               srvyr,
               ggdist,
               purrr,
               rlang)


options(scipen=999)
rm(list = ls())
```

```{r}
#| label: data
#| echo: false 

elsoc_1 <- readRDS("../../input/data/proc_data/elsoc_2016_coh_mig.RData")
elsoc_2 <- readRDS("../../input/data/proc_data/elsoc_2017_coh_mig.RData")
elsoc_3 <- readRDS("../../input/data/proc_data/elsoc_2018_coh_mig.RData")
elsoc_4 <- readRDS("../../input/data/proc_data/elsoc_2019_coh_mig.RData")
elsoc_5 <- readRDS("../../input/data/proc_data/elsoc_2021_mig.RData")
elsoc_6 <- readRDS("../../input/data/proc_data/elsoc_2022_mig.RData")

# Agregar la variable ola a cada base
elsoc_1 <- elsoc_1 %>% mutate(ola = 1)
elsoc_2 <- elsoc_2 %>% mutate(ola = 2)
elsoc_3 <- elsoc_3 %>% mutate(ola = 3)
elsoc_4 <- elsoc_4 %>% mutate(ola = 4)
elsoc_4 <- elsoc_4 %>% mutate(ola = 4)
elsoc_5 <- elsoc_5 %>% mutate(ola = 5)
elsoc_6 <- elsoc_6 %>% mutate(ola = 6)

# Unir todas las olas en una sola base
elsoc_long <- bind_rows(elsoc_1, elsoc_2, elsoc_3, elsoc_4, elsoc_5, elsoc_6)
```

```{r}
#| label: data-biv
#| echo: false

db_long <- load("../../input/data/proc_data/db_long.RData")
```

```{r}
#| label: db_pond
#| echo: false

db_pond <- db %>% 
  as_survey_design(ids = segmento, 
                   strata = estrato, 
                   weights = ponderador_long_total,
                   nest = T)

```

<!-- Recodificaciones -->

```{r}
#| label: Vinculacion dummy transversal 1
#| echo: false

#PERTENENCIA
elsoc_6_graph <- elsoc_6 %>%
 mutate(
   # Índice promediado
   sentido_pertenencia = rowMeans(
     select(., barrio_ideal, barrio_integracion, barrio_identidad, barrio_pertenencia),
     na.rm = TRUE
   ),
  
   # Recodificación en 3 categorias
   sentido_pertenencia = case_when(
     sentido_pertenencia >= 1 & sentido_pertenencia <= 2.75 ~ 1,
     sentido_pertenencia >= 2.76 & sentido_pertenencia <= 3.75 ~ 2,
     sentido_pertenencia >= 4 & sentido_pertenencia <= 5 ~ 3
   )
 )

# SATISFACCION
elsoc_6_graph <- elsoc_6_graph %>%
 mutate(
   # Índice promediado
   satisfaccion_barrio = rowMeans(
     select(., barrio_amigos, barrio_sociable, barrio_cordial, barrio_colaborador),
     na.rm = TRUE
   ),
  
   # Recodificación en tres categorias
   satisfaccion_barrio = case_when(
     satisfaccion_barrio >= 1 & satisfaccion_barrio <= 2.75 ~ 1,
     satisfaccion_barrio >= 2.76 & satisfaccion_barrio <= 3.75 ~ 2,
     satisfaccion_barrio >= 4 & satisfaccion_barrio <= 5 ~ 3
   )
 )
```


```{r}
#| label: Vinculacion dummy transversal 2
#| echo: false

# PERTENENCIA
elsoc_6_graph_2 <- elsoc_6 %>%
  mutate(
    # Calcular promedio de las variables
    sentido_pertenencia = rowMeans(select(., barrio_ideal, barrio_integracion, barrio_identidad, barrio_pertenencia), na.rm = TRUE))

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(sentido_pertenencia = case_when(
    sentido_pertenencia <= 2.5 ~ 1,
    sentido_pertenencia >= 3   ~ 0
  ))

# SATISFACCION
elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(satisfaccion_barrio = rowMeans(select(., barrio_amigos, barrio_sociable, barrio_cordial, barrio_colaborador), na.rm = TRUE))

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(satisfaccion_barrio = case_when(
    satisfaccion_barrio <= 2.5 ~ 1,
    satisfaccion_barrio >= 3   ~ 0
  ))
```


```{r}
#| echo: false

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(desempleo_migrantes = case_when(
    desempleo_migrantes <= 2 ~ 1,
    desempleo_migrantes == 3  ~ 2,
    desempleo_migrantes >= 4 ~ 3
  ))
```

```{r}
#| echo: false

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(contacto_migrantes = case_when(
    contacto_migrantes <= 2 ~ 1,
    contacto_migrantes == 3  ~ 2,
    contacto_migrantes >= 4 ~ 3
  ))
```

```{r}
#| echo: false

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(simpatia_migrantes = case_when(
    simpatia_migrantes <= 2 ~ 1,
    simpatia_migrantes == 3  ~ 2,
    simpatia_migrantes >= 4 ~ 3
  ))
```

```{r}
#| echo: false

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(igualdad_migrantes = case_when(
    igualdad_migrantes <= 2 ~ 1,
    igualdad_migrantes == 3  ~ 2,
    igualdad_migrantes >= 4 ~ 3
  ))
```

```{r}
#| echo: false

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(perdida_identidad = case_when(
    perdida_identidad <= 2 ~ 1,
    perdida_identidad == 3  ~ 2,
    perdida_identidad >= 4 ~ 3
  ))
```

```{r}
#| echo: false

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  na.omit()
```

```{r}
#| label: sentido de pertenencia dummy longitudinal
#| echo: false

elsoc_long_graph <- elsoc_long %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    sentido_pertenencia = rowMeans(
      cbind(barrio_ideal, barrio_integracion, barrio_identidad, barrio_pertenencia),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    sentido_pertenencia = case_when(
      sentido_pertenencia <= 2.5 ~ 0,
      sentido_pertenencia >= 3   ~ 1,
      TRUE ~ NA_real_  # Para valores entre 2.5 y 3
    ),
    
    # Convertir a factor con labels
    sentido_pertenencia = factor(
      sentido_pertenencia,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

```{r}
#| label: satisfacción con el barrio dummy longitudinal
#| echo: false

elsoc_long_graph <- elsoc_long_graph %>%
  mutate(
    # Índice promediado - especificar las columnas directamente
    satisfaccion_barrio = rowMeans(
      cbind(barrio_amigos, barrio_sociable, barrio_cordial, barrio_colaborador),
      na.rm = TRUE
    ),
    
    # Recodificación en 0/1
    satisfaccion_barrio = case_when(
      satisfaccion_barrio <= 2.5 ~ 0,
      satisfaccion_barrio >= 3   ~ 1,
      TRUE ~ NA_real_  # Para valores entre 2.5 y 3
    ),
    
    # Convertir a factor con labels
    satisfaccion_barrio = factor(
      satisfaccion_barrio,
      levels = c(0, 1),
      labels = c("Bajo", "Alto")
    )
  )
```

## Medición de vínculos territoriales

```{r}
#| label: fig-vinculos
#| fig-cap: Distribución de los índices de vínculos territoriales
#| fig-cap-location: top
#| echo: false
#| fig-width: 12
#| fig-height: 8


# Primero selecciona tus variables
datos_vinculos <- dplyr::select(elsoc_6_graph, sentido_pertenencia, satisfaccion_barrio)


# Crea el gráfico
cohesion_3 <- plot_stackfrq(
 datos_vinculos,
 show.prc = FALSE,
 show.n = FALSE,
 show.total = FALSE,
 axis.labels = c("Sentido de pertenencia", "Satisfacción con el barrio")
) +
 theme_ggdist() +
 theme(
   # Estilo del texto original
   axis.text = element_text(size = 18),
   title = element_text(size = 20),
   legend.text = element_text(size = 16),
  
   # Estilo de la leyenda (adaptado del código de referencia)
   legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
   legend.background = element_rect(fill = "white", color = NA),
   legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
   legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
   legend.position = "bottom",
   legend.direction = "horizontal",
   legend.box = "horizontal",
   legend.title = element_text(face = "bold"),
   legend.key = element_rect(fill = "white", color = NA),
   legend.key.height = unit(12, "pt"),
   legend.key.width = unit(20, "pt")
 ) +
 scale_fill_manual(
   values = c("1" = "#f9913d", "2" = "#7ABA21", "3" = "#2b2f3c"),
   labels = c("1" = "Bajo",
              "2" = "Medio",
              "3" = "Alto")
 ) +
 guides(fill = guide_legend(
   title = NULL,
   title.position = "top",
   label.position = "right",
   nrow = 1,
   byrow = TRUE,
   keywidth = unit(14, "pt"),
   keyheight = unit(10, "pt")
 )) +
 labs(caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2022")


cohesion_3
```

La @fig-vinculos muestra la distribución de los índices que componen la subdimensión de vínculos territoriales. Se puede observar que las personas que sienten baja satisfacción con el barrio son casi equivalentes a la cantidad de quienes poseen un bajo sentido de pertenencia. No obstante, se puede observar una diferencia en las categorías medias, en donde la satisfacción media con el entorno en el que viven es ampliamente mayor a un sentido "medio" de pertenencia barrial. 

```{r}
#| label: fig-long-11
#| fig-cap: "Distribución Subíndices de Vínculo Territorial"
#| fig-cap-location: top
#| echo: false
#| warning: false

# Variables de Vínculos Territorial (índices categóricos)
vars_territorio <- c("sentido_pertenencia", "satisfaccion_barrio")

# Preparar datos para gráfico apilado
long_territorio_stack <- elsoc_long_graph %>%
  select(ola, all_of(vars_territorio)) %>%
  pivot_longer(cols = all_of(vars_territorio), 
               names_to = "variable", 
               values_to = "valor") %>%
  filter(!is.na(valor)) %>%
  group_by(ola, variable, valor) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(ola, variable) %>%
  mutate(
    total = sum(n),
    proporcion = n / total
  ) %>%
  ungroup() %>%
  mutate(
    variable_clean = case_when (
      variable == "sentido_pertenencia" ~ "Sentido de Pertenencia",
      variable == "satisfaccion_barrio" ~ "Satisfacción con el Barrio"
    )
  )

# Vector con años correspondientes a cada ola
anos_olas <- c("2016", "2017", "2018", "2019", "2022", "2023")

# Gráfico de área apilada
ggplot(long_territorio_stack, aes(x = ola, y = proporcion, fill = valor)) +
  geom_area(alpha = 0.7, position = "stack") +
  geom_line(aes(group = interaction(variable, valor)), 
            position = "stack", 
            linewidth = 0.5, 
            color = "white") +
  facet_wrap(~variable_clean, ncol = 2) +
  scale_fill_manual(values = c(
    "Bajo" = "#F9913D",
    "Alto" = "#2B2F3C"
  )) +
  scale_x_continuous(
    breaks = 1:6,
    labels = anos_olas
  ) +
  scale_y_continuous(
    limits = c(0, 1), 
    breaks = seq(0, 1, 0.2),
    labels = scales::percent_format(accuracy = 1)
  ) +
  labs(x = "Año", 
       y = "Proporción", 
       fill = "Nivel",
       caption = "Fuente: Elaboración propia a partir de ELSOC 2019-2023") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background     = element_rect(fill = "white", color = NA),
    legend.margin         = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin     = margin(t = 6, r = 6, b = 6, l = 6),
    
    legend.position       = "bottom",
    legend.direction      = "horizontal",
    legend.box            = "horizontal",
    
    legend.title          = element_text(face = "bold"),
    legend.key            = element_rect(fill = "white", color = NA),
    legend.key.height     = unit(12, "pt"),
    legend.key.width      = unit(20, "pt"),
    
    axis.text  = element_text(size = 11),
    panel.spacing = unit(1, "cm"),   # mantiene separación entre paneles
    plot.caption = element_text(hjust = 0.5, size = 10, color ="black")
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

## Migración y vínculos territoriales 

```{r}
#| label: fig-satbarrio
#| fig-cap: Satisfacción con el barrio y pérdida de identidad del país debido a inmigrantes
#| fig-cap-location: top
#| echo: false 

ggplot(elsoc_6_graph_2, aes(
  x = perdida_identidad, 
  fill = factor(satisfaccion_barrio, labels = c("Alta satisfacción", "Baja satisfacción"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta satisfacción" = "#2b2f3c", "Baja satisfacción" = "#f9913d"),
    breaks = c("Baja satisfacción", "Alta satisfacción"),
    name = "Categorías"
  ) +
  labs(
    x = "Percepción de pérdida de identidad",
    y = "Satisfacción con el barrio",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2022"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

La @fig-satbarrio refleja la asociación entre la percepción de que los inmigrantes le restan identidad al país y el índice de satisfacción con el barrio. Este índice se compuso de cuatro indicadores que miden diversos aspectos sobre el barrio, tales como sociabilidad, colaboración, entre otros (si le interesa profundizar en cómo se construyó este y los demás índices, vaya al [anexo](https://ocscoes.github.io/propuesta-medicion-elsoc/output/book-cohesion-migracion/docs/anexos.html)).

Además, se puede observar en  que en 2022 la mayoría de las personas sienten una alta satisfacción con su barrio. Ahora bien, existe una relación negativa entre percibir la pérdida de identidad del país debido a inmigrantes y la satisfacción con el barrio. Esto es, a medida que disminuye la satisfacción con el barrio, aumenta la sensación de que los inmigrantes flagelan la identidad del país. 

```{r}
#| label: fig-sentper
#| fig-cap: Sentido de pertenencia y pérdida de identidad del país debido a inmigrantes
#| fig-cap-location: top
#| echo: false 

ggplot(elsoc_6_graph_2, aes(
  x = perdida_identidad, 
  fill = factor(sentido_pertenencia, labels = c("Alta pertenencia", "Baja pertenencia"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta pertenencia" = "#2b2f3c", "Baja pertenencia" = "#f9913d"),
    breaks = c("Baja pertenencia", "Alta pertenencia"),
    name = "Categorías"
  ) +
  labs(
    x = "Percepción de pérdida de identidad",
    y = "Sentido de pertenencia",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2022"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

La @fig-sentper grafica la correlación entre la percepción de pérdida de identidad del país a causa de inmigrantes, la cual se representa con las tres categorías de respuesta como barras, y el índice de sentido de pertenencia, presentándose en el relleno de las barras. 

Se puede notar que las tres categorías de acuerdo tienen un grado de similitud bastante alto en cuanto a su distribución, en donde todas las barras contienen un porcentaje casi idéntico. Esto quiere decir que no hay una relación clara entre las personas que tiene bajo sentido de pertenencia al barrio y la percepción respecto a la migración como catalizador del desempleo. 


```{r}
barrio_genero <- elsoc_6_graph_2 %>%
  select(sexo, sentido_pertenencia, satisfaccion_barrio, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, igualdad_migrantes)
```

```{r}
barrio_hombres <- barrio_genero %>%
  filter(sexo==0)

barrio_mujeres <- barrio_genero %>%
  filter(sexo==1)
```

```{r}
barrio_hombres <- barrio_hombres %>%
  select(-c(sexo))

barrio_mujeres <- barrio_mujeres %>%
  select(-c(sexo))
```

```{r}
#| label: fig-terra-gen
#| fig-cap: Sentido de pertenencia y pérdida de identidad por género
#| fig-cap-location: top
#| echo: false 

# Primero necesitas combinar tus datos
# Agrega una columna identificadora a cada dataset
barrio_hombres$grupo <- "Hombres"
barrio_mujeres$grupo <- "Mujeres"

# Combina los datasets
datos_combinados <- rbind(barrio_hombres, barrio_mujeres)

# Crea el gráfico combinado
ggplot(datos_combinados, aes(
  x = perdida_identidad, 
  fill = factor(sentido_pertenencia, labels = c("Alta pertenencia", "Baja pertenencia"))
)) +
  geom_bar(position = "fill") +
  facet_wrap(~grupo, ncol = 2) +
  scale_fill_manual(
    values = c("Alta pertenencia" = "#2b2f3c", "Baja pertenencia" = "#f9913d"),
    breaks = c("Baja pertenencia", "Alta pertenencia"),
    name = "Categorías"
  ) +
  labs(,
    x = "Percepción de pérdida de identidad",
    y = "Sentido de pertenencia",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2022"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de los paneles (tomado del código de referencia)
    strip.text = element_text(size = 12, face = "bold"),
    
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5),
    
    # Separación entre paneles
    panel.spacing = unit(1, "cm")
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

En @fig-terra-gen se puede observar cómo se relaciona el sentido de pertenencia al barrio con la pérdida de identidad debido a la migración, distinguiendo por género. Los hombres tienden a mantener una postura fuertemente polarizada, en donde, quienes tienen un bajo sentido de pertenencia, pueden creer fervientemente que los inmigrantes causan la pérdida de identidad nacional, o bien, están muy en desacuerdo con esta sentencia. Al contrario, las mujeres con bajo sentido de pertenencia, tienden a percibir de manera más moderada la pérdida de identidad nacional a causa de la migración, siendo la categoría neutral la que posee mayor porcentaje de respuesta.


```{r}
barrio_educ <- elsoc_6_graph_2 %>%
  select(educacion, sentido_pertenencia, satisfaccion_barrio, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, igualdad_migrantes)
```

```{r}
barrio_titulo <- barrio_educ %>%
  filter(educacion==1)

barrio_notitulo <- barrio_educ %>%
  filter(educacion==0)
```

```{r}
barrio_titulo <- barrio_titulo %>%
  select(-c(educacion))

barrio_notitulo <- barrio_notitulo %>%
  select(-c(educacion))
```

```{r}
#| label: fig-barrio-educ
#| fig-cap: Sentido de pertenencia y desempleo debido a inmigrantes por nivel educacional
#| fig-cap-location: top
#| echo: false 

# Primero necesitas combinar tus datos
# Agrega una columna identificadora a cada dataset
barrio_titulo$grupo <- "Con título univ."
barrio_notitulo$grupo <- "Sin título univ."

# Combina los datasets
datos_combinados <- rbind(barrio_titulo, barrio_notitulo)

# Crea el gráfico combinado
ggplot(datos_combinados, aes(
  x = desempleo_migrantes, 
  fill = factor(sentido_pertenencia, labels = c("Alta pertenencia", "Baja pertenencia"))
)) +
  geom_bar(position = "fill") +
  facet_wrap(~grupo, ncol = 2) +
  scale_fill_manual(
    values = c("Alta pertenencia" = "#2b2f3c", "Baja pertenencia" = "#f9913d"),
    breaks = c("Baja pertenencia", "Alta pertenencia"),
    name = "Sentido de pertenencia"
  ) +
  labs(
    title = "",
    x = "Percepción de desempleo debido a inmigrantes",
    y = NULL,
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2022"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de los paneles
    strip.text = element_text(size = 12, face = "bold"),
    
    # Estilo de la leyenda
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold", size = 14),
    legend.text = element_text(size = 11),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5),
    
    # Separación entre paneles
    panel.spacing = unit(1, "cm")
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

La @fig-barrio-educ muestra la asociación entre percepción de desempleo debido a inmigrantes y sentido de pertenencia, siendo filtrada por nivel educacional. Al lado izquierdo se ve el gráfico según personas con título universitario, quienes dividen sus respuestas de manera casi equivalente en las categorías extremas, mientras que la categorías neutral es la menos votada por las personas que tienen un bajo sentido de pertenencia. Al lado derecho se ven las personas sin título universitario y, en este caso, sorpresivamente las tres barras se ven casi idénticas, lo que sugiere que, entre las personas que no poseen educación terciaria finalizada, no hay una tendencia clara entre el desempleo percibido a causa de los inmigrantes y el sentido de pertenencia al barrio.

## Migración y vínculos territoriales en el tiempo

```{r}
#| label: plots


# Selección de variables: (1) desempleo por migrantes, (2)pérdida de identidad
# (3)simpatía hacia migrantes, (4)acceso a salud igualitaro y (5) contacto positivo

# plot function
make_plot <- function(design, predictor, outcome, ylab, legend_title) {
  pred_sym <- ensym(predictor)
  out_sym  <- ensym(outcome)
  
  design %>% 
    select(wave, !!pred_sym, !!out_sym) %>% 
    tidyr::drop_na() %>% 
    group_by(wave, !!pred_sym) %>%
    summarise(
      value = survey_mean(!!out_sym, vartype = "ci", na.rm = TRUE),
      .groups = "drop"
    ) %>% 
    ggplot(aes(x = wave, y = value, group = !!pred_sym)) +
    geom_point(aes(color = !!pred_sym), size = 3.5) +
    geom_line(aes(color = !!pred_sym), linewidth = 0.8) +
    # geom_errorbar(aes(ymin = value_low, ymax = value_upp, color = !!pred_sym), width = 0.1) +
    scale_y_continuous(n.breaks = 7) +
    scale_color_manual(
      name = legend_title,
      values = c("#F9913D","#7ABA21", "#2b2f3c")
      ) +
    labs(
      x = "Ola",
      y = ylab,
      caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023 (factores de expansión aplicados)"
    ) +
    theme_ggdist() +
    theme(
      legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
      legend.background     = element_rect(fill = "white", color = NA),
      legend.margin         = margin(t = 6, r = 8, b = 6, l = 8),
      legend.box.margin     = margin(t = 6, r = 6, b = 6, l = 6),
      
      legend.position       = "bottom",
      legend.direction      = "horizontal",
      legend.box            = "horizontal",  # útil si hubiera varias leyendas
      
      legend.title          = element_text(face = "bold"),
      legend.key            = element_rect(fill = "white", color = NA),
      legend.key.height     = unit(12, "pt"),
      legend.key.width      = unit(18, "pt"),
      
      axis.text  = element_text(size = 11)
      ) +
    guides(color = guide_legend(
      title.position = "top",   # título arriba
      label.position = "bottom", # etiquetas a la derecha del símbolo
      nrow = 1, byrow = TRUE,   # una fila (ajusta según ancho)
      keywidth = unit(14, "pt"),
      keyheight = unit(10, "pt")
    ))
}

# combinations

outcomes <- c(
  seguridad_sub           = "Seguridad percibida",
  seguridad_obj           = "Seguridad objetiva",
  confianza_inter         = "Confianza interpersonal",
  comportamiento_prosocial= "Comportamiento prosocial",
  ayuda_economica         = "Ayuda económica",
  sentido_pertenencia     = "Sentido pertenencia barrio",
  satisfaccion_barrio     = "Satisfacción barrio"
)

predictors <- list(
  desempleo_migrantes = "Desempleo percibido por \nmigrantes",
  perdida_identidad   = "Pérdida identidad por \nmigrantes",
  simpatia_migrantes = "Simpatía hacia migrantes",
  igualdad_migrantes = "Acceso a salud igualitario \npara migrantes",
  contacto_migrantes = "Contacto positivo con \nmigrantes"
)

comb <- tidyr::crossing(pred = names(predictors), out = names(outcomes))

# make plots

plots_tbl <- comb %>%
  mutate(
    plot = pmap(
      list(pred, out),
      ~ make_plot(
        design       = db_pond,
        predictor    = ..1,
        outcome      = ..2,
        ylab         = outcomes[..2],
        legend_title = predictors[[..1]]
      )
    ),
    plot_id = paste0("plot_", out, "__by__", pred)
  )
```

```{r}
#| echo: false
#| warning: false
#| message: false
#| out-width: '100%'
#| results: asis
#| label: fig-satis-contacto
#| fig-cap: "Satisfacción con el barrio y frecuencia de contacto positivo con migrantes (2016-2023)"
#| fig-cap-location: top


sel <- plots_tbl %>%
  filter(out  %in% c("sentido_pertenencia", "satisfaccion_barrio")) 

walk(sel[c(1), ]$plot, print)
```


La @fig-pertenencia-contacto muestra la relación entre el sentido de pertenencia barrial y la frecuencia de contacto positivo con migrantes entre 2016 y 2023. En toda la serie, quienes reportan un contacto muy o bastante amistoso con migrantes presentan los niveles más altos de pertenencia barrial, seguidos por quienes señalan un contacto ni amistoso ni no amistoso. En contraste, los niveles más bajos corresponden de manera consistente a quienes declaran tener un contacto muy poco o poco amistoso.

En cuanto a las tendencias, se aprecian trayectorias diferenciadas entre los grupos, aunque con un rasgo común: la caída del sentido de pertenencia entre 2019 y 2023. En el caso de quienes sostienen un contacto amistoso, se observa un crecimiento sostenido hasta 2019, seguido de un descenso posterior. Entre quienes mantienen un contacto poco amistoso, la trayectoria es predominantemente descendente, con una leve alza en 2019 —posiblemente vinculada al contexto del estallido social— y una baja posterior en 2023. Por su parte, el grupo con contacto neutral exhibe un patrón más heterogéneo: una caída en 2017, un repunte entre 2018 y 2019 y, finalmente, una disminución hacia 2023.

```{r}
#| echo: false
#| warning: false
#| message: false
#| out-width: '100%'
#| results: asis
#| label: fig-pertenencia-contacto
#| fig-cap: "Sentido de pertenencia con el barrio y frecuencia de contacto positivo con migrantes (2016-2023)"
#| fig-cap-location: top

walk(sel[c(2), ]$plot, print)
```


La @fig-satis-identi muestra la relación entre la satisfacción barrial y el grado de acuerdo con la afirmación de que la llegada de migrantes provoca una pérdida de identidad nacional entre 2016 y 2023. En términos generales, quienes se declaran ni de acuerdo ni en desacuerdo presentan los niveles más altos de satisfacción con su barrio a lo largo de la serie, seguidos por quienes están en desacuerdo y, finalmente, por quienes están de acuerdo, que exhiben los niveles más bajos.

En cuanto a las trayectorias, el grupo que está de acuerdo con la pérdida de identidad es el único que muestra una tendencia clara y sostenida: desde 2017 hasta 2023 su satisfacción barrial cae de manera consistente. Por su parte, quienes se ubican en la posición intermedia presentan una evolución más errática, con un nivel elevado en 2016, una caída en 2017, un repunte en 2018, una nueva disminución en 2019 y un incremento hacia 2023. Finalmente, entre quienes están en desacuerdo con la afirmación, la satisfacción barrial fluctúa con un aumento inicial entre 2016 y 2017, seguido de una caída en 2018, un nuevo ascenso en 2019 y una baja hacia 2023.

```{r}
#| echo: false
#| warning: false
#| message: false
#| out-width: '100%'
#| results: asis
#| label: fig-satis-identi
#| fig-cap: "Satisfacción con el barrio y pérdida de identidad por migrantes (2016-2023)"
#| fig-cap-location: top

walk(sel[c(7), ]$plot, print)
```

La @fig-satis-simpat muestra la relación entre la satisfacción barrial y el grado de simpatía hacia los migrantes entre 2016 y 2023. En toda la serie, los niveles más altos corresponden a quienes expresan mucha o bastante simpatía, seguidos por quienes declaran simpatizar algo y, finalmente, por quienes reportan muy poca o ninguna simpatía, que muestran los valores más bajos.

En cuanto a las tendencias, se observa una divergencia clara entre los grupos: quienes manifiestan mayor simpatía exhiben un incremento sostenido en su satisfacción barrial a lo largo del período, mientras que quienes muestran bajos niveles de simpatía presentan una trayectoria descendente. Por su parte, el grupo intermedio evidencia una tendencia positiva inicial, pero con una caída marcada entre 2019 y 2023. Estos patrones sugieren que la calidad de las actitudes hacia los migrantes se vincula de manera consistente con la valoración del entorno barrial, reforzando la idea de que disposiciones favorables hacia la diversidad migrante tienden a asociarse con mayores niveles de vinculación territorial.


```{r}
#| echo: false
#| warning: false
#| message: false
#| out-width: '100%'
#| results: asis
#| label: fig-satis-simpat
#| fig-cap: "Satisfacción con el barrio y simpátia hacia migrantes (2016-2023)"
#| fig-cap-location: top

walk(sel[c(9), ]$plot, print)
```
