# Bivariados transversales

Para realizar los cruces de las subdimensiones de la cohesión social con migración, se construyen índices promediados a partir de los indicadores que conforman los constructos validados en la sección anterior. 

::: callout-note
Si bien, en la sección de análisis de constructos estos se entendieron como factores, para efectos prácticos de difusión se decidió aplicar una construcción de índices, ya que esto permite que los valores se mantengan en la escala original en que fueron medidas las variables, lo cual facilita su interpretación al momento de presentar resultados. 
:::

```{r}
#| label: packages
#| echo: false

pacman::p_load(
  dplyr, haven, sjlabelled,  psych,  purrr,  tidyr,  sjPlot,  ggplot2, 
  parameters,  table1,  car,  beeswarm, scales, ggrepel, corrplot,
  ggtext, patchwork, psych, kableExtra, labelled, patchwork, cowplot, ggdist)
```

```{r}
#| label: database ola 6
#| echo: false 

elsoc_6 <- readRDS("../../input/data/proc_data/elsoc_2022_mig.RData")
```

```{r}
#| label: database ola 5 
#| echo: false 

elsoc_5 <- readRDS("../../input/data/proc_data/elsoc_2021_mig.RData")
```

## Visualizaciones 

```{r}
#| label: comportamiento prosocial dummy
#| echo: false
elsoc_5_graph <- elsoc_5 %>%
  mutate(comportamiento_prosocial = rowMeans(select(., reunion_pub, voluntariado), na.rm = TRUE))

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(comportamiento_prosocial = case_when(
    comportamiento_prosocial <= 1.5 ~ 1,
    comportamiento_prosocial >= 2   ~ 0
  ))
```

```{r}
#| label: ayuda economica dummy
#| echo: false
elsoc_5_graph <- elsoc_5_graph %>%
  mutate(ayuda_economica = rowMeans(select(., prestar_dinero, ayuda_trabajo), na.rm = TRUE))

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(ayuda_economica = case_when(
    ayuda_economica <= 1.5 ~ 1,
    ayuda_economica >= 2   ~ 0
  ))
```

```{r}
#| label: confianza interpersonal dummy
#| echo: false
elsoc_5_graph <- elsoc_5_graph %>%
  mutate(confianza_inter = rowMeans(select(., confianza_gen, altruismo_gen), na.rm = TRUE))

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(confianza_inter = case_when(
    confianza_inter <= 1.5 ~ 1,
    confianza_inter >= 2   ~ 0
  ))
```

```{r}
#| label: seguridad subjetiva dummy
#| echo: false

elsoc_6_graph <- elsoc_6 %>%
  mutate(seguridad_sub = rowMeans(select(., seguridad_sat, seguridad_perc), na.rm = TRUE))

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(seguridad_sub = case_when(
    seguridad_sub <= 2.5 ~ 1,
    seguridad_sub >= 3   ~ 0
  ))

```

```{r}
#| label: seguridad objetiva dummy
#| echo: false

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(seguridad_obj = rowMeans(select(., peleas_calle, asaltos, trafico_drogas), na.rm = TRUE))

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(seguridad_obj = case_when(
    seguridad_obj <= 2.5 ~ 1,
    seguridad_obj >= 3   ~ 0
  ))
```

```{r}
#| label: sentido de pertenencia dummy
#| echo: false

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(
    # Calcular promedio de las variables
    sentido_pertenencia = rowMeans(select(., barrio_ideal, barrio_integracion, barrio_identidad, barrio_pertenencia), na.rm = TRUE))

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(sentido_pertenencia = case_when(
    sentido_pertenencia <= 2.5 ~ 1,
    sentido_pertenencia >= 3   ~ 0
  ))
```

```{r}
#| label: satisfacción con el barrio dummy
#| echo: false
elsoc_6_graph <- elsoc_6_graph %>%
  mutate(satisfaccion_barrio = rowMeans(select(., barrio_amigos, barrio_sociable, barrio_cordial, barrio_colaborador), na.rm = TRUE))

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(satisfaccion_barrio = case_when(
    satisfaccion_barrio <= 2.5 ~ 1,
    satisfaccion_barrio >= 3   ~ 0
  ))
```

## Gráficos migración

```{r}
#| echo: false

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(desempleo_migrantes = case_when(
    desempleo_migrantes <= 2 ~ 1,
    desempleo_migrantes == 3  ~ 2,
    desempleo_migrantes >= 4 ~ 3
  ))
```

```{r}
#| echo: false

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(contacto_migrantes = case_when(
    contacto_migrantes <= 2 ~ 1,
    contacto_migrantes == 3  ~ 2,
    contacto_migrantes >= 4 ~ 3
  ))
```

```{r}
#| echo: false

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(simpatia_migrantes = case_when(
    simpatia_migrantes <= 2 ~ 1,
    simpatia_migrantes == 3  ~ 2,
    simpatia_migrantes >= 4 ~ 3
  ))

```

```{r}
#| echo: false

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(igualdad_migrantes = case_when(
    igualdad_migrantes <= 2 ~ 1,
    igualdad_migrantes == 3  ~ 2,
    igualdad_migrantes >= 4 ~ 3
  ))

```

```{r}
#| echo: false

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(perdida_identidad = case_when(
    perdida_identidad <= 2 ~ 1,
    perdida_identidad == 3  ~ 2,
    perdida_identidad >= 4 ~ 3
  ))
```



```{r}
#| echo: false

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(desempleo_migrantes = case_when(
    desempleo_migrantes <= 2 ~ 1,
    desempleo_migrantes == 3  ~ 2,
    desempleo_migrantes >= 4 ~ 3
  ))
```

```{r}
#| echo: false

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(contacto_migrantes = case_when(
    contacto_migrantes <= 2 ~ 1,
    contacto_migrantes == 3  ~ 2,
    contacto_migrantes >= 4 ~ 3
  ))
```

```{r}
#| echo: false

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(simpatia_migrantes = case_when(
    simpatia_migrantes <= 2 ~ 1,
    simpatia_migrantes == 3  ~ 2,
    simpatia_migrantes >= 4 ~ 3
  ))

```

```{r}
#| echo: false

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(igualdad_migrantes = case_when(
    igualdad_migrantes <= 2 ~ 1,
    igualdad_migrantes == 3  ~ 2,
    igualdad_migrantes >= 4 ~ 3
  ))

```

```{r}
#| echo: false

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(perdida_identidad = case_when(
    perdida_identidad <= 2 ~ 1,
    perdida_identidad == 3  ~ 2,
    perdida_identidad >= 4 ~ 3
  ))
```

```{r}
#| label: fig-migracion
#| fig-cap: Descriptivos de migración
#| fig-cap-location: top
#| echo: false
#| fig-width: 14
#| fig-height: 8

# Primero selecciona tus variables
datos_migracion <- dplyr::select(elsoc_6_graph, perdida_identidad, desempleo_migrantes, 
                                simpatia_migrantes, igualdad_migrantes, contacto_migrantes)

# Asigna las etiquetas usando labelled
datos_migracion <- datos_migracion %>%
  set_variable_labels(
    perdida_identidad = "Pérdida de \n identidad del país",
    desempleo_migrantes = "Desempleo \n debido a inmigrantes", 
    simpatia_migrantes = "Simpatía \n hacia inmigrantes",
    igualdad_migrantes = "Igualdad \n en acceso a salud",
    contacto_migrantes = "Contacto \n con inmigrantes"
  )

# Crea el gráfico
desc_migracion <- plot_stackfrq(
  datos_migracion,
  title = "Distribución de variables de migración",
  show.prc = FALSE,
  show.n = FALSE,
  show.total = FALSE
) +
  theme_ggdist() + 
    theme(
    # Estilo del texto original
    axis.text = element_text(size = 18),
    title = element_text(size = 20),
    legend.text = element_text(size = 16),
    
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt")
  ) +
  scale_fill_manual(
    values = c("1" = "#f9913d", "2" = "#7ABA21", "3" = "#2b2f3c"),
    labels = c("1" = "Muy en desacuerdo",
               "2" = "Ni en desacuerdo \n ni de acuerdo", 
               "3" = "Muy de acuerdo")
  ) +
  guides(fill = guide_legend(
    title = NULL,
    title.position = "top",
    label.position = "right",
    nrow = 1, 
    byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))

desc_migracion
```

# Transversales por subdimensión

```{r}
#| echo: false 

elsoc_6_graph <- elsoc_6_graph %>%
  na.omit()
```

## Seguridad transversal
```{r}
#| label: fig-segsub
#| fig-cap: Asociación entre percepción de desempleo y seguridad subjetiva
#| fig-cap-location: top
#| echo: false 

ggplot(elsoc_6_graph, aes(
  x = desempleo_migrantes, 
  fill = factor(seguridad_sub, labels = c("Alta seguridad", "Poca seguridad"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta seguridad" = "#2b2f3c", "Poca seguridad" = "#f9913d"),
    breaks = c("Alta seguridad", "Poca seguridad"),
    name = "Categorías"
  ) +
  labs(
    title = "Percepción de desempleo \n debido a inmigrantes según seguridad subjetiva",
    x = "Percepción de desempleo debido a inmigrantes",
    y = "Seguridad subjetiva",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

```{r}
#| label: fig-seg-trans
#| fig-cap: Seguridad objetiva y pérdida identidad 
#| fig-cap-location: top
#| echo: false 

ggplot(elsoc_6_graph, aes(
  x = perdida_identidad, 
  fill = factor(seguridad_obj, labels = c("Alta seguridad", "Poca seguridad"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta seguridad" = "#2b2f3c", "Poca seguridad" = "#f9913d"),
    breaks = c("Alta seguridad", "Poca seguridad"),
    name = "Categorías"
  ) +
  labs(
    title = "Pérdida de identidad del país \n debido a inmigrantes según seguridad objetiva",
    x = "Percepción de pérdida de identidad",
    y = "Seguridad objetiva",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

En @fig-seg-trans se puede apreciar que las cantidad de personas que viven niveles bajos de seguridad aumenta progresivamente a medida que se está más de acuerdo con que los inmigrantes le restan identidad al país. Por tanto, mientras menos seguras están las personas, se está más convencido de que los inmigrantes erosionan la identidad de Chile.

## Vínculos territoriales transversal

```{r}
#| label: fig-satbarrio
#| fig-cap: Asociación entre percepción de pérdida de identidad y satisfacción con el barrio
#| fig-cap-location: top
#| echo: false 

ggplot(elsoc_6_graph, aes(
  x = perdida_identidad, 
  fill = factor(satisfaccion_barrio, labels = c("Alta satisfacción", "Poca satisfacción"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta satisfacción" = "#2b2f3c", "Poca satisfacción" = "#f9913d"),
    breaks = c("Alta satisfacción", "Poca satisfacción"),
    name = "Categorías"
  ) +
  labs(
    title = "Percepción de pérdida de identidad del país \n debido a inmigrantes según satisfacción con el barrio",
    x = "Percepción de pérdida de identidad",
    y = "Satisfacción con el barrio",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

Se puede observar en @fig-satbarrio que en 2022 la mayoría de las personas sienten una alta satisfacción con su barrio. Ahora bien, existe una relación negativa entre percibir la pérdida de identidad del país debido a inmigrantes y la satisfacción con el barrio. Esto es, a medida que disminuye la satisfacción con el barrio, aumenta la sensación de que los inmigrantes flagelan la identidad del país. 

```{r}
#| label: fig-sentper
#| fig-cap: Asociación entre percepción de pérdida de identidad y sentido de pertenencia
#| fig-cap-location: top
#| echo: false 

ggplot(elsoc_6_graph, aes(
  x = perdida_identidad, 
  fill = factor(satisfaccion_barrio, labels = c("Alta pertenencia", "Baja pertenencia"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta pertenencia" = "#2b2f3c", "Baja pertenencia" = "#f9913d"),
    breaks = c("Alta pertenencia", "Baja pertenencia"),
    name = "Categorías"
  ) +
  labs(
    title = "Percepción de pérdida de identidad del país \n debido a inmigrantes según sentido de pertenencia",
    x = "Percepción de pérdida de identidad",
    y = "Sentido de pertenencia",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

## Redes sociales transversal

```{r}
#| label: fig-prosoc
#| fig-cap: Asociación entre percepción de desempleo y comportamiento prosocial
#| fig-cap-location: top
#| echo: false 

elsoc_5_graph <- elsoc_5_graph %>%
  drop_na(desempleo_migrantes, perdida_identidad)

ggplot(elsoc_5_graph, aes(
  x = desempleo_migrantes, 
  fill = factor(comportamiento_prosocial, labels = c("Alto", "Bajo"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alto" = "#2b2f3c", "Bajo" = "#f9913d"),
    breaks = c("Alto", "Bajo"),
    name = "Categorías"
  ) +
  labs(
    title = "Percepción de desempleo \n debido a inmigrantes según comportamiento prosocial",
    x = "Percepción de desempleo",
    y = "Comportamiento prosocial",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

En @fig-prosoc se nota una tendencia de las personas a tener un bajo comportamiento prosocial, cuyo porcentaje es mayoría en las tres barras. Con mayor profundidad, se puede afirmar una asociación negativa entre la percepción de desempleo por la migración y el comportamiento prosocial. En otras palabras, mientras el comportamiento social es más bajo, se considera en mayor medida que los inmigrantes causan desempleo en el país. 

```{r}
#| label: fig-confinter
#| fig-cap: Asociación entre percepción de desempleo debido a inmigrantes y confianza interpersonal
#| fig-cap-location: top
#| echo: false 

ggplot(elsoc_5_graph, aes(
  x = desempleo_migrantes, 
  fill = factor(confianza_inter, labels = c("Alta confianza", "Baja confianza"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta confianza" = "#2b2f3c", "Baja confianza" = "#f9913d"),
    breaks = c("Alta confianza", "Baja confianza"),
    name = "Categorías"
  ) +
  labs(
    title = "% de percepción de desempleo \n debido a inmigrantes según confianza interpersonal",
    x = "Percepción de desempleo",
    y = "Confianza interpersonal",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

En @fig-ayudaeco se observa un patrón bastante similar al anterior, en donde la disminución  empleos disponibles por migración se correlaciona negativamente con confianza interpersonal. Es relevante señalar que persiste una diferencia muy tenue entre la categoría "muy en desacuerdo" y "ni en desacuerdo ni de acuerdo", mientras que la disparidad más marcada se percibe al comparar las dos categorías anteriores con el máximo grado de acuerdo.

```{r}
#| label: fig-ayudaeco
#| fig-cap: Asociación entre percepción de pérdida de identidad y ayuda económica
#| fig-cap-location: top
#| echo: false 

ggplot(elsoc_5_graph, aes(
  x = perdida_identidad, 
  fill = factor(ayuda_economica, labels = c("Mucha ayuda", "Poca ayuda"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Mucha ayuda" = "#2b2f3c", "Poca ayuda" = "#f9913d"),
    breaks = c("Mucha ayuda", "Poca ayuda"),
    name = "Categorías"
  ) +
  labs(
    title = "% de percepción de pérdida de identidad del país \n debido a inmigrantes según ayuda económica a terceros",
    x = "Pérdida de identidad",
    y = "Ayuda económica",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

# Cruces filtrados (género/educación)

## Seguridad por género

```{r}
seguridad_genero <- elsoc_6_graph %>%
  select(sexo, seguridad_obj, seguridad_sub, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, igualdad_migrantes)
```

```{r}
seguridad_hombres <- seguridad_genero %>%
  filter(sexo==0)

seguridad_mujeres <- seguridad_genero %>%
  filter(sexo==1)
```

```{r}
seguridad_hombres <- seguridad_hombres %>%
  select(-c(sexo))

seguridad_mujeres <- seguridad_mujeres %>%
  select(-c(sexo))
```


```{r}
#| label: fig-seginteract
#| fig-cap: Seguridad objetiva y pérdida de identidad por género
#| fig-cap-location: top
#| echo: false 

# Primero necesitas combinar tus datos
# Agrega una columna identificadora a cada dataset
seguridad_hombres$grupo <- "Hombres"
seguridad_mujeres$grupo <- "Mujeres"

# Combina los datasets
datos_combinados <- rbind(seguridad_hombres, seguridad_mujeres)

# Crea el gráfico combinado
ggplot(datos_combinados, aes(
  x = perdida_identidad, 
  fill = factor(seguridad_obj, labels = c("Alta seguridad", "Poca seguridad"))
)) +
  geom_bar(position = "fill") +
  facet_wrap(~grupo, ncol = 2) +
  scale_fill_manual(
    values = c("Alta seguridad" = "#2b2f3c", "Poca seguridad" = "#f9913d"),
    breaks = c("Alta seguridad", "Poca seguridad"),
    name = "Categorías"
  ) +
  labs(
    title = "Pérdida de identidad del país debido a inmigrantes según seguridad objetiva",
    x = "Percepción de pérdida de identidad",
    y = "Seguridad objetiva",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de los paneles (tomado del código de referencia)
    strip.text = element_text(size = 12, face = "bold"),
    
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5),
    
    # Separación entre paneles
    panel.spacing = unit(1, "cm")
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

 @fig-seginteract refleja la asociación entre seguridad objetiva y percepción de pérdida de identidad del país a causa de los inmigrantes, lo cual está graficado por hombres y mujeres. Se puede observar que, en el caso de los hombres, las categorías más polarizadas concentran la mayoría de las respuestas, por lo que no hay un patrón muy claro. En cambio, a medida que las mujeres viven en entornos menos seguros, están más de acuerdo con que el país pierde identidad a causa de los inmigrantes.

## Seguridad por educación

```{r}
seguridad_educ <- elsoc_6_graph %>%
  select(educacion, seguridad_obj, seguridad_sub, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, igualdad_migrantes)
```

```{r}
seguridad_titulo <- seguridad_educ %>%
  filter(educacion==1)

seguridad_notitulo <- seguridad_educ %>%
  filter(educacion==0)
```

```{r}
seguridad_titulo <- seguridad_titulo %>%
  select(-c(educacion))

seguridad_notitulo <- seguridad_notitulo %>%
  select(-c(educacion))
```

```{r}
# Primero necesitas combinar tus datos
# Agrega una columna identificadora a cada dataset
seguridad_titulo$grupo <- "Con título univ."
seguridad_notitulo$grupo <- "Sin título univ."

# Combina los datasets
datos_combinados <- rbind(seguridad_titulo, seguridad_notitulo)

# Crea el gráfico combinado
ggplot(datos_combinados, aes(
  x = desempleo_migrantes, 
  fill = factor(seguridad_obj, labels = c("Alta seguridad", "Poca seguridad"))
)) +
  geom_bar(position = "fill") +
  facet_wrap(~grupo, ncol = 2) +
  scale_fill_manual(
    values = c("Alta seguridad" = "#2b2f3c", "Poca seguridad" = "#f9913d"),
    breaks = c("Alta seguridad", "Poca seguridad"),
    name = "Seguridad objetiva"
  ) +
  labs(
    title = "Percepción de desempleo debido a inmigrantes según seguridad objetiva",
    x = "Percepción de desempleo debido a inmigrantes",
    y = NULL,
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de los paneles
    strip.text = element_text(size = 12, face = "bold"),
    
    # Estilo de la leyenda
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold", size = 14),
    legend.text = element_text(size = 11),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5),
    
    # Separación entre paneles
    panel.spacing = unit(1, "cm")
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

## Vínculos territoriales por género

```{r}
barrio_genero <- elsoc_6_graph %>%
  select(sexo, sentido_pertenencia, satisfaccion_barrio, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, igualdad_migrantes)
```

```{r}
barrio_hombres <- barrio_genero %>%
  filter(sexo==0)

barrio_mujeres <- barrio_genero %>%
  filter(sexo==1)
```

```{r}
barrio_hombres <- barrio_hombres %>%
  select(-c(sexo))

barrio_mujeres <- barrio_mujeres %>%
  select(-c(sexo))
```

```{r}
#| label: fig-terra-gen
#| fig-cap: Sentido de pertenencia y pérdida de identidad por género
#| fig-cap-location: top
#| echo: false 

# Primero necesitas combinar tus datos
# Agrega una columna identificadora a cada dataset
barrio_hombres$grupo <- "Hombres"
barrio_mujeres$grupo <- "Mujeres"

# Combina los datasets
datos_combinados <- rbind(barrio_hombres, barrio_mujeres)

# Crea el gráfico combinado
ggplot(datos_combinados, aes(
  x = perdida_identidad, 
  fill = factor(sentido_pertenencia, labels = c("Alta pertenencia", "Baja pertenencia"))
)) +
  geom_bar(position = "fill") +
  facet_wrap(~grupo, ncol = 2) +
  scale_fill_manual(
    values = c("Alta pertenencia" = "#2b2f3c", "Baja pertenencia" = "#f9913d"),
    breaks = c("Alta pertenencia", "Baja pertenencia"),
    name = "Categorías"
  ) +
  labs(
    title = "Pérdida de identidad del país debido a inmigrantes según sentido de pertenencia",
    x = "Percepción de pérdida de identidad",
    y = "Sentido de pertenencia",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de los paneles (tomado del código de referencia)
    strip.text = element_text(size = 12, face = "bold"),
    
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5),
    
    # Separación entre paneles
    panel.spacing = unit(1, "cm")
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

En @fig-terra-gen se puede observar cómo se relaciona el sentido de pertenencia al barrio con la pérdida de identidad debido a la migración, distinguiendo por género. Los hombres tienden a mantener una postura fuertemente polarizada, en donde, quienes tienen un bajo sentido de pertenencia, pueden creer fervientemente que los inmigrantes causan la pérdida de identidad nacional, o bien, están muy en desacuerdo con esta sentencia. Al contrario, las mujeres con bajo sentido de pertenencia, tienden a percibir de manera más moderada la pérdida de identidad nacional a causa de la migración, siendo la categoría neutral la que posee mayor porcentaje de respuesta.

## Vínculos territoriales por educación

```{r}
barrio_educ <- elsoc_6_graph %>%
  select(educacion, sentido_pertenencia, satisfaccion_barrio, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, igualdad_migrantes)
```

```{r}
barrio_titulo <- barrio_educ %>%
  filter(educacion==1)

barrio_notitulo <- barrio_educ %>%
  filter(educacion==0)
```

```{r}
barrio_titulo <- barrio_titulo %>%
  select(-c(educacion))

barrio_notitulo <- barrio_notitulo %>%
  select(-c(educacion))
```

```{r}
# Primero necesitas combinar tus datos
# Agrega una columna identificadora a cada dataset
barrio_titulo$grupo <- "Con título univ."
barrio_notitulo$grupo <- "Sin título univ."

# Combina los datasets
datos_combinados <- rbind(barrio_titulo, barrio_notitulo)

# Crea el gráfico combinado
ggplot(datos_combinados, aes(
  x = desempleo_migrantes, 
  fill = factor(sentido_pertenencia, labels = c("Alta pertenencia", "Baja pertenencia"))
)) +
  geom_bar(position = "fill") +
  facet_wrap(~grupo, ncol = 2) +
  scale_fill_manual(
    values = c("Alta pertenencia" = "#2b2f3c", "Baja pertenencia" = "#f9913d"),
    breaks = c("Alta pertenencia", "Baja pertenencia"),
    name = "Sentido de pertenencia"
  ) +
  labs(
    title = "Percepción de desempleo debido a inmigrantes según sentido de pertenencia",
    x = "Percepción de desempleo debido a inmigrantes",
    y = NULL,
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de los paneles
    strip.text = element_text(size = 12, face = "bold"),
    
    # Estilo de la leyenda
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold", size = 14),
    legend.text = element_text(size = 11),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5),
    
    # Separación entre paneles
    panel.spacing = unit(1, "cm")
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

## Redes sociales por género

```{r}
redes_genero <- elsoc_5_graph %>%
  select(sexo, comportamiento_prosocial, ayuda_economica, confianza_inter, contacto_migrantes, simpatia_migrantes, perdida_identidad, desempleo_migrantes, igualdad_migrantes)
```

```{r}
redes_hombres <- redes_genero %>%
  filter(sexo==0)

redes_mujeres <- redes_genero %>%
  filter(sexo==1)
```

```{r}
redes_hombres <- redes_hombres %>%
  select(-c(sexo))

redes_mujeres <- redes_mujeres %>%
  select(-c(sexo))
```

```{r}
# Primero necesitas combinar tus datos
# Agrega una columna identificadora a cada dataset
redes_hombres$grupo <- "Hombres"
redes_mujeres$grupo <- "Mujeres"

# Combina los datasets
datos_combinados <- rbind(redes_hombres, redes_mujeres)

# Crea el gráfico combinado
ggplot(datos_combinados, aes(
  x = desempleo_migrantes, 
  fill = factor(confianza_inter, labels = c("Alta confianza", "Baja confianza"))
)) +
  geom_bar(position = "fill") +
  facet_wrap(~grupo, ncol = 2) +
  scale_fill_manual(
    values = c("Alta confianza" = "#2b2f3c", "Baja confianza" = "#f9913d"),
    breaks = c("Alta confianza", "Baja confianza"),
    name = "Confianza interpersonal"
  ) +
  labs(
    title = "Percepción de desempleo debido a inmigrantes según confianza interpersonal",
    x = "Percepción de desempleo debido a inmigrantes",
    y = NULL,
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de los paneles
    strip.text = element_text(size = 12, face = "bold"),
    
    # Estilo de la leyenda
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold", size = 14),
    legend.text = element_text(size = 11),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5),
    
    # Separación entre paneles
    panel.spacing = unit(1, "cm")
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

## Redes sociales por educación

```{r}
redes_educ <- elsoc_5_graph %>%
  select(educacion, comportamiento_prosocial, ayuda_economica, confianza_inter, contacto_migrantes, simpatia_migrantes, perdida_identidad, desempleo_migrantes, igualdad_migrantes)
```

```{r}
redes_titulo <- redes_educ %>%
  filter(educacion==1)

redes_notitulo <- redes_educ %>%
  filter(educacion==0)
```

```{r}
redes_titulo <- redes_titulo %>%
  select(-c(educacion))

redes_notitulo <- redes_notitulo %>%
  select(-c(educacion))
```

```{r}
# Primero necesitas combinar tus datos
# Agrega una columna identificadora a cada dataset
redes_titulo$grupo <- "Con título univ."
redes_notitulo$grupo <- "Sin título univ."

# Combina los datasets
datos_combinados <- rbind(redes_titulo, redes_notitulo)

# Crea el gráfico combinado
ggplot(datos_combinados, aes(
  x = desempleo_migrantes, 
  fill = factor(confianza_inter, labels = c("Alta confianza", "Baja confianza"))
)) +
  geom_bar(position = "fill") +
  facet_wrap(~grupo, ncol = 2) +
  scale_fill_manual(
    values = c("Alta confianza" = "#2b2f3c", "Baja confianza" = "#f9913d"),
    breaks = c("Alta confianza", "Baja confianza"),
    name = "Confianza interpersonal"
  ) +
  labs(
    title = "Percepción de desempleo debido a inmigrantes según confianza interpersonal",
    x = "Percepción de desempleo debido a inmigrantes",
    y = NULL,
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de los paneles
    strip.text = element_text(size = 12, face = "bold"),
    
    # Estilo de la leyenda
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold", size = 14),
    legend.text = element_text(size = 11),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5),
    
    # Separación entre paneles
    panel.spacing = unit(1, "cm")
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

# Gráficos seleccionados

```{r}
#| label: fig-seg-tran
#| fig-cap: Seguridad objetiva y pérdida identidad 
#| fig-cap-location: top
#| echo: false 

ggplot(elsoc_6_graph, aes(
  x = perdida_identidad, 
  fill = factor(seguridad_obj, labels = c("Alta seguridad", "Poca seguridad"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta seguridad" = "#2b2f3c", "Poca seguridad" = "#f9913d"),
    breaks = c("Alta seguridad", "Poca seguridad"),
    name = "Categorías"
  ) +
  labs(
    title = "Pérdida de identidad del país \n debido a inmigrantes según seguridad objetiva",
    x = "Percepción de pérdida de identidad",
    y = "Seguridad objetiva",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

En @fig-seg-trans se puede apreciar que las cantidad de personas que viven niveles bajos de seguridad aumenta progresivamente a medida que se está más de acuerdo con que los inmigrantes le restan identidad al país. Por tanto, mientras menos seguras están las personas, se está más convencido de que los inmigrantes erosionan la identidad de Chile.

```{r}
#| label: fig-seginterac
#| fig-cap: Seguridad objetiva y pérdida de identidad por género
#| fig-cap-location: top
#| echo: false 

# Primero necesitas combinar tus datos
# Agrega una columna identificadora a cada dataset
seguridad_hombres$grupo <- "Hombres"
seguridad_mujeres$grupo <- "Mujeres"

# Combina los datasets
datos_combinados <- rbind(seguridad_hombres, seguridad_mujeres)

# Crea el gráfico combinado
ggplot(datos_combinados, aes(
  x = perdida_identidad, 
  fill = factor(seguridad_obj, labels = c("Alta seguridad", "Poca seguridad"))
)) +
  geom_bar(position = "fill") +
  facet_wrap(~grupo, ncol = 2) +
  scale_fill_manual(
    values = c("Alta seguridad" = "#2b2f3c", "Poca seguridad" = "#f9913d"),
    breaks = c("Alta seguridad", "Poca seguridad"),
    name = "Categorías"
  ) +
  labs(
    title = "Pérdida de identidad del país debido a inmigrantes según seguridad objetiva",
    x = "Percepción de pérdida de identidad",
    y = "Seguridad objetiva",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de los paneles (tomado del código de referencia)
    strip.text = element_text(size = 12, face = "bold"),
    
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5),
    
    # Separación entre paneles
    panel.spacing = unit(1, "cm")
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

 @fig-seginteract refleja la asociación entre seguridad objetiva y percepción de pérdida de identidad del país a causa de los inmigrantes, lo cual está graficado por hombres y mujeres. Se puede observar que, en el caso de los hombres, las categorías más polarizadas concentran la mayoría de las respuestas, por lo que no hay un patrón muy claro. En cambio, a medida que las mujeres viven en entornos menos seguros, están más de acuerdo con que el país pierde identidad a causa de los inmigrantes. 

```{r}
#| label: fig-terra-genn
#| fig-cap: Sentido de pertenencia y pérdida de identidad por género
#| fig-cap-location: top
#| echo: false 

# Primero necesitas combinar tus datos
# Agrega una columna identificadora a cada dataset
barrio_hombres$grupo <- "Hombres"
barrio_mujeres$grupo <- "Mujeres"

# Combina los datasets
datos_combinados <- rbind(barrio_hombres, barrio_mujeres)

# Crea el gráfico combinado
ggplot(datos_combinados, aes(
  x = perdida_identidad, 
  fill = factor(sentido_pertenencia, labels = c("Alta pertenencia", "Baja pertenencia"))
)) +
  geom_bar(position = "fill") +
  facet_wrap(~grupo, ncol = 2) +
  scale_fill_manual(
    values = c("Alta pertenencia" = "#2b2f3c", "Baja pertenencia" = "#f9913d"),
    breaks = c("Alta pertenencia", "Baja pertenencia"),
    name = "Categorías"
  ) +
  labs(
    title = "Pérdida de identidad del país debido a inmigrantes según sentido de pertenencia",
    x = "Percepción de pérdida de identidad",
    y = "Sentido de pertenencia",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de los paneles (tomado del código de referencia)
    strip.text = element_text(size = 12, face = "bold"),
    
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5),
    
    # Separación entre paneles
    panel.spacing = unit(1, "cm")
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

En @fig-terra-gen se puede observar cómo se relaciona el sentido de pertenencia al barrio con la pérdida de identidad debido a la migración, distinguiendo por género. Los hombres tienden a mantener una postura fuertemente polarizada, en donde, quienes tienen un bajo sentido de pertenencia, pueden creer fervientemente que los inmigrantes causan la pérdida de identidad nacional, o bien, están muy en desacuerdo con esta sentencia. Al contrario, las mujeres con bajo sentido de pertenencia, tienden a percibir de manera más moderada la pérdida de identidad nacional a causa de la migración, siendo la categoría neutral la que posee mayor porcentaje de respuesta. 

```{r}
#| label: fig-conf-trans
#| fig-cap: Confianza interpersonal y percepción de desempleo
#| fig-cap-location: top
#| echo: false 

elsoc_5_graph <- elsoc_5_graph %>%
  drop_na(desempleo_migrantes, confianza_inter)

ggplot(elsoc_5_graph, aes(
  x = desempleo_migrantes, 
  fill = factor(confianza_inter, labels = c("Alta confianza", "Baja confianza"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta confianza" = "#2b2f3c", "Baja confianza" = "#f9913d"),
    breaks = c("Alta confianza", "Baja confianza"),
    name = "Categorías"
  ) +
  labs(
    title = "Percepción de desempleo debido a inmigrantes según confianza interpersonal",
    x = "Percepción de desempleo",
    y = "Confianza interpersonal",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
  theme(
    # Estilo de la leyenda (adaptado del código de referencia)
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background = element_rect(fill = "white", color = NA),
    legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_text(face = "bold"),
    legend.key = element_rect(fill = "white", color = NA),
    legend.key.height = unit(12, "pt"),
    legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
    axis.title.x = element_text(size = 12, margin = margin(t = 20)),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size = 12, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "right",
    nrow = 1, byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))
```

En primer lugar, en @fig-conf-trans se observa que la gran mayoría de las personas suele tener un bajo nivel de confianza interpersonal, donde el área naranja es superior a la negra en las tres barras. Asimismo, la relación entre las variables indica que, el hecho de confiar menos en terceros lleva a las personas a estar más de acuerdo respecto a que el desempleo en el país es responsabilidad de los inmigrantes. 

```{r}
#| label: fig-conf-educ
#| fig-cap: Confianza interpersonal y percepción de desempleo por nivel educacional
#| fig-cap-location: top
#| echo: false 

# Primero necesitas combinar tus datos
# Agrega una columna identificadora a cada dataset
redes_titulo$grupo <- "Titulados"
redes_notitulo$grupo <- "No titulados"

# Combina los datasets
datos_combinados <- rbind(redes_titulo, redes_notitulo)

# Crea el gráfico combinado
ggplot(datos_combinados, aes(
  x = desempleo_migrantes, 
  fill = factor(confianza_inter, labels = c("Alta confianza", "Baja confianza"))
)) +
  geom_bar(position = "fill") +
  facet_wrap(~grupo, ncol = 2) +
  scale_fill_manual(
    values = c("Alta confianza" = "#2b2f3c", "Baja confianza" = "#f9913d"),
    breaks = c("Alta confianza", "Baja confianza"),
    name = "Categorías"
  ) +
  labs(
    title = "Percepción de desempleo debido a inmigrantes según confianza interpersonal",
    x = "Percepción de desempleo",
    y = "Confianza interpersonal",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 5),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme_ggdist() +
    theme(
    # Estilo de los paneles (tomado del código de referencia)
      strip.text = element_text(size = 12, face = "bold"),
    
    # Estilo de la leyenda (adaptado del código de referencia)
      legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
      legend.background = element_rect(fill = "white", color = NA),
      legend.margin = margin(t = 6, r = 8, b = 6, l = 8),
      legend.box.margin = margin(t = 6, r = 6, b = 6, l = 6),
      legend.position = "bottom",
      legend.direction = "horizontal",
      legend.box = "horizontal",
      legend.title = element_text(face = "bold"),
      legend.key = element_rect(fill = "white", color = NA),
      legend.key.height = unit(12, "pt"),
      legend.key.width = unit(20, "pt"),
    
    # Estilo del texto
      axis.title.x = element_text(size = 12, margin = margin(t = 20)),
      axis.text.x = element_text(size = 9),
      axis.text.y = element_text(size = 11),
      axis.title.y = element_text(size = 12),
      plot.title = element_text(size = 12, hjust = 0.5),
    
    # Separación entre paneles
      panel.spacing = unit(1, "cm")
    ) +
    guides(fill = guide_legend(
      title.position = "top",
      label.position = "right",
      nrow = 1, byrow = TRUE,
      keywidth = unit(14, "pt"),
      keyheight = unit(10, "pt")
    ))
```

@fig-conf-educ grafica la relación entre confianza interpersonal y percepción de desempleo debido a inmigrantes, moderando por personas con y sin título universitario. Ambas figuras mantienen un patrón idéntico, donde, a menor confianza interpersonal, más acuerdo hay en que los inmigrantes aumentan el desempleo en Chile. No obstante, las personas sin título mantienen una relación más acentuada entre desconfianza hacia terceros y percepción de desempleo en comparación con las personas con carrera universitaria finalizada.