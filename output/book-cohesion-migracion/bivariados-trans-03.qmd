# Bivariados transversales

Para realizar los cruces de las subdimensiones de la cohesión social con migración, se construyen índices promediados a partir de los indicadores que conforman los constructos validados en la sección anterior. 

::: callout-note
Si bien, en la sección de análisis de constructos estos se entendieron como factores, para efectos prácticos de difusión se decidió aplicar una construcción de índices, ya que esto permite que los valores se mantengan en la escala original en que fueron medidas las variables, lo cual facilita su interpretación al momento de presentar resultados. 
:::

```{r}
#| label: packages
#| echo: false

pacman::p_load(
  dplyr, haven, sjlabelled,  psych,  purrr,  tidyr,  sjPlot,  ggplot2, 
  parameters,  table1,  car,  beeswarm, scales, ggrepel, corrplot,
  ggtext, patchwork, psych, kableExtra, labelled, patchwork)
```

```{r}
#| label: database ola 6
#| echo: false 

elsoc_6 <- readRDS("../../input/data/proc_data/elsoc_2022_mig.RData")
```

```{r}
#| label: database ola 5 
#| echo: false 

elsoc_5 <- readRDS("../../input/data/proc_data/elsoc_2021_mig.RData")
```

## Visualizaciones 

```{r}
#| label: comportamiento prosocial dummy
#| echo: false
elsoc_5_graph <- elsoc_5 %>%
  mutate(comportamiento_prosocial = rowMeans(select(., reunion_pub, voluntariado), na.rm = TRUE))

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(comportamiento_prosocial = case_when(
    comportamiento_prosocial <= 1.5 ~ 1,
    comportamiento_prosocial >= 2   ~ 0
  ))
```

```{r}
#| label: ayuda economica dummy
#| echo: false
elsoc_5_graph <- elsoc_5_graph %>%
  mutate(ayuda_economica = rowMeans(select(., prestar_dinero, ayuda_trabajo), na.rm = TRUE))

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(ayuda_economica = case_when(
    ayuda_economica <= 1.5 ~ 1,
    ayuda_economica >= 2   ~ 0
  ))
```

```{r}
#| label: confianza interpersonal dummy
#| echo: false
elsoc_5_graph <- elsoc_5_graph %>%
  mutate(confianza_inter = rowMeans(select(., confianza_gen, altruismo_gen), na.rm = TRUE))

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(confianza_inter = case_when(
    confianza_inter <= 1.5 ~ 1,
    confianza_inter >= 2   ~ 0
  ))
```

```{r}
#| label: seguridad subjetiva dummy
#| echo: false

elsoc_6_graph <- elsoc_6 %>%
  mutate(seguridad_sub = rowMeans(select(., seguridad_sat, seguridad_perc), na.rm = TRUE))

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(seguridad_sub = case_when(
    seguridad_sub <= 2.5 ~ 1,
    seguridad_sub >= 3   ~ 0
  ))

```

```{r}
#| label: seguridad objetiva dummy
#| echo: false

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(seguridad_obj = rowMeans(select(., peleas_calle, asaltos, trafico_drogas), na.rm = TRUE))

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(seguridad_obj = case_when(
    seguridad_obj <= 2.5 ~ 1,
    seguridad_obj >= 3   ~ 0
  ))
```

```{r}
#| label: sentido de pertenencia dummy
#| echo: false

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(
    # Calcular promedio de las variables
    sentido_pertenencia = rowMeans(select(., barrio_ideal, barrio_integracion, barrio_identidad, barrio_pertenencia), na.rm = TRUE))

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(sentido_pertenencia = case_when(
    sentido_pertenencia <= 2.5 ~ 1,
    sentido_pertenencia >= 3   ~ 0
  ))
```

```{r}
#| label: satisfacción con el barrio dummy
#| echo: false
elsoc_6_graph <- elsoc_6_graph %>%
  mutate(satisfaccion_barrio = rowMeans(select(., barrio_amigos, barrio_sociable, barrio_cordial, barrio_colaborador), na.rm = TRUE))

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(satisfaccion_barrio = case_when(
    satisfaccion_barrio <= 2.5 ~ 1,
    satisfaccion_barrio >= 3   ~ 0
  ))
```

## Gráficos migración

```{r}
#| echo: false

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(desempleo_migrantes = case_when(
    desempleo_migrantes <= 2 ~ 1,
    desempleo_migrantes == 3  ~ 2,
    desempleo_migrantes >= 4 ~ 3
  ))
```

```{r}
#| echo: false

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(contacto_migrantes = case_when(
    contacto_migrantes <= 2 ~ 1,
    contacto_migrantes == 3  ~ 2,
    contacto_migrantes >= 4 ~ 3
  ))
```

```{r}
#| echo: false

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(simpatia_migrantes = case_when(
    simpatia_migrantes <= 2 ~ 1,
    simpatia_migrantes == 3  ~ 2,
    simpatia_migrantes >= 4 ~ 3
  ))

```

```{r}
#| echo: false

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(igualdad_migrantes = case_when(
    igualdad_migrantes <= 2 ~ 1,
    igualdad_migrantes == 3  ~ 2,
    igualdad_migrantes >= 4 ~ 3
  ))

```

```{r}
#| echo: false

elsoc_5_graph <- elsoc_5_graph %>%
  mutate(perdida_identidad = case_when(
    perdida_identidad <= 2 ~ 1,
    perdida_identidad == 3  ~ 2,
    perdida_identidad >= 4 ~ 3
  ))
```



```{r}
#| echo: false

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(desempleo_migrantes = case_when(
    desempleo_migrantes <= 2 ~ 1,
    desempleo_migrantes == 3  ~ 2,
    desempleo_migrantes >= 4 ~ 3
  ))
```

```{r}
#| echo: false

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(contacto_migrantes = case_when(
    contacto_migrantes <= 2 ~ 1,
    contacto_migrantes == 3  ~ 2,
    contacto_migrantes >= 4 ~ 3
  ))
```

```{r}
#| echo: false

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(simpatia_migrantes = case_when(
    simpatia_migrantes <= 2 ~ 1,
    simpatia_migrantes == 3  ~ 2,
    simpatia_migrantes >= 4 ~ 3
  ))

```

```{r}
#| echo: false

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(igualdad_migrantes = case_when(
    igualdad_migrantes <= 2 ~ 1,
    igualdad_migrantes == 3  ~ 2,
    igualdad_migrantes >= 4 ~ 3
  ))

```

```{r}
#| echo: false

elsoc_6_graph <- elsoc_6_graph %>%
  mutate(perdida_identidad = case_when(
    perdida_identidad <= 2 ~ 1,
    perdida_identidad == 3  ~ 2,
    perdida_identidad >= 4 ~ 3
  ))
```

```{r}
#| label: fig-migracion
#| fig-cap: Descriptivos de migración
#| fig-cap-location: top
#| echo: false
#| fig-width: 12
#| fig-height: 8

desc_migracion <- plot_stackfrq(
  dplyr::select(elsoc_6_graph, perdida_identidad, desempleo_migrantes, simpatia_migrantes, igualdad_migrantes, contacto_migrantes),
  title = "Likerplots de variables de migración",
  show.prc = FALSE
  
) +
  theme(legend.position = "bottom") +
  # Cambiar tamaño de los números dentro del gráfico
  theme(axis.text = element_text(size = 18),
        title = element_text(size = 20),  # ajusta a tu gusto
        legend.text = element_text(size = 16)
        ) +
        scale_fill_manual(
        values = c("1" = "#f9913d", "2" = "#7ABA21", "3" = "#2b2f3c"),
         labels = c("1" = "Muy en desacuerdo", 
               "2" = "Ni en desacuerdo \n ni de acuerdo", 
               "3" = "Muy de acuerdo")
  )

desc_migracion

# sacar el N de las variables 
# achicar las letras 
```

# Transversales por subdimensión

## Seguridad transversal
```{r}
#| label: fig-segsub
#| fig-cap: Asociación entre percepción de desempleo y seguridad subjetiva
#| fig-cap-location: top
#| echo: false 

elsoc_6_graph <- elsoc_6_graph %>%
  na.omit()

# Gráfico
ggplot(elsoc_6_graph, aes(
  x = desempleo_migrantes, 
  fill = factor(seguridad_sub, labels = c("Alta seguridad", "Poca seguridad"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta seguridad" = "#2b2f3c", "Poca seguridad" = "#f9913d"),
    breaks = c("Alta seguridad", "Poca seguridad")
  ) +
  labs(
    title = "% de percepción de desempleo \n debido a inmigrantes según seguridad subjetiva",
    x = "Percepción de desempleo debido a inmigrantes",
    y = NULL,
    fill = "Seguridad subjetiva"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  #coord_fixed(ratio = 15/5) + 
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```

```{r}
#| label: fig-segobj
#| fig-cap: Asociación entre percepción de pérdida de identidad y seguridad objetiva
#| fig-cap-location: top
#| echo: false 

ggplot(elsoc_6_graph, aes(
  x = perdida_identidad, 
  fill = factor(seguridad_obj, labels = c("Alta seguridad", "Poca seguridad"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta seguridad" = "#2b2f3c", "Poca seguridad" = "#f9913d"),
    breaks = c("Alta seguridad", "Poca seguridad")
  ) +
  labs(
    title = "% de percepción de pérdida de identidad del pais \n debido a inmigrantes según seguridad subjetiva",
    x = "Percepción de pérdida de identidad",
    y = NULL,
    fill = "Seguridad objetiva"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  #coord_fixed(ratio = 15/5) + 
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```

## Vínculos territoriales transversal

```{r}
#| label: fig-satbarrio
#| fig-cap: Asociación entre percepción de pérdida de identidad y satisfacción con el barrio
#| fig-cap-location: top
#| echo: false 

ggplot(elsoc_6_graph, aes(
  x = perdida_identidad, 
  fill = factor(satisfaccion_barrio, labels = c("Alta satisfacción", "Poca satisfacción"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta satisfacción" = "#2b2f3c", "Poca satisfacción" = "#f9913d"),
    breaks = c("Alta satisfacción", "Poca satisfacción")
  ) +
  labs(
    title = "% de percepción de pérdida de identidad del pais \n debido a inmigrantes según satisfacción con el barrio",
    x = "Percepción de pérdida de identidad",
    y = NULL,
    fill = "Satisfacción con el barrio"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  #coord_fixed(ratio = 15/5) + 
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```

```{r}
#| label: fig-sentper
#| fig-cap: Asociación entre percepción de pérdida de identidad y sentido de pertenencia
#| fig-cap-location: top
#| echo: false 

ggplot(elsoc_6_graph, aes(
  x = perdida_identidad, 
  fill = factor(satisfaccion_barrio, labels = c("Alta pertenencia", "Baja pertenencia"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta pertenencia" = "#2b2f3c", "Baja pertenencia" = "#f9913d"),
    breaks = c("Alta pertenencia", "Baja pertenencia")
  ) +
  labs(
    title = "% de percepción de pérdida de identidad del pais \n debido a inmigrantes según sentido de pertenencia",
    x = "Percepción de pérdida de identidad",
    y = NULL,
    fill = "Sentido de pertenencia"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  #coord_fixed(ratio = 15/5) + 
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy de acuerdo")
  )
```

## Redes sociales transversal

```{r}
#| label: fig-prosoc
#| fig-cap: Asociación entre percepción de desempleo y comportamiento prosocial
#| fig-cap-location: top
#| echo: false 

elsoc_5_graph <- elsoc_5_graph %>%
  drop_na(desempleo_migrantes, perdida_identidad)

ggplot(elsoc_5_graph, aes(
  x = desempleo_migrantes, 
  fill = factor(comportamiento_prosocial, labels = c("Alto", "Bajo"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alto" = "#2b2f3c", "Bajo" = "#f9913d"),
    breaks = c("Alto", "Bajo")
  ) +
  labs(
    title = "% de percepción de desempleo \n debido a inmigrantes según comportamiento prosocial",
    x = "Percepción de desempleo",
    y = NULL,
    fill = "Comportamiento prosocial"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  #coord_fixed(ratio = 15/5) + 
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```

```{r}
#| label: fig-confinter
#| fig-cap: Asociación entre percepción de desempleo debido a inmigrantes y confianza interpersonal
#| fig-cap-location: top
#| echo: false 

ggplot(elsoc_5_graph, aes(
  x = desempleo_migrantes, 
  fill = factor(confianza_inter, labels = c("Alta confianza", "Baja confianza"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta confianza" = "#2b2f3c", "Baja confianza" = "#f9913d"),
    breaks = c("Alta confianza", "Baja confianza")
  ) +
  labs(
    title = "% de percepción de desempleo \n debido a inmigrantes según confianza interpersonal",
    x = "Percepción de desempleo",
    y = NULL,
    fill = "Confianza interpersonal"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  #coord_fixed(ratio = 15/5) + 
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```

```{r}
#| label: fig-ayudaeco
#| fig-cap: Asociación entre percepción de pérdida de identidad y ayuda económica
#| fig-cap-location: top
#| echo: false 

ggplot(elsoc_5_graph, aes(
  x = perdida_identidad, 
  fill = factor(ayuda_economica, labels = c("Mucha ayuda", "Poca ayuda"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Mucha ayuda" = "#2b2f3c", "Poca ayuda" = "#f9913d"),
    breaks = c("Mucha ayuda", "Poca ayuda")
  ) +
  labs(
    title = "% de percepción de pérdida de identidad del país \n debido a inmigrantes según ayuda económica a terceros",
    x = "Pérdida de identidad",
    y = NULL,
    fill = "Ayuda económica"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  #coord_fixed(ratio = 15/5) + 
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```

# Cruces filtrados (género/educación)

## Seguridad por género

```{r}
seguridad_genero <- elsoc_6_graph %>%
  select(sexo, seguridad_obj, seguridad_sub, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, igualdad_migrantes)
```

```{r}
seguridad_hombres <- seguridad_genero %>%
  filter(sexo==0)

seguridad_mujeres <- seguridad_genero %>%
  filter(sexo==1)
```

```{r}
seguridad_hombres <- seguridad_hombres %>%
  select(-c(sexo))

seguridad_mujeres <- seguridad_mujeres %>%
  select(-c(sexo))
```

```{r}
#| echo: false

a <- ggplot(seguridad_hombres, aes(
  x = perdida_identidad, 
  fill = factor(seguridad_obj, labels = c("Alta seguridad", "Poca seguridad"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta seguridad" = "#2b2f3c", "Poca seguridad" = "#f9913d"),
    breaks = c("Alta seguridad", "Poca seguridad")
  ) +
  labs(
    title = "% de percepción de desempleo \n debido a inmigrantes según seguridad objetiva (Hombres)",
    x = "Percepción de desempleo debido a inmigrantes",
    y = NULL,
    fill = "Seguridad objetiva"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )

```

```{r}
#| echo: false

b <- ggplot(seguridad_mujeres, aes(
  x = perdida_identidad, 
  fill = factor(seguridad_obj, labels = c("Alta seguridad", "Poca seguridad"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta seguridad" = "#2b2f3c", "Poca seguridad" = "#f9913d"),
    breaks = c("Alta seguridad", "Poca seguridad")
  ) +
  labs(
    title = "% de percepción de desempleo \n debido a inmigrantes según seguridad objetiva (Mujeres)",
    x = "Percepción de desempleo debido a inmigrantes",
    y = NULL,
    fill = "Seguridad objetiva"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )

```

```{r}
#| fig-width: 12
#| fig-height: 6

seg_interact <- a | b
seg_interact
```

## Seguridad por educación

```{r}
seguridad_educ <- elsoc_6_graph %>%
  select(educacion, seguridad_obj, seguridad_sub, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, igualdad_migrantes)
```

```{r}
seguridad_titulo <- seguridad_educ %>%
  filter(educacion==1)

seguridad_notitulo <- seguridad_educ %>%
  filter(educacion==0)
```

```{r}
seguridad_titulo <- seguridad_titulo %>%
  select(-c(educacion))

seguridad_notitulo <- seguridad_notitulo %>%
  select(-c(educacion))
```


```{r}
#| echo: false

c <- ggplot(seguridad_titulo, aes(
  x = desempleo_migrantes, 
  fill = factor(seguridad_obj, labels = c("Alta seguridad", "Poca seguridad"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta seguridad" = "#2b2f3c", "Poca seguridad" = "#f9913d"),
    breaks = c("Alta seguridad", "Poca seguridad")
  ) +
  labs(
    title = "% de percepción de desempleo \n debido a inmigrantes según seguridad objetiva (Título univ.)",
    x = "Percepción de desempleo debido a inmigrantes",
    y = NULL,
    fill = "Seguridad objetiva"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```


```{r}
#| echo: false

d <- ggplot(seguridad_notitulo, aes(
  x = desempleo_migrantes, 
  fill = factor(seguridad_obj, labels = c("Alta seguridad", "Poca seguridad"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta seguridad" = "#2b2f3c", "Poca seguridad" = "#f9913d"),
    breaks = c("Alta seguridad", "Poca seguridad")
  ) +
  labs(
    title = "% de percepción de desempleo \n debido a inmigrantes según seguridad objetiva (Sin título univ.)",
    x = "Percepción de desempleo debido a inmigrantes",
    y = NULL,
    fill = "Seguridad objetiva"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```

```{r}
#| fig-width: 12
#| fig-height: 6

seg_interact_ed <- d | c
seg_interact_ed
```

## Vínculos territoriales por género

```{r}
barrio_genero <- elsoc_6_graph %>%
  select(sexo, sentido_pertenencia, satisfaccion_barrio, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, igualdad_migrantes)
```

```{r}
barrio_hombres <- barrio_genero %>%
  filter(sexo==0)

barrio_mujeres <- barrio_genero %>%
  filter(sexo==1)
```

```{r}
barrio_hombres <- barrio_hombres %>%
  select(-c(sexo))

barrio_mujeres <- barrio_mujeres %>%
  select(-c(sexo))
```


```{r}
#| echo: false

e <- ggplot(barrio_hombres, aes(
  x = perdida_identidad, 
  fill = factor(sentido_pertenencia, labels = c("Alta pertenencia", "Baja pertenencia"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta pertenencia" = "#2b2f3c", "Baja pertenencia" = "#f9913d"),
    breaks = c("Alta pertenencia", "Baja pertenencia")
  ) +
  labs(
    title = "% de percepción de pérdida de identidad del país \n debido a inmigrantes según sentido de pertenencia (Hombres)",
    x = "Percepción de pérdida de identidad",
    y = NULL,
    fill = "Sentido de pertenencia"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```

```{r}
#| echo: false

f <- ggplot(barrio_mujeres, aes(
  x = perdida_identidad, 
  fill = factor(sentido_pertenencia, labels = c("Alta pertenencia", "Baja pertenencia"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta pertenencia" = "#2b2f3c", "Baja pertenencia" = "#f9913d"),
    breaks = c("Alta pertenencia", "Baja pertenencia")
  ) +
  labs(
    title = "% de percepción de pérdida de identidad del país \n debido a inmigrantes según sentido de pertenencia (Mujeres)",
    x = "Percepción de pérdida de identidad",
    y = NULL,
    fill = "Sentido de pertenencia"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```


```{r}
#| fig-width: 12
#| fig-height: 6

barrio_interact <- e | f
barrio_interact
```

## Vínculos territoriales por educación

```{r}
barrio_educ <- elsoc_6_graph %>%
  select(educacion, sentido_pertenencia, satisfaccion_barrio, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, igualdad_migrantes)
```

```{r}
barrio_titulo <- barrio_educ %>%
  filter(educacion==1)

barrio_notitulo <- barrio_educ %>%
  filter(educacion==0)
```

```{r}
barrio_titulo <- barrio_titulo %>%
  select(-c(educacion))

barrio_notitulo <- barrio_notitulo %>%
  select(-c(educacion))
```

```{r}
#| echo: false

g <- ggplot(barrio_titulo, aes(
  x = desempleo_migrantes, 
  fill = factor(sentido_pertenencia, labels = c("Alta pertenencia", "Baja pertenencia"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta pertenencia" = "#2b2f3c", "Baja pertenencia" = "#f9913d"),
    breaks = c("Alta pertenencia", "Baja pertenencia")
  ) +
  labs(
    title = "% de percepción de pérdida de identidad del país \n debido a inmigrantes según sentido de pertenencia (Título univ.)",
    x = "Percepción de pérdida de identidad",
    y = NULL,
    fill = "Sentido de pertenencia"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```

```{r}
#| echo: false

h <- ggplot(barrio_notitulo, aes(
  x = desempleo_migrantes, 
  fill = factor(sentido_pertenencia, labels = c("Alta pertenencia", "Baja pertenencia"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta pertenencia" = "#2b2f3c", "Baja pertenencia" = "#f9913d"),
    breaks = c("Alta pertenencia", "Baja pertenencia")
  ) +
  labs(
    title = "% de percepción de pérdida de identidad del país \n debido a inmigrantes según sentido de pertenencia (Sin título univ.)",
    x = "Percepción de pérdida de identidad",
    y = NULL,
    fill = "Sentido de pertenencia"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```

```{r}
#| fig-width: 12
#| fig-height: 6

barrio_interact_ed <- g | h
barrio_interact_ed
```

## Redes sociales por género

```{r}
redes_genero <- elsoc_5_graph %>%
  select(sexo, comportamiento_prosocial, ayuda_economica, confianza_inter, contacto_migrantes, simpatia_migrantes, perdida_identidad, desempleo_migrantes, igualdad_migrantes)
```

```{r}
redes_hombres <- redes_genero %>%
  filter(sexo==0)

redes_mujeres <- redes_genero %>%
  filter(sexo==1)
```

```{r}
redes_hombres <- redes_hombres %>%
  select(-c(sexo))

redes_mujeres <- redes_mujeres %>%
  select(-c(sexo))
```

```{r}
#| echo: false 

i <- ggplot(redes_hombres, aes(
  x = desempleo_migrantes, 
  fill = factor(confianza_inter, labels = c("Alta confianza", "Baja confianza"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta confianza" = "#2b2f3c", "Baja confianza" = "#f9913d"),
    breaks = c("Alta confianza", "Baja confianza")
  ) +
  labs(
    title = "% de percepción de desempleo \n debido a inmigrantes según confianza interpersonal (Hombres)",
    x = "Percepción de desempleo",
    y = NULL,
    fill = "Confianza interpersonal"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  )  +
  #coord_fixed(ratio = 15/5) + 
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```

```{r}
#| echo: false 
#| fig-width: 10
#| fig-height: 6

j <- ggplot(redes_mujeres, aes(
  x = desempleo_migrantes, 
  fill = factor(confianza_inter, labels = c("Alta confianza", "Baja confianza"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta confianza" = "#2b2f3c", "Baja confianza" = "#f9913d"),
    breaks = c("Alta confianza", "Baja confianza")
  ) +
  labs(
    title = "% de percepción de desempleo \n debido a inmigrantes según confianza interpersonal (Mujeres)",
    x = "Percepción de desempleo",
    y = NULL,
    fill = "Confianza interpersonal"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  )  +
  #coord_fixed(ratio = 15/5) + 
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```

```{r}
#| fig-width: 12
#| fig-height: 6
redes_interact <- i | j
redes_interact
```

## Redes sociales por educación

```{r}
redes_educ <- elsoc_5_graph %>%
  select(educacion, comportamiento_prosocial, ayuda_economica, confianza_inter, contacto_migrantes, simpatia_migrantes, perdida_identidad, desempleo_migrantes, igualdad_migrantes)
```

```{r}
redes_titulo <- redes_educ %>%
  filter(educacion==1)

redes_notitulo <- redes_educ %>%
  filter(educacion==0)
```

```{r}
redes_titulo <- redes_titulo %>%
  select(-c(educacion))

redes_notitulo <- redes_notitulo %>%
  select(-c(educacion))
```

```{r}
#| echo: false 

k <- ggplot(redes_titulo, aes(
  x = desempleo_migrantes, 
  fill = factor(confianza_inter, labels = c("Alta confianza", "Baja confianza"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta confianza" = "#2b2f3c", "Baja confianza" = "#f9913d"),
    breaks = c("Alta confianza", "Baja confianza")
  ) +
  labs(
    title = "% de percepción de desempleo \n debido a inmigrantes según confianza interpersonal (titulados)",
    x = "Percepción de desempleo",
    y = NULL,
    fill = "Confianza interpersonal"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  )  +
  #coord_fixed(ratio = 15/5) + 
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```

```{r}
#| echo: false 

l <- ggplot(redes_notitulo, aes(
  x = desempleo_migrantes, 
  fill = factor(confianza_inter, labels = c("Alta confianza", "Baja confianza"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta confianza" = "#2b2f3c", "Baja confianza" = "#f9913d"),
    breaks = c("Alta confianza", "Baja confianza")
  ) +
  labs(
    title = "% de percepción de desempleo \n debido a inmigrantes según confianza interpersonal (no titulados)",
    x = "Percepción de desempleo",
    y = NULL,
    fill = "Confianza interpersonal",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  theme(
    
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    legend.text = element_text(size = 11),
    legend.title = element_text(size = 14), 
    plot.title = element_text(size = 14, hjust = 0.5) # centra título
  )  +
  #coord_fixed(ratio = 15/5) + 
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  )
```


```{r}
#| fig-width: 12
#| fig-height: 6

redes_interact_ed <- l | k
redes_interact_ed
```


```{r}
ggplot(redes_notitulo, aes(
  x = desempleo_migrantes, 
  fill = factor(confianza_inter, labels = c("Alta confianza", "Baja confianza"))
)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c("Alta confianza" = "#2b2f3c", "Baja confianza" = "#f9913d"),
    breaks = c("Alta confianza", "Baja confianza")
  ) +
  labs(
    title = "% de percepción de desempleo \n debido a inmigrantes según confianza interpersonal (no titulados)",
    x = "Percepción de desempleo",
    y = NULL,
    fill = "Confianza interpersonal",
    caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
  ) +
  theme_minimal() +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1), 
    breaks = scales::pretty_breaks(n = 10),
    expand = expansion(mult = c(0, 0.05))
  ) +
  scale_x_continuous(
    breaks = 1:3,
    labels = c("Muy \n en desacuerdo", "Ni en desacuerdo \n ni de acuerdo", "Muy \n de acuerdo")
  ) +
  theme(
    # Configuración de leyenda personalizada
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background     = element_rect(fill = "white", color = NA),
    legend.margin         = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin     = margin(t = 6, r = 6, b = 6, l = 6),
    
    legend.position       = "top",
    legend.direction      = "horizontal",
    legend.box            = "horizontal",
    
    legend.title          = element_text(face = "bold", size = 14),
    legend.text           = element_text(size = 11),
    legend.key            = element_rect(fill = "white", color = NA),
    legend.key.height     = unit(12, "pt"),
    legend.key.width      = unit(18, "pt"),
    
    # Mantener configuraciones originales de ejes y título
    axis.title.x = element_text(size = 14, margin = margin(t = 30)),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 14),
    plot.title = element_text(size = 14, hjust = 0.5)
  ) +
  guides(fill = guide_legend(
    title.position = "top",
    label.position = "bottom",
    nrow = 1, 
    byrow = TRUE,
    keywidth = unit(14, "pt"),
    keyheight = unit(10, "pt")
  ))

m
```