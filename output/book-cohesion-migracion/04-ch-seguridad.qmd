# Cohesión Horizontal: Seguridad

```{r}
#| label: set
#| echo: false
#| message: false
#| warning: false

library(knitr)
knitr::opts_chunk$set(echo = FALSE, 
                      include = TRUE, 
                      warning = FALSE, 
                      message = FALSE)

table_format <- if(is_html_output()) {
  "html"
} else if(is_latex_output()) {
  "latex"
}
table_format2 <- if(is_html_output()) {
  T
} else if(is_latex_output()) {
  F
}

options(kableExtra.html.bsTable = T)
options(knitr.kable.NA = "")
```

```{r}
#| label: packages
#| echo: false

if (! require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse,
               sjmisc, 
               here,
               sjlabelled,
               psych,
               rstatix,
               lme4,
               performance,
               sjPlot,
               srvyr,
               ggdist,
               purrr,
               rlang)


options(scipen=999)
rm(list = ls())
```

```{r}
#| label: data
#| echo: false 
#| 
elsoc_5 <- readRDS("../../input/data/proc_data/elsoc_2021_mig.RData")
elsoc_6 <- readRDS("../../input/data/proc_data/elsoc_2022_mig.RData")

```

```{r}
#| label: data-biv
#| echo: false

db_long <- load("../../input/data/proc_data/db_long.RData")
```

```{r}
#| label: db_pond
#| echo: false

db_pond <- db %>% 
  as_survey_design(ids = segmento, 
                   strata = estrato, 
                   weights = ponderador_long_total,
                   nest = T)

```

<!-- Recodificaciones -->

```{r}
#| label: Recode Subíndices de Seguridad Transversal
#| echo: false

#OBJETIVA
elsoc_6_graph <- elsoc_6 %>%  
 mutate(    
   # Índice promediado    
   seguridad_obj = rowMeans(      
     select(., peleas_calle, asaltos, trafico_drogas),      
     na.rm = TRUE    
   ),         
  
   # Recodificación en 3 categorías   
   seguridad_obj = case_when(      
     seguridad_obj >= 1 & seguridad_obj <= 2.5 ~ 1,
     seguridad_obj >= 3 & seguridad_obj <= 3.5 ~ 2,
     seguridad_obj >= 4 & seguridad_obj <= 5 ~ 3
   )  
 )

#SUBJETIVA
elsoc_6_graph <- elsoc_6_graph %>%  
 mutate(    
   # Índice promediado    
   seguridad_sub = rowMeans(      
     select(., seguridad_sat, seguridad_perc),      
     na.rm = TRUE    
   ),         
  
   # Recodificación en 3 categorías   
   seguridad_sub = case_when(      
     seguridad_sub >= 1 & seguridad_sub <= 2.5 ~ 1,
     seguridad_sub >= 3 & seguridad_sub <= 3.5 ~ 2,
     seguridad_sub >= 4 & seguridad_sub <= 5 ~ 3
   )  
 )

#Omitir NA
elsoc_6_graph <- elsoc_6_graph %>%
  na.omit()
```

```{r}
#| label: seguridad subjetiva dummy
#| echo: false

elsoc_6_graph_2 <- elsoc_6 %>%
  mutate(seguridad_sub = rowMeans(select(., seguridad_sat, seguridad_perc), na.rm = TRUE))

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(seguridad_sub = case_when(
    seguridad_sub <= 2.5 ~ 1,
    seguridad_sub >= 3   ~ 0
  ))

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(seguridad_obj = rowMeans(select(., peleas_calle, asaltos, trafico_drogas), na.rm = TRUE))

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(seguridad_obj = case_when(
    seguridad_obj <= 2.5 ~ 1,
    seguridad_obj >= 3   ~ 0
  ))
```

```{r}
#| echo: false

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(desempleo_migrantes = case_when(
    desempleo_migrantes <= 2 ~ 1,
    desempleo_migrantes == 3  ~ 2,
    desempleo_migrantes >= 4 ~ 3
  ))

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(contacto_migrantes = case_when(
    contacto_migrantes <= 2 ~ 1,
    contacto_migrantes == 3  ~ 2,
    contacto_migrantes >= 4 ~ 3
  ))

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(simpatia_migrantes = case_when(
    simpatia_migrantes <= 2 ~ 1,
    simpatia_migrantes == 3  ~ 2,
    simpatia_migrantes >= 4 ~ 3
  ))

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(igualdad_migrantes = case_when(
    igualdad_migrantes <= 2 ~ 1,
    igualdad_migrantes == 3  ~ 2,
    igualdad_migrantes >= 4 ~ 3
  ))

elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  mutate(perdida_identidad = case_when(
    perdida_identidad <= 2 ~ 1,
    perdida_identidad == 3  ~ 2,
    perdida_identidad >= 4 ~ 3
  ))

#Omitir NA
elsoc_6_graph_2 <- elsoc_6_graph_2 %>%
  na.omit()
```

```{r}
#| label: plots
#| echo: false


# Selección de variables: (1) desempleo por migrantes, (2)pérdida de identidad
# (3)simpatía hacia migrantes, (4)acceso a salud igualitaro y (5) contacto positivo

# plot function
make_plot <- function(design, predictor, outcome, ylab, legend_title) {
  pred_sym <- ensym(predictor)
  out_sym  <- ensym(outcome)
  
  design %>% 
    select(wave, !!pred_sym, !!out_sym) %>% 
    tidyr::drop_na() %>% 
    group_by(wave, !!pred_sym) %>%
    summarise(
      value = survey_mean(!!out_sym, vartype = "ci", na.rm = TRUE),
      .groups = "drop"
    ) %>% 
    ggplot(aes(x = wave, y = value, group = !!pred_sym)) +
    geom_point(aes(color = !!pred_sym), size = 4.5) +
    geom_line(aes(color = !!pred_sym), linewidth = 1) +
    # geom_errorbar(aes(ymin = value_low, ymax = value_upp, color = !!pred_sym), width = 0.1) +
    scale_y_continuous(n.breaks = 7) +
    scale_color_manual(
      name = legend_title,
      values = c("#F9913D","#7ABA21", "#2b2f3c")
      ) +
    labs(
      x = "Ola",
      y = ylab,
      caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
    ) +
    theme_ggdist() +
theme(
    plot.title   = element_text(size = 24, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 16, face = "italic", hjust = 0.5),
    plot.caption = element_text(size = 14),
    
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    axis.text.x  = element_text(size = 16),
    axis.text.y  = element_text(size = 16),
    
    legend.title = element_text(size = 16, face = "bold"),
    legend.text  = element_text(size = 14),
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background     = element_rect(fill = "white", color = NA),
    legend.margin         = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin     = margin(t = 6, r = 6, b = 6, l = 6),
    
    legend.position  = "top",
    legend.direction = "horizontal"
  ) +
  guides(
    color = guide_legend(
      title.position = "top",
      label.position = "bottom",
      nrow = 1, byrow = TRUE,
      keywidth = unit(14, "pt"),
      keyheight = unit(10, "pt")
    )
  )
}

# combinations

outcomes <- c(
  seguridad_sub           = "Seguridad percibida",
  seguridad_obj           = "Seguridad objetiva",
  confianza_inter         = "Confianza interpersonal",
  comportamiento_prosocial= "Comportamiento prosocial",
  ayuda_economica         = "Ayuda económica",
  sentido_pertenencia     = "Sentido pertenencia barrio",
  satisfaccion_barrio     = "Satisfacción barrio"
)

predictors <- list(
  desempleo_migrantes = "Desempleo percibido por \nmigrantes",
  perdida_identidad   = "Pérdida identidad por \nmigrantes",
  simpatia_migrantes = "Simpatía hacia migrantes",
  igualdad_migrantes = "Acceso a salud igualitario \npara migrantes",
  contacto_migrantes = "Contacto positivo con \nmigrantes",
  restriccion_migrantes = "Restricción a ingreso de \nmigrantes"
)

comb <- tidyr::crossing(pred = names(predictors), out = names(outcomes))

# make plots

plots_tbl <- comb %>%
  mutate(
    plot = pmap(
      list(pred, out),
      ~ make_plot(
        design       = db_pond,
        predictor    = ..1,
        outcome      = ..2,
        ylab         = outcomes[..2],
        legend_title = predictors[[..1]]
      )
    ),
    plot_id = paste0("plot_", out, "__by__", pred)
  )
```

```{r}
#| label: fig-seg-res
#| echo: false
#| warning: false
#| message: false
#| fig.width: 12
#| fig.height: 8
#| out-width: "100%"
#| fig-align: "center"
db_pond %>% 
  select(wave, seguridad_sub, restriccion_migrantes) %>%
  mutate(seguridad_sub = case_when(
    seguridad_sub <= 2.5 ~ "Baja",
    seguridad_sub >= 3   ~ "Alta"
  ),
  restriccion_migrantes = forcats::fct_relabel(
    restriccion_migrantes, ~ str_wrap(.x, 20))) %>% 
  tidyr::drop_na() %>% 
  filter(wave == last(wave)) %>% 
  group_by(restriccion_migrantes, seguridad_sub) %>%
  survey_count(vartype = NULL) %>% 
  group_by(seguridad_sub) %>% 
  mutate(
    prop  = 100 * n / sum(n),                 # porcentaje dentro de cada wave
    label = scales::percent(prop/100, accuracy = 0.1)
  ) %>% 
  ggplot(aes(x = restriccion_migrantes, y = prop, fill = seguridad_sub)) +
  geom_col(position = position_dodge(width = 0.6), width = 0.6) +
  geom_text(
    aes(label = label, color = seguridad_sub),   # color igual a la serie
    position = position_dodge(width = 0.6),
    vjust = -0.4, size = 5, fontface = "bold", show.legend = FALSE
  ) +
  scale_fill_manual(
    name = "Percepción seguridad",
    values = c("Baja" = "#2b2f3c", "Alta" = "#F9913D")
  ) +
  scale_color_manual(                                 # mismo esquema para el texto
    values = c("Baja" = "#2b2f3c", "Alta" = "#F9913D")
  ) +
  scale_y_continuous(
    labels = function(p){paste0(p, "%")},
    limits = c(0,100),
    breaks = seq(0,100, by = 10),
    expand = expansion(mult = c(0.02, 0.08)) # deja aire arriba para las etiquetas
  )  + 
    labs(
      title = "Percepción de seguridad y restricción de acceso a migrantes",
      x = "Restricción de acceso a migrantes",
      y = NULL,
      caption = "Fuente: elaboración propia con datos de ELSOC 2023"
    ) +
  theme_ggdist() +
  theme(
    plot.title   = element_text(size = 24, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 16, face = "italic", hjust = 0.5),
    plot.caption = element_text(size = 14),
    
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    axis.text.x  = element_text(size = 16),
    axis.text.y  = element_text(size = 16),
    
    legend.title = element_text(size = 16, face = "bold"),
    legend.text  = element_text(size = 14),
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background     = element_rect(fill = "white", color = NA),
    legend.margin         = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin     = margin(t = 6, r = 6, b = 6, l = 6),
    
    legend.position  = "top",
    legend.direction = "horizontal"
  ) +
  guides(
    color = guide_legend(
      title.position = "top",
      label.position = "right",
      nrow = 1, byrow = TRUE,
      keywidth = unit(14, "pt"),
      keyheight = unit(10, "pt")
    )
  )
```
La @fig-seg-res muestra la relación entre la percepción de seguridad y el nivel de acuerdo con restringir el acceso a migrantes, a partir de los datos provistos por la ola del año 2023 en la encuesta ELSOC. Se observa que, independientemente de si las personas reportan una percepción de seguridad alta o baja, existe un fuerte consenso en torno a la necesidad de restringir dicho acceso: el 85,1% de quienes se sienten más seguros y el 85,5% de quienes perciben menor seguridad se declaran “muy de acuerdo”. En contraste, las posiciones de rechazo son minoritarias: solo un 8,2% de quienes perciben alta seguridad y un 5,7% de quienes reportan baja seguridad están “muy en desacuerdo”, mientras que alrededor de un 7% a 9% se ubica en una posición intermedia de ni acuerdo ni desacuerdo. En síntesis, el apoyo a la restricción hacia los migrantes es elevado y transversal, sin diferencias sustantivas según la percepción subjetiva de seguridad.

```{r}
#| label: fig-simpa-seg
#| echo: false
#| warning: false
#| message: false
#| fig.width: 12
#| fig.height: 8
#| out-width: "100%"
#| fig-align: "center"

sel <- plots_tbl %>%
  filter(out  %in% c("seguridad_sub","seguridad_obj")) 

sel$plot[[12]] + 
  labs(title = "Seguridad percibida y simpatía hacia migrantes") 
```
Ahora, en términos longitudinales, de acuerdo con la @fig-simpa-seg, que muestra la evolución de la relación entre percepción de seguridad pública y grado de simpatía hacia los migrantes entre 2016 y 2023, se observa que la seguridad percibida es consistentemente más baja entre quienes expresan poca o ninguna simpatía por la población migrante. Esta brecha se acentúa desde 2019 en adelante, cuando la percepción de inseguridad en este grupo contrasta con la trayectoria ascendente que mostraban, hasta 2022, quienes dicen simpatizar algo o mucho con los migrantes. No obstante, a partir de 2022 la tendencia se revierte: todos los grupos reportan un descenso en su sensación de seguridad, aunque con intensidades distintas. Aun así, en el último año analizado se mantiene la jerarquía relativa: la percepción de seguridad es mayor entre quienes simpatizan mucho con los migrantes, seguida por quienes simpatizan algo, y alcanza sus niveles más bajos en el grupo con menor simpatía. En contraste con el caso de la pérdida de identidad, en esta dimensión las diferencias entre grupos se amplían con el tiempo, pues quienes simpatizan más con los migrantes no solo mantienen una mayor sensación de seguridad, sino que además la incrementan hasta 2022. El descenso en 2023, común a todos los grupos, sugiere la incidencia de factores coyunturales que interrumpieron esa tendencia.


```{r}
#| label: fig-seg-res-2
#| echo: false
#| warning: false
#| message: false
#| fig.width: 12
#| fig.height: 8
#| out-width: "100%"
#| fig-align: "center"

sel$plot[[10]] + 
  labs(title = "Seguridad percibida y restricción de ingreso a migrantes")
```

Siguiendo con la línea longitudinal, la @fig-seg-res-2, que muestra la evolución de la relación entre percepción de seguridad pública y acuerdo con la restricción de ingreso a migrantes entre 2018 y 2023, muestra que la seguridad percibida tiende a ser mayor entre quienes se muestran muy en desacuerdo con la idea de restringir la migración, alcanzando su punto más alto en 2022. En cambio, quienes se declaran muy de acuerdo con la restricción exhiben de manera consistente los niveles más bajos de seguridad percibida a lo largo del período. Esta diferencia se hace más evidente hacia 2022, cuando se amplía la distancia entre los grupos. Sin embargo, a partir de 2022 se produce un quiebre: todos los segmentos experimentan una caída en su percepción de seguridad, que se acentúa con fuerza en 2023. De este modo, aunque se mantienen las jerarquías relativas —con mayor seguridad percibida entre quienes rechazan la restricción y menor entre quienes la apoyan—, la tendencia descendente general sugiere la influencia de factores coyunturales recientes que redujeron la sensación de seguridad en toda la población, independientemente de su postura frente a la migración.
