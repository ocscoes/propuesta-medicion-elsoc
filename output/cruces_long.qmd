---
title: "Cohesión horizontal y migración: Cruces Longitudinales"
author: "René Canales, Asistente de Investigación del OCS"
date: today
lang: es
fontsize: 14pt
format:
  html:
    toc: true
    toc-location: left
    toc-depth: 2
    toc-expand: 1
    toc-title: Contenidos
    number-sections: true
    number-depth: 3
    theme:
      - ../ocs.scss
    code-link: true
    title-block-banner: true 
---

```{=html}
<style>
.logo {
    position: absolute;
    top: 20px;
    right: 30px;
}
</style>
```

<img src="ocs-new.jpeg" class="logo" width="262" height="120"/>

::: {style="text-align: justify"}
```{r}
#| label: packages
#| echo: false

pacman::p_load(
  dplyr, haven, sjlabelled,  psych,  purrr,  tidyr,  sjPlot,  ggplot2, 
  parameters,  table1,  car,  beeswarm, scales, ggrepel, corrplot,
  ggtext, patchwork, psych, kableExtra)
```

```{r}
#| label: database ola 1
#| echo: false 

elsoc_1 <- readRDS("../input/data/proc_data/elsoc_2016_mig.RData")
```

```{r}
#| label: database ola 2
#| echo: false 

elsoc_2 <- readRDS("../input/data/proc_data/elsoc_2017_mig.RData")
```

```{r}
#| label: database ola 3 
#| echo: false 

elsoc_3 <- readRDS("../input/data/proc_data/elsoc_2018_mig.RData")
```

```{r}
#| label: database ola 4
#| echo: false 

elsoc_4 <- readRDS("../input/data/proc_data/elsoc_2019_mig.RData")
```

```{r}
#| label: database ola 5
#| echo: false 

elsoc_5 <- readRDS("../input/data/proc_data/elsoc_2021_mig.RData")
```

```{r}
#| label: database ola 6
#| echo: false 

elsoc_6 <- readRDS("../input/data/proc_data/elsoc_2022_mig.RData")
```

# Creación de índices

Se crean ambos índice de seguridad y vinculación territorial

```{r}
#| label: seguridad subjetiva

elsoc_1 <- elsoc_1 %>%
  mutate(seguridad_sub = rowMeans(select(., seguridad_sat, seguridad_perc), na.rm = TRUE))
```

```{r}
#| label: seguridad objetiva

elsoc_1 <- elsoc_1 %>%
  mutate(seguridad_obj = rowMeans(select(., peleas_calle, asaltos, trafico_drogas), na.rm = TRUE))
```

```{r}
#| label: seguridad subjetiva

elsoc_2 <- elsoc_2 %>%
  mutate(seguridad_sub = rowMeans(select(., seguridad_sat, seguridad_perc), na.rm = TRUE))
```

```{r}
#| label: seguridad objetiva

elsoc_2 <- elsoc_2 %>%
  mutate(seguridad_obj = rowMeans(select(., peleas_calle, asaltos, trafico_drogas), na.rm = TRUE))
```

```{r}
#| label: seguridad subjetiva

elsoc_3 <- elsoc_3 %>%
  mutate(seguridad_sub = rowMeans(select(., seguridad_sat, seguridad_perc), na.rm = TRUE))
```

```{r}
#| label: seguridad objetiva

elsoc_3 <- elsoc_3 %>%
  mutate(seguridad_obj = rowMeans(select(., peleas_calle, asaltos, trafico_drogas), na.rm = TRUE))
```

```{r}
#| label: seguridad subjetiva

elsoc_4 <- elsoc_4 %>%
  mutate(seguridad_sub = rowMeans(select(., seguridad_sat, seguridad_perc), na.rm = TRUE))
```

```{r}
#| label: seguridad objetiva

elsoc_4 <- elsoc_4 %>%
  mutate(seguridad_obj = rowMeans(select(., peleas_calle, asaltos, trafico_drogas), na.rm = TRUE))
```

```{r}
#| label: data-full
#| echo: false

# Agregar la variable ola a cada base
elsoc_1 <- elsoc_1 %>% mutate(ola = 1)
elsoc_2 <- elsoc_2 %>% mutate(ola = 2)
elsoc_3 <- elsoc_3 %>% mutate(ola = 3)
elsoc_4 <- elsoc_4 %>% mutate(ola = 4)

# Unir todas las olas en una sola base
elsoc_long <- bind_rows(elsoc_1, elsoc_2, elsoc_3, elsoc_4)

```

```{r}
#| label: tendencia-plot
#| echo: false

elsoc_long %>%
  group_by(ola) %>%
  summarise(promedio = mean(simpatia_migrantes, na.rm = TRUE)) %>%
  ggplot(aes(x = ola, y = promedio, group = 1)) +
  geom_line(color = "steelblue") +
  geom_point(size = 1.5) +
  labs(title = "Tendencia en la simpatía hacia migrantes (ELSOC 2016-2019)",
       x = "Ola", y = "Promedio")

```

```{r}
#| label: tendencia-seguridad
#| echo: false

elsoc_long %>%
  group_by(ola) %>%
  summarise(promedio = mean(seguridad_sub, na.rm = TRUE)) %>%
  ggplot(aes(x = ola, y = promedio, group = 1)) +
  geom_line(color = "steelblue") +
  geom_point(size = 1.5) +
  labs(title = "Seguridad Subjetiva en el Tiempo (ELSOC 2016-2019)",
       x = "Ola", y = "Promedio")

```

```{r}
#| label: tendencia-seguridad
#| echo: false

elsoc_long %>%
  group_by(ola) %>%
  summarise(promedio = mean(seguridad_obj, na.rm = TRUE)) %>%
  ggplot(aes(x = ola, y = promedio, group = 1)) +
  geom_line(color = "steelblue") +
  geom_point(size = 1.5) +
  labs(title = "Seguridad Objetiva en el Tiempo (ELSOC 2016-2019)",
       x = "Ola", y = "Promedio")
```

```{r}
#| label: tendencia-simaptia-genero
#| echo: false

elsoc_long %>%
  group_by(ola, sexo) %>%
  summarise(promedio = mean(simpatia_migrantes, na.rm = TRUE)) %>%
  ggplot(aes(x = ola, y = promedio, color = sexo, group = sexo)) +
  geom_line() +
  geom_point() +
  labs(title = "Tendencia en simpatía la hacia migrantes según sexo",
       x = "Ola", y = "Promedio")
```

```{r}
#| label: tendencia-respuesta-tiempo
#| echo: false

# Contar frecuencias por ola y categoría
simpatia_freq <- elsoc_long %>%
  filter(!is.na(simpatia_migrantes)) %>% 
  group_by(ola, simpatia_migrantes) %>%
  summarise(freq = n(), .groups = "drop")

# Graficar frecuencias
ggplot(simpatia_freq, aes(x = ola, y = freq, color = factor(simpatia_migrantes), group = simpatia_migrantes)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(title = "Frecuencia de respuestas de simpatía hacia migrantes (ELSOC)",
       x = "Ola", 
       y = "Frecuencia",
       color = "Categoría") +
  scale_color_brewer(palette = "Set1") +
  theme_minimal()
```

```{r}
#| label: tendencia-respuesta-barras
#| echo: false

# Calcular frecuencias y % por ola
simpatia_freq <- elsoc_long %>%
  filter(!is.na(simpatia_migrantes)) %>% 
  filter(simpatia_migrantes %in% c(1, 2, 4, 5)) %>%
  group_by(ola, simpatia_migrantes) %>%
  summarise(freq = n(), .groups = "drop") %>%
  group_by(ola) %>%
  mutate(perc = round(freq / sum(freq) * 100, 1))  # % con 1 decimal

# Gráfico de barras apiladas (frecuencia en eje Y, % como etiqueta)
ggplot(simpatia_freq, aes(x = factor(ola), y = freq, fill = factor(simpatia_migrantes))) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(perc, "%")),
            position = position_stack(vjust = 0.5), color = "white", size = 3.5) +
  labs(title = "Frecuencia y porcentaje de simpatía hacia migrantes (ELSOC)",
       x = "Ola",
       y = "Frecuencia absoluta",
       fill = "Categoría") +
  scale_fill_brewer(palette = "Set1") +
  theme_minimal()
```

```{r}
#| label: tendencia-cruce-sexo
#| echo: false

# Contar frecuencias por ola, categoría de simpatía y seguridad
simpatia_sexo <- elsoc_long %>%
  filter(!is.na(simpatia_migrantes), !is.na(sexo)) %>% 
  filter(simpatia_migrantes %in% c(1, 2, 4, 5)) %>%
  group_by(ola, sexo, simpatia_migrantes) %>%
  summarise(freq = n(), .groups = "drop")

# Graficar frecuencias en líneas, separando por seguridad
ggplot(simpatia_sexo, aes(x = ola, y = freq, color = factor(simpatia_migrantes), group = simpatia_migrantes)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(title = "Frecuencia de simpatía hacia migrantes por seguridad (ELSOC)",
       x = "Ola", 
       y = "Frecuencia",
       color = "Simpatía migrantes") +
  scale_color_brewer(palette = "Set1") +
  facet_wrap(~sexo) +
  theme_minimal()
```
:::
