---
title: "Cohesión horizontal y migración: correlaciones"
author: "Tomás Urzúa, Practicante del OCS"
date: today
lang: es
fontsize: 14pt
format:
  html:
    toc: true
    toc-location: left
    toc-depth: 2
    toc-expand: 1
    toc-title: Contenidos
    number-sections: true
    number-depth: 3
    theme:
      - ../ocs.scss
    code-link: true
    title-block-banner: true 
---

<style>
.logo {
    position: absolute;
    top: 20px;
    right: 30px;
}
</style>

<img class="logo" src="ocs-new.jpeg" width="262" height="120">

<div style="text-align: justify">

```{r}
#| label: packages
#| echo: false

pacman::p_load(
  dplyr, haven, sjlabelled,  psych,  purrr,  tidyr,  sjPlot,  ggplot2, 
  parameters,  table1,  car,  beeswarm, scales, ggrepel, corrplot,
  ggtext, patchwork, psych, kableExtra)
```

```{r}
#| label: database ola 6
#| echo: false 

elsoc_6 <- readRDS("../input/data/proc_data/elsoc_2022_mig.RData")
```

```{r}
#| label: database ola 5 
#| echo: false 

elsoc_5 <- readRDS("../input/data/proc_data/elsoc_2021_mig.RData")
```

# Descriptivos de migración

```{r}
#| tbl-cap: "Variables migración ola 5"
#| tbl-cap-location: bottom
#| label: tbl-descr1
#| echo: false 

elsoc_5 %>%  select(frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes) %>% 
  haven::zap_labels() %>%
  sjmisc::descr(.,
      show = c("label","range", "mean", "sd", "NA.prc", "n", "min", "max"))%>%
      kable(., digits =2, "markdown") %>%
  kable_styling(font_size = 22)
```

```{r}
#| tbl-cap: "Variables migración ola 6"
#| tbl-cap-location: bottom
#| label: tbl-descr2
#| echo: false 

elsoc_6 %>%  select(frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes) %>% 
  haven::zap_labels() %>%
  sjmisc::descr(.,
      show = c("label","range", "mean", "sd", "NA.prc", "n", "min", "max"))%>%
      kable(., digits =2, "markdown") %>%
  kable_styling(font_size = 22)
```

# Creación de índices

Se crean ambos índice de seguridad y vinculación territorial
```{r}
#| label: seguridad subjetiva

elsoc_6 <- elsoc_6 %>%
  mutate(seguridad_sub = rowMeans(select(., seguridad_sat, seguridad_perc), na.rm = TRUE))
```

```{r}
#| label: seguridad objetiva

elsoc_6 <- elsoc_6 %>%
  mutate(seguridad_obj = rowMeans(select(., peleas_calle, asaltos, trafico_drogas), na.rm = TRUE))
```

```{r}
#| label: sentido de pertenencia
elsoc_6 <- elsoc_6 %>%
  mutate(sentido_pertenencia = rowMeans(select(., barrio_ideal, barrio_integracion, barrio_identidad, barrio_pertenencia), na.rm = TRUE))
```

```{r}
#| label: satisfacción con el barrio
elsoc_6 <- elsoc_6 %>%
  mutate(satisfaccion_barrio = rowMeans(select(., barrio_amigos, barrio_sociable, barrio_cordial, barrio_colaborador), na.rm = TRUE))
```

```{r}
#| label: comportamiento prosocial
elsoc_5 <- elsoc_5 %>%
  mutate(comportamiento_prosocial = rowMeans(select(., reunion_pub, voluntariado), na.rm = TRUE))
```

```{r}
#| label: ayuda economica
elsoc_5 <- elsoc_5 %>%
  mutate(ayuda_economica = rowMeans(select(., prestar_dinero, ayuda_trabajo), na.rm = TRUE))
```

# Correlaciones

## Correlación seguridad
 
```{r}
#| label: base índices seguridad e indicadores migración
#| echo: false 

seg_mig <- elsoc_6 %>%
  select(seguridad_obj, seguridad_sub, frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes)
```

### Correlación de Pearson
```{r}
corrsegmig <- round(cor(seg_mig, use = "pairwise.complete.obs"), 2)
```

```{r}
#| label: fig-corr1
#| fig-cap: Correlaciones seguridad y migración (Pearson)
#| echo: false

corrplot(corrsegmig,
         method = "color",       # colorea los recuadros según valor
         col = colorRampPalette(c("#f56c27", "white", "#2761f5"))(20),  # blanco a rojo
         type = "upper",         # mostrar solo la mitad superior
         order = "original",     # mantener el orden de las variables
         addCoef.col = "black",  # añadir los valores numéricos
         tl.col = "black",       # color etiquetas
         tl.srt = 45, 
         bg = "white",# rotar etiquetas
         number.cex = 0.8
)
```

La @fig-corr1 refleja las correlaciones de Pearson entre los índices de seguridad y los indicadores de migración. Se observa la mayoría de los indicadores de migración tienen una correlación bastante baja con ambos índices de seguridad. Las asociaciones más altas las tiene la seguridad subjetiva con confianza en migrantes **(.15)** y con simpatía hacia los migrantes **(.11)**.

### Correlaciones policóricas
```{r}
#| label: matriz de correlaciones policóricas seguridad
poly_cor <- polychoric(seg_mig)
```

```{r}
#| label: fig-corr2
#| fig-cap: Correlaciones seguridad y migración
#| echo: false

corrplot(poly_cor$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

En @fig-corr2 se observa una matriz de correlaciones policórica, la cual permite estimar de manera más adecuada las asociaciones entre variables ordinales en comparación de la correlación de Pearson, donde se asume que las variables son continuas. 

La mayoría de las correlaciones son bajas, destacando seguridad subjetiva con desempleo debido a inmigrantes con un **-.25**, entiéndose que mientras más acuerdo hay con que la llegada de inmigrantes al país causa desempleo, menor es la sensación de seguridad. En la misma lógica se correlacionan seguridad subjetiva con pérdida de identidad, en donde, a menor seguridad subjetiva, mayor acuerdo con que los inmigrantes hacen que Chile pierda identidad. 



```{r}
ggplot(seg_mig, aes(x = desempleo_migrantes, y = seguridad_sub)) +
  geom_jitter(width = 0.2, height = 0.2, alpha = 0.5, color = "blue") +
  labs(
    x = "Desempleo debido a inmigrantes",
    y = "Seguridad subjetiva",
    title = "Dispersión con jitter"
  ) +
  theme_minimal()
```



## Correlación vínculos territoriales

### Correlación de Pearson
```{r}
#| label: base índices territorio e indicadores migración

barrio_mig <- elsoc_6 %>%
  select(sentido_pertenencia, satisfaccion_barrio, frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes)
```

```{r}
corrbarriomig <- round(cor(barrio_mig, use = "pairwise.complete.obs"), 2)
```


```{r}
#| label: fig-corr3
#| fig-cap: Correlaciones territorio y migración
#| echo: false

corrplot(corrbarriomig,
         method = "color",       # colorea los recuadros según valor
         col = colorRampPalette(c("#2761f5", "white", "#f56c27"))(20),  # blanco a rojo
         type = "upper",         # mostrar solo la mitad superior
         order = "original",     # mantener el orden de las variables
         addCoef.col = "black",  # añadir los valores numéricos
         tl.col = "black",       # color etiquetas
         tl.srt = 45, 
         bg = "white",# rotar etiquetas
         number.cex = 0.8
)
```
En @fig-corr3 se pueden ver los cruces entre los índices de vinculación territorial con los indicadores de migración. Las correlaciones entre las mediciones de territorio y la migración son en general bajas, siendo satisfacción del barrio con confianza en migrantes la más alta (.12). 

### Correlaciones policóricas

```{r}
#| label: matriz de correlaciones policóricas territorio
poly_cor2 <- polychoric(barrio_mig)
```

```{r}
#| label: fig-corr4
#| fig-cap: Correlaciones territorio y migración
#| echo: false

corrplot(poly_cor2$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

En @fig-corr4 se observa la matriz de correlaciones policóricas que contiene los índices de vinculación territorial e indicadores de migración. La mayoría de las correlaciones son bajas, pero algunas rozando un nivel moderado. El índice de satisfacción de barrio correlaciona en un **-.28** con desempleo debido a inmigrantes, entendiéndose que a menor satisfacción con el barrio, mayor acuerdo de que los inmigrantes causan desempleo en el país.

## Correlación redes sociales 

```{r}
redes_mig <- elsoc_5 %>%
  select(comportamiento_prosocial, ayuda_economica, frecuencia_migrantes, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes)
```

### Correlación de Pearson
```{r}
corredesmig <- round(cor(redes_mig, use = "pairwise.complete.obs"), 2)
```

```{r}
#| label: fig-corr5
#| fig-cap: Correlaciones redes sociales y migración (Pearson)
#| echo: false

corrplot(corredesmig,
         method = "color",       # colorea los recuadros según valor
         col = colorRampPalette(c("#f56c27", "white", "#2761f5"))(20),  # blanco a rojo
         type = "upper",         # mostrar solo la mitad superior
         order = "original",     # mantener el orden de las variables
         addCoef.col = "black",  # añadir los valores numéricos
         tl.col = "black",       # color etiquetas
         tl.srt = 45, 
         bg = "white",# rotar etiquetas
         number.cex = 0.8
)
```

### Correlaciones policóricas

```{r}
#| label: matriz de correlaciones policóricas redes sociales
poly_cor3 <- polychoric(redes_mig)
```

```{r}
#| label: fig-corr6
#| fig-cap: Correlaciones territorio y migración
#| echo: false

corrplot(poly_cor3$rho, method = "color",
         type = "upper",
         addCoef.col = "black", # mostrar los coeficientes
         tl.col = "black", tl.srt = 45, # etiquetas
         number.cex = 0.7)
```

En @fig-corr6 se presenta las correlaciones policóricas entre los índices de redes sociales (comportamiento prosocial y ayuda económica) y los indicadores de migración. En la matriz se pueden observar algunas correlaciones moderadas, tal como la asociación entre comporamiento prosocial e igualdad con inmigrantes **(-.40)**. Esto quiere decir que, a mayor comportamiento prosocial, hay un mayor desacuerdo con que los inmigrantes tengan un acceso igualitario a la salud. En la misma lógica se presenta la asociación entre el índice de ayuda económica con pérdida de identidad **(-.31)**, queriendo decir que a menor ayuda económica, hay un mayor acuerdo respecto a la idea de los inmigrantes le restan identidad al país. 

# Moderación de correlaciones (nivel educacional y género)
