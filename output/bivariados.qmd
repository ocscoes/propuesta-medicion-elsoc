---
title: "Cohesión horizontal y migración: correlaciones"
author: "Tomás Urzúa, Practicante del OCS"
date: today
lang: en
fontsize: 14pt
format:
  html:
    toc: true
    toc-location: left
    toc-depth: 2
    toc-expand: 1
    toc-title: Contenidos
    number-sections: true
    number-depth: 3
    theme:
      - ../ocs.scss
    code-link: true
    title-block-banner: true 
---

<style>
.logo {
    position: absolute;
    top: 20px;
    right: 30px;
}
</style>

<img class="logo" src="ocs-new.jpeg" width="262" height="120">

<div style="text-align: justify">

```{r}
#| label: packages
#| echo: false

pacman::p_load(
  dplyr, haven, sjlabelled,  psych,  purrr,  tidyr,  sjPlot,  ggplot2, 
  parameters,  table1,  car,  beeswarm, scales, ggrepel, corrplot,
  ggtext, patchwork, psych, kableExtra)
```

```{r}
#| label: database
#| echo: false 

elsoc <- readRDS("../input/data/proc_data/elsoc_2022_mig.RData")
```

# Descriptivos de migración

```{r}
#| tbl-cap: "Variables migracion"
#| tbl-cap-location: bottom
#| label: tbl-descr1
#| echo: false 

elsoc %>%  select(contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes) %>% 
  haven::zap_labels() %>%
  sjmisc::descr(.,
      show = c("label","range", "mean", "sd", "NA.prc", "n", "min", "max"))%>%
      kable(., digits =2, "markdown") %>%
  kable_styling(font_size = 22)
```

```{r}
# include: false 

plot_stackfrq(elsoc[, c("peleas_calle","asaltos","trafico_drogas")]) +
  theme(legend.position = "bottom")

```

# Creación de índices

Se crean ambos índice de seguridad y vinculación territorial
```{r}
#| label: seguridad subjetiva

elsoc <- elsoc %>%
  mutate(seguridad_sub = rowMeans(select(., seguridad_sat, seguridad_perc), na.rm = TRUE))
```

```{r}
#| label: seguridad objetiva

elsoc <- elsoc %>%
  mutate(seguridad_obj = rowMeans(select(., peleas_calle, asaltos, trafico_drogas), na.rm = TRUE))
```

```{r}
#| label: sentido de pertenencia
elsoc <- elsoc %>%
  mutate(sentido_pertenencia = rowMeans(select(., barrio_ideal, barrio_integracion, barrio_identidad, barrio_pertenencia), na.rm = TRUE))
```

```{r}
#| label: satisfacción con el barrio
elsoc <- elsoc %>%
  mutate(satisfaccion_barrio = rowMeans(select(., barrio_amigos, barrio_sociable, barrio_cordial, barrio_colaborador), na.rm = TRUE))
```

# Correlaciones

## Correlación seguridad

```{r}
#| label: base índices seguridad e indicadores migración
#| echo: false 

seg_mig <- elsoc %>%
  select(seguridad_obj, seguridad_sub, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes)
```

```{r}
corrsegmig <- round(cor(seg_mig, use = "pairwise.complete.obs"), 2)
```

```{r}
#| label: fig-corr1
#| fig-cap: Correlaciones seguridad y migración
#| echo: false

corrplot(corrsegmig,
         method = "color",       # colorea los recuadros según valor
         col = colorRampPalette(c("#2761f5", "white", "#f56c27"))(20),  # blanco a rojo
         type = "upper",         # mostrar solo la mitad superior
         order = "original",     # mantener el orden de las variables
         addCoef.col = "black",  # añadir los valores numéricos
         tl.col = "black",       # color etiquetas
         tl.srt = 45, 
         bg = "white",# rotar etiquetas
         number.cex = 0.8
)
```
Como se puede apreciar en @fig-corr1, la mayoría de los indicadores de migración tienen una correlación bastante baja con ambos índices de seguridad. Los más altos los tiene la seguridad subjetiva correlacionada con confianza en migrantes **(.15)** y simpatía hacia los migrantes **(.11)**.


```{r}
ggplot(seg_mig, aes(x = confianza_migrantes, y = seguridad_sub)) +
  geom_jitter(width = 0.2, height = 0.2, alpha = 0.5, color = "blue") +
  labs(
    x = "Confianza en migrantes",
    y = "Seguridad subjetiva",
    title = "Dispersión con jitter"
  ) +
  theme_minimal()
```

## Correlación vínculos territoriales


```{r}
#| label: base índices territorio e indicadores migración

barrio_mig <- elsoc %>%
  select(sentido_pertenencia, satisfaccion_barrio, contacto_migrantes, simpatia_migrantes,
         perdida_identidad, desempleo_migrantes, confianza_migrantes, 
         fomentar_migracion, igualdad_migrantes)
```

```{r}
corrbarriomig <- round(cor(barrio_mig, use = "pairwise.complete.obs"), 2)
```


```{r}
#| label: fig-corr2
#| fig-cap: Correlaciones barrio y migración
#| echo: false

corrplot(corrbarriomig,
         method = "color",       # colorea los recuadros según valor
         col = colorRampPalette(c("#2761f5", "white", "#f56c27"))(20),  # blanco a rojo
         type = "upper",         # mostrar solo la mitad superior
         order = "original",     # mantener el orden de las variables
         addCoef.col = "black",  # añadir los valores numéricos
         tl.col = "black",       # color etiquetas
         tl.srt = 45, 
         bg = "white",# rotar etiquetas
         number.cex = 0.8
)
```
En @fig-corr2 se pueden ver los cruces entre los índices de vinculación territorial con los indicadores de migración. Las correlaciones entre las mediciones de territorio y la migración son en general bajas, siendo satisfacción del barrio con confianza en migrantes la más alta (.12). 

## Correlación redes sociales 


