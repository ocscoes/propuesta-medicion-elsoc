---
author: "Equipo EDUMER"
editor_options: 
  chunk_output_type: console
---

```{r}
#| echo: false
#| message: false
#| warning: false

library(knitr)
knitr::opts_chunk$set(echo = FALSE, 
                      include = TRUE, 
                      warning = FALSE, 
                      message = FALSE)

table_format <- if(is_html_output()) {
  "html"
} else if(is_latex_output()) {
  "latex"
}
table_format2 <- if(is_html_output()) {
  T
} else if(is_latex_output()) {
  F
}

options(kableExtra.html.bsTable = T)
options(knitr.kable.NA = "")

if (! require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse,
               sjmisc, 
               here,
               sjlabelled,
               srvyr,
               ggdist,
               purrr,
               rlang)


options(scipen=999)
rm(list = ls())

load(here("input/data/proc_data/db_long.RData"))

db_pond <- db %>% 
  as_survey_design(ids = segmento, 
                   strata = estrato, 
                   weights = ponderador_long_total,
                   nest = T)
```

```{r}
#| label: plots


# Selección de variables: (1) desempleo por migrantes, (2)pérdida de identidad
# (3)simpatía hacia migrantes, (4)acceso a salud igualitaro y (5) contacto positivo

# plot function
make_plot <- function(design, predictor, outcome, ylab, legend_title) {
  pred_sym <- ensym(predictor)
  out_sym  <- ensym(outcome)
  
  design %>% 
    select(wave, !!pred_sym, !!out_sym) %>% 
    tidyr::drop_na() %>% 
    group_by(wave, !!pred_sym) %>%
    summarise(
      value = survey_mean(!!out_sym, vartype = "ci", na.rm = TRUE),
      .groups = "drop"
    ) %>% 
    ggplot(aes(x = wave, y = value, group = !!pred_sym)) +
    geom_point(aes(color = !!pred_sym), size = 4.5) +
    geom_line(aes(color = !!pred_sym), linewidth = 1) +
    # geom_errorbar(aes(ymin = value_low, ymax = value_upp, color = !!pred_sym), width = 0.1) +
    scale_y_continuous(n.breaks = 7) +
    scale_color_manual(
      name = legend_title,
      values = c("#F9913D","#7ABA21", "#2b2f3c")
      ) +
    labs(
      x = "Ola",
      y = ylab,
      caption = "Fuente: elaboración propia con datos agrupados de ELSOC 2016-2023"
    ) +
    theme_ggdist() +
theme(
    plot.title   = element_text(size = 24, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 16, face = "italic", hjust = 0.5),
    plot.caption = element_text(size = 14),
    
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    axis.text.x  = element_text(size = 16),
    axis.text.y  = element_text(size = 16),
    
    legend.title = element_text(size = 16, face = "bold"),
    legend.text  = element_text(size = 14),
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background     = element_rect(fill = "white", color = NA),
    legend.margin         = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin     = margin(t = 6, r = 6, b = 6, l = 6),
    
    legend.position  = "top",
    legend.direction = "horizontal"
  ) +
  guides(
    color = guide_legend(
      title.position = "top",
      label.position = "bottom",
      nrow = 1, byrow = TRUE,
      keywidth = unit(14, "pt"),
      keyheight = unit(10, "pt")
    )
  )
}

# combinations

outcomes <- c(
  seguridad_sub           = "Seguridad percibida",
  seguridad_obj           = "Seguridad objetiva",
  confianza_inter         = "Confianza interpersonal",
  comportamiento_prosocial= "Comportamiento prosocial",
  ayuda_economica         = "Ayuda económica",
  sentido_pertenencia     = "Sentido pertenencia barrio",
  satisfaccion_barrio     = "Satisfacción barrio"
)

predictors <- list(
  desempleo_migrantes = "Desempleo percibido por \nmigrantes",
  perdida_identidad   = "Pérdida identidad por \nmigrantes",
  simpatia_migrantes = "Simpatía hacia migrantes",
  igualdad_migrantes = "Acceso a salud igualitario \npara migrantes",
  contacto_migrantes = "Contacto positivo con \nmigrantes",
  restriccion_migrantes = "Restricción a ingreso de \nmigrantes"
)

comb <- tidyr::crossing(pred = names(predictors), out = names(outcomes))

# make plots

plots_tbl <- comb %>%
  mutate(
    plot = pmap(
      list(pred, out),
      ~ make_plot(
        design       = db_pond,
        predictor    = ..1,
        outcome      = ..2,
        ylab         = outcomes[..2],
        legend_title = predictors[[..1]]
      )
    ),
    plot_id = paste0("plot_", out, "__by__", pred)
  )
```


# Cohesión social y migración {.xlarge data-background-color="#444a5e"}

# Seguridad y migración {.xlarge data-background-color="#444a5e"}

---

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig.width: 12
#| fig.height: 8
#| out-width: "100%"
#| fig-align: "center"
db_pond %>% 
  select(wave, seguridad_sub, restriccion_migrantes) %>%
  mutate(seguridad_sub = case_when(
    seguridad_sub <= 2.5 ~ "Baja",
    seguridad_sub >= 3   ~ "Alta"
  ),
  restriccion_migrantes = forcats::fct_relabel(
    restriccion_migrantes, ~ str_wrap(.x, 20))) %>% 
  tidyr::drop_na() %>% 
  filter(wave == last(wave)) %>% 
  group_by(restriccion_migrantes, seguridad_sub) %>%
  survey_count(vartype = NULL) %>% 
  group_by(seguridad_sub) %>% 
  mutate(
    prop  = 100 * n / sum(n),                 # porcentaje dentro de cada wave
    label = scales::percent(prop/100, accuracy = 0.1)
  ) %>% 
  ggplot(aes(x = restriccion_migrantes, y = prop, fill = seguridad_sub)) +
  geom_col(position = position_dodge(width = 0.6), width = 0.6) +
  geom_text(
    aes(label = label, color = seguridad_sub),   # color igual a la serie
    position = position_dodge(width = 0.6),
    vjust = -0.4, size = 4, fontface = "bold", show.legend = FALSE
  ) +
  scale_fill_manual(
    name = "Percepción seguridad",
    values = c("Baja" = "#2b2f3c", "Alta" = "#F9913D")
  ) +
  scale_color_manual(                                 # mismo esquema para el texto
    values = c("Baja" = "#2b2f3c", "Alta" = "#F9913D")
  ) +
  scale_y_continuous(
    labels = function(p){paste0(p, "%")},
    limits = c(0,100),
    breaks = seq(0,100, by = 10),
    expand = expansion(mult = c(0.02, 0.08)) # deja aire arriba para las etiquetas
  )  + 
    labs(
      title = "Percepción de seguridad y restricción de acceso a migrantes",
      x = "Restricción de acceso a migrantes",
      y = NULL,
      caption = "Fuente: elaboración propia con datos de ELSOC 2023"
    ) +
  theme_ggdist() +
  theme(
    plot.title   = element_text(size = 24, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 16, face = "italic", hjust = 0.5),
    plot.caption = element_text(size = 14),
    
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    axis.text.x  = element_text(size = 16),
    axis.text.y  = element_text(size = 16),
    
    legend.title = element_text(size = 16, face = "bold"),
    legend.text  = element_text(size = 14),
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background     = element_rect(fill = "white", color = NA),
    legend.margin         = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin     = margin(t = 6, r = 6, b = 6, l = 6),
    
    legend.position  = "top",
    legend.direction = "horizontal"
  ) +
  guides(
    color = guide_legend(
      title.position = "top",
      label.position = "right",
      nrow = 1, byrow = TRUE,
      keywidth = unit(14, "pt"),
      keyheight = unit(10, "pt")
    )
  )
```


---

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig.width: 12
#| fig.height: 8
#| out-width: "100%"
#| fig-align: "center"

sel <- plots_tbl %>%
  filter(out  %in% c("seguridad_sub","seguridad_obj")) 

sel$plot[[12]] + 
  labs(title = "Seguridad percibida y simpatía hacia migrantes") 
```


---

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig.width: 12
#| fig.height: 8
#| out-width: "100%"
#| fig-align: "center"

sel$plot[[10]] + 
  labs(title = "Seguridad percibida y restricción de ingreso a migrantes")
```



# Vinculos territoriales y migración {.xlarge data-background-color="#444a5e"}


---

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig.width: 12
#| fig.height: 8
#| out-width: "100%"
#| fig-align: "center"
db_pond %>% 
  select(wave, sentido_pertenencia, perdida_identidad) %>%
  mutate(sentido_pertenencia = case_when(
    sentido_pertenencia <= 2.5 ~ "Baja",
    sentido_pertenencia >= 3   ~ "Alta"
  ),
  perdida_identidad = forcats::fct_relabel(
    perdida_identidad, ~ str_wrap(.x, 20))) %>% 
  tidyr::drop_na() %>% 
  filter(wave == last(wave)) %>% 
  group_by(perdida_identidad, sentido_pertenencia) %>%
  survey_count(vartype = NULL) %>% 
  group_by(sentido_pertenencia) %>% 
  mutate(
    prop  = 100 * n / sum(n),                 # porcentaje dentro de cada wave
    label = scales::percent(prop/100, accuracy = 0.1)
  ) %>% 
  ggplot(aes(x = perdida_identidad, y = prop, fill = sentido_pertenencia)) +
  geom_col(position = position_dodge(width = 0.6), width = 0.6) +
  geom_text(
    aes(label = label, color = sentido_pertenencia),   # color igual a la serie
    position = position_dodge(width = 0.6),
    vjust = -0.4, size = 4, fontface = "bold", show.legend = FALSE
  ) +
  scale_fill_manual(
    name = "Sentido pertenencia barrial",
    values = c("Baja" = "#2b2f3c", "Alta" = "#F9913D")
  ) +
  scale_color_manual(                                 # mismo esquema para el texto
    values = c("Baja" = "#2b2f3c", "Alta" = "#F9913D")
  ) +
  scale_y_continuous(
    labels = function(p){paste0(p, "%")},
    limits = c(0,100),
    breaks = seq(0,100, by = 10),
    expand = expansion(mult = c(0.02, 0.08)) # deja aire arriba para las etiquetas
  )  + 
  labs(
    title = "Sentido pertenencia barrial y pérdida de identidad nacional",
    x = "Pérdida de identidad nacional por migrantes",
    y = NULL,
    caption = "Fuente: elaboración propia con datos de ELSOC 2023"
  ) +
  theme_ggdist() +
  theme(
    plot.title   = element_text(size = 24, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 16, face = "italic", hjust = 0.5),
    plot.caption = element_text(size = 14),
    
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    axis.text.x  = element_text(size = 16),
    axis.text.y  = element_text(size = 16),
    
    legend.title = element_text(size = 16, face = "bold"),
    legend.text  = element_text(size = 14),
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background     = element_rect(fill = "white", color = NA),
    legend.margin         = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin     = margin(t = 6, r = 6, b = 6, l = 6),
    
    legend.position  = "top",
    legend.direction = "horizontal"
  ) +
  guides(
    color = guide_legend(
      title.position = "top",
      label.position = "bottom",
      nrow = 1, byrow = TRUE,
      keywidth = unit(14, "pt"),
      keyheight = unit(10, "pt")
    )
  )

```



---

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig.width: 12
#| fig.height: 8
#| out-width: "100%"
#| fig-align: "center"
sel <- plots_tbl %>%
  filter(out  %in% c("sentido_pertenencia", "satisfaccion_barrio")) 

sel$plot[[1]] + 
  labs(title = "Satisfacción barrial y contacto positivo con migrantes")
```


---

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig.width: 12
#| fig.height: 8
#| out-width: "100%"
#| fig-align: "center"

sel$plot[[11]] + 
  labs(title = "Satisfacción barrial y simpatía hacia migrantes")
```


# Redes y migración {.xlarge data-background-color="#444a5e"}

---


```{r}
#| echo: false
#| warning: false
#| message: false
#| fig.width: 12
#| fig.height: 8
#| out-width: "100%"
#| fig-align: "center"

db_pond %>% 
  select(wave, comportamiento_prosocial, restriccion_migrantes) %>%
  mutate(comportamiento_prosocial = case_when(
    comportamiento_prosocial <= 2.5 ~ "Bajo",
    comportamiento_prosocial >= 3   ~ "Alto"
  ),
  restriccion_migrantes = forcats::fct_relabel(
    restriccion_migrantes, ~ str_wrap(.x, 20))) %>% 
  tidyr::drop_na() %>% 
  filter(wave == last(wave) & comportamiento_prosocial == "Bajo") %>% 
  group_by(restriccion_migrantes, comportamiento_prosocial) %>%
  survey_count(vartype = NULL) %>% 
  group_by(comportamiento_prosocial) %>% 
  mutate(
    prop  = 100 * n / sum(n),                 # porcentaje dentro de cada wave
    label = scales::percent(prop/100, accuracy = 0.1)
  ) %>% 
  ungroup() %>% 
  ggplot(aes(x = restriccion_migrantes, y = prop)) +
  geom_col(width = 0.6, fill = "#F9913D")  +
  geom_text(
    aes(label = label,),   # color igual a la serie
    vjust = -0.4, size = 4, fontface = "bold", show.legend = FALSE
  ) +
  scale_y_continuous(
    labels = function(p){paste0(p, "%")},
    limits = c(0,100),
    breaks = seq(0,100, by = 20),
    expand = expansion(mult = c(0.02, 0.08)) # deja aire arriba para las etiquetas
  )  + 
  labs(
    title = "Comportamiento prosocial bajo y restricción de acceso a migrantes",
    x = "Restricción de acceso a migrantes",
    y = NULL,
    caption = "Fuente: elaboración propia con datos de ELSOC 2022"
  ) +
  theme_ggdist() +
  theme(
    plot.title   = element_text(size = 24, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 16, face = "italic", hjust = 0.5),
    plot.caption = element_text(size = 14),
    
    axis.title.x = element_text(size = 18),
    axis.title.y = element_text(size = 18),
    axis.text.x  = element_text(size = 16),
    axis.text.y  = element_text(size = 16),
    
    legend.title = element_text(size = 16, face = "bold"),
    legend.text  = element_text(size = 14),
    legend.box.background = element_rect(color = "grey20", fill = "white", linewidth = 0.5),
    legend.background     = element_rect(fill = "white", color = NA),
    legend.margin         = margin(t = 6, r = 8, b = 6, l = 8),
    legend.box.margin     = margin(t = 6, r = 6, b = 6, l = 6),
    
    legend.position  = "top",
    legend.direction = "horizontal"
  ) +
  guides(
    color = guide_legend(
      title.position = "top",
      label.position = "bottom",
      nrow = 1, byrow = TRUE,
      keywidth = unit(14, "pt"),
      keyheight = unit(10, "pt")
    )
  )

```



---

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig.width: 12
#| fig.height: 8
#| out-width: "100%"
#| fig-align: "center"
sel <- plots_tbl %>%
  filter(out  %in% c("confianza_inter","comportamiento_prosocial", "ayuda_economica")) %>% 
  filter(pred != "igualdad_migrantes" & out != "ayuda_economica") 

sel$plot[[1]] + 
  labs(title = "Comportamiento prosocial y contacto positivo con migrantes") 
```


---

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig.width: 12
#| fig.height: 8
#| out-width: "100%"
#| fig-align: "center"

sel$plot[[5]] + 
  labs(title = "Comportamiento prosocial y pérdida de identidad por migrantes") 
```
